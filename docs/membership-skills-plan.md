# アカウント権限とスタッフ技能の再設計プラン

## 0. 背景・目的
- 現状はアカウントに単一ロール（`systemRoot` / `systemAdmin` / `clinicAdmin` / `clinicStaff`）を持たせ、施設ごとの役割差は `membershipIds` の羅列で管理しているが、施設ごとの権限区別ができない。
- クリニックの資格・検査・診療項目は施設単位で保持されており、将来的にスタッフ（医療者）データを SkilBank から持ち込む際、どのスタッフがどの技能を担うかが分離できない。
- 目的は「施設 × スタッフ × 権限・技能」の状態を正しく表現し、フロント／API 双方が一貫した認可・表示を行えるようにすること。

---

## 1. 現状整理
### 1.1 アカウント／メンバーシップ
- `accounts` … `account:id:<uuid>` に `role`, `membershipIds` などを保存。
- `membership:{uuid}` … `clinicId`, `roles`, `status` を持つが、アクセストークンでは `membershipIds` の配列のみ返却。
- フロントでは `membershipIds` の値を直接利用しておらず、施設ごとの権限判定は実質「アカウント全体のロール」のみで実装されている。
- アカウント詳細画面には `membershipIds` の生値（UUID）が表示されてしまう。

### 1.2 施設の技能データ
- `clinic` レコードに `qualifications` / `services` / `tests` / `modes` といった配列を直接持ち、スタッフ単位の情報は存在しない。
- スタッフ招待 (`auth/inviteStaff`) で作成されるメンバーシップは、どの技能を担当するかの情報を保持していない。

---

## 2. 目標
1. **施設ごとの権限制御**  
   - メンバーシップ単位でロール（例: `clinicAdmin`, `clinicStaff`, 将来的に `clinicViewer` 等）を保持し、アクセストークンに「ログインユーザーが所属する施設ごとのロール」を含める。
   - フロント側は「現在閲覧中の施設 ID」に応じて権限を判断し、機能の有効・無効を切り替える。

2. **スタッフ技能の正規化**  
   - スタッフ（SkilBank アカウント）に紐づく技能（資格／検査／診療）を保持し、施設はそれらの集合として公開情報を構築する。
   - 施設側に保存する技能一覧はキャッシュ（集計結果）と位置付け、データソースはスタッフ側に一本化する。

---

## 3. 提案アーキテクチャ
### 3.3 スタッフプロフィール項目と公開範囲
> **入力フェーズの方針**: 初期段階の SkillBank では Medical Orchestra の検索に必要な項目（資格・診療・検査など）を中心に入力してもらい、履歴書生成に必要な項目はフィールドだけ用意しておき段階的に公開する。入力画面ではステップを分け、必須項目が少なく感じられるようにする。

- **個人基本情報**（非公開 / 本人および委任された施設長のみ閲覧・編集）
  - 氏名（漢字・かな・ローマ字）、連絡先、住所（オプション）、生年月日、プロフィール写真
  - 個人保存スペース（医師免許証 PDF、専門医証 PDF、医籍番号、学会番号など）
  - 趣味・自己紹介文（公開設定あり）
- **所属・勤務情報**（施設長は閲覧可、本人・施設長が編集）
  - 所属施設 ID、勤務開始日／終了予定日、役職（院長・副院長・非常勤 等）、勤務形態（常勤／非常勤／スポット）
  - 施設ごとの担当スキル（診療／検査／資格など）と比率（例: 外来70%・手術30%）
- **資格・技能**（原則公開。検索対象項目）
  - 医療資格（専門医・認定医）、一般資格（TOEIC など）、ITスキル、教育実績、研究実績（論文／学会発表／講演）、特許
  - 医療経験（診療科別・検査別の経験年数や件数）
- **ポートフォリオ生成用データ**
  - 自由記述の成果ハイライト、受賞歴、外部リンク（ResearchMap, ORCID 等）
  - これらの項目をテンプレート化し、PDF／Web ビューのポートフォリオ・履歴書を自動生成

- **個人基本情報**（非公開 / 本人および委任された施設長のみ閲覧・編集）
  - 氏名（漢字・かな・ローマ字）、連絡先、住所（オプション）、生年月日、プロフィール写真
  - 個人保存スペース（医師免許証 PDF、専門医証 PDF、医籍番号、学会番号など）
  - 趣味・自己紹介文（公開設定あり）
- **所属・勤務情報**（施設長は閲覧可、本人・施設長が編集）
  - 所属施設 ID、勤務開始日／終了予定日、役職（院長・副院長・非常勤 等）、勤務形態（常勤／非常勤／スポット）
  - 施設ごとの担当スキル（診療／検査／資格など）と比率（例: 外来70%・手術30%）
- **資格・技能**（原則公開。検索対象項目）
  - 医療資格（専門医・認定医）、一般資格（TOEIC など）、ITスキル、教育実績、研究実績（論文／学会発表／講演）、特許
  - 医療経験（診療科別・検査別の経験年数や件数）
- **ポートフォリオ生成用データ**
  - 自由記述の成果ハイライト、受賞歴、外部リンク（ResearchMap, ORCID 等）
  - これらの項目をテンプレート化し、PDF／Web ビューのポートフォリオ・履歴書を自動生成

公開ポリシー例:
| 項目カテゴリ | 既定公開範囲 | 編集権限 | 備考 |
|---------------|----------------|-----------|------|
| 個人基本情報 | 非公開 | 本人 | 医師会事務局などが閲覧する場合は委任設定を検討 |
| 所属・勤務情報 | 施設長と本人のみに表示（施設ごと） | 本人 / 施設長 | 医療紹介状などで活用予定 |
| 資格・技能 | 公開（Medical Orchestra 検索対象） | 本人 / 施設長 | 公開レベルを「公開／限定公開／非公開」で切替可 |
| ポートフォリオ生成データ | 公開範囲は項目ごとに設定 | 本人 | 履歴書出力は本人が承認した内容のみ |

公開設定は項目単位（例: 教育実績は公開、特許は限定公開）で制御し、Medical Orchestra での検索対象は「公開」扱いのデータに限定する。

### 3.4 施設側の技能集約と表示
- 施設 API はスタッフベースのデータを集計し、以下の情報を返す：
  ```json
  {
    "clinicId": "clinic:uuid",
    "skills": [{
      "id": "qual:uuid",
      "name": "日本内科学会認定内科医",
      "category": "qualification",
      "staffCount": 2,
      "staff": [
        { "accountId": "account:x", "displayName": "X先生", "membershipId": "membership:a" },
        { "accountId": "account:y", "displayName": "Y先生", "membershipId": "membership:b" }
      ]
    }],
    "staff": [{
      "accountId": "account:x",
      "displayName": "X先生",
      "roles": ["clinicAdmin"],
      "skills": { "qualifications": [...], "services": [...], "tests": [...] }
    }]
  }
  ```
- スキル表示では `staffCount` を基に「〇〇（担当医 2 名）」のように集計表示し、詳細を開くと担当者ごとのプロフィールに遷移できる。
- 既存の `clinic.qualifications` など施設直下のフィールドはキャッシュとして維持しつつ、集計ジョブ（Durable Object / Cron Trigger）またはオンデマンド更新で同期する。
- 集計処理の流れ：
  1. スタッフの技能が更新されたらイベントを発行（Queue / Durable Object）。
  2. 該当施設の `skillSummary` を再計算して KV に保存。
  3. フロントは `skillSummary` API を参照して最新情報を表示。

施設長による代行入力:
- 施設管理画面では、所属スタッフ一覧から「スタッフ情報を編集（委任）」モードへ切り替え可能。
- 代行で編集された項目は、本人が後で確認・承認できるよう監査ログや差分通知を付与。
- 個人保存スペース（免許証 PDF 等）は本人アップロードのみとし、施設長が委任された場合は「提出済み書類の確認」のみ行えるフローを整備。

### 3.1 メンバーシップモデル
- `membership:{uuid}` を以下の構造に拡張:
  ```json
  {
    "id": "membership:af3d...",
    "clinicId": "clinic:uuid",
    "accountId": "account:uuid",
    "roles": ["clinicAdmin", "clinicStaff"],
    "primaryRole": "clinicAdmin",
    "status": "active",
    "grantedSkills": ["service:uuid", "test:uuid"], // 任意
    "createdAt": "...",
    "updatedAt": "...",
    "meta": { "grantedBy": "account:..." }
  }
  ```
- `accounts` は `membershipIds` に加えて `memberships` 配列（メタデータを含む）を保持。既存 API 互換のため `membershipIds` は当面残す。
- トークンペイロードには `memberships` を追加（例: `{ memberships: [{ id, clinicId, roles }] }`）。サイズ最適化のため、必要最小限に絞る。
- 認証ヘルパー (`NcdAuth`) に以下のメソッドを追加:
  - `getMemberships()` / `getMembershipForClinic(clinicId)` / `hasClinicRole(clinicId, role)`
  - `getRoleLabel(role)` は既に追加済み。`ROLE_INHERITANCE` を用いて施設ロールの権限継承を解決する。
- Workers 側 API 変更案:
  - `auth/login` / `auth/refresh` … レスポンスに `memberships` 配列を追加。
  - `auth/inviteStaff` / `auth/registerFacilityAdmin` … メンバーシップ作成時に `roles` を保存し、招待メールにも施設名・ロールを記載。
  - `auth/listMemberships`（新規） … 管理者向けに施設別メンバー一覧を返す API を追加。

### 3.2 施設技能とスタッフ技能の結び付き
- SkilBank 側で保持するスタッフプロフィール（案）:
  ```json
  {
    "accountId": "account:uuid",
    "skills": {
      "qualifications": ["qual:uuid", ...],
      "services": ["service:uuid", ...],
      "tests": ["test:uuid", ...]
    },
    "visibility": { ... },
    "experience": [...],
    "memberships": [{ "clinicId": "...", "since": "...", "roles": [...] }]
  }
  ```
- 施設の公開データは、メンバーシップに紐づくスタッフ技能を集計し、「施設が提供できる技能」「担当スタッフ一覧」を表示する。
- 既存 `clinic.qualifications` 等は以下の段階的移行を想定:
  1. スタッフ技能の集計結果を保存する `clinic.skillSummary` を追加し、フロントで優先表示。
  2. 過渡期は `clinic.qualifications` を維持しつつ、集計結果と比較して差分確認。
  3. スタッフ情報が十分整った段階で `clinic.qualifications` を読取専用に変更し、UIからは編集不可にする。
- API 追加・変更案:
  - `clinic/skillSummary`（新規 GET）: 施設 ID を渡すと「スタッフ → 技能」の対応リストを返す。
  - `staff/updateSkills`（新規 POST）: スタッフ自身または管理者が技能を登録・更新。
  - `staff/listByClinic`（新規 GET）: 施設に所属するスタッフとその権限・技能を取得。
  - 既存の `updateClinic` は基本情報のみに縮小し、技能更新はスタッフ側エンドポイントで行う。

---

## 4. マイグレーション計画（概要）
1. **スキーマ拡張**
   - `membership` レコードに `roles`, `primaryRole` 等のフィールドを追加し、既存データへデフォルト値を投入。
   - `accounts` に `memberships`（詳細配列）を追加。初期データは `membershipIds` から派生。

2. **API & フロント更新**
   - 認証 API のレスポンス形式を更新し、`NcdAuth` へ新ヘルパーを追加。
   - 施設ホームなど編集系 UI で `hasClinicRole(clinicId, 'clinicAdmin')` を利用するよう改修。
   - アカウント詳細画面に所属施設名（計画中）を表示。現在はラベル変換のみ → 将来的には API から施設名を取得。

3. **スタッフ技能データの導入**
   - SkilBank 側データモデル・API を実装し、ダミーデータで連携テスト。
   - 施設側に `skillSummary` API を追加し、既存 UI と切り替え比較を行う。
   - `clinic.qualifications` などの既存フィールドは当面維持し、移行期間中はキャッシュを自動更新するバッチ（またはオンデマンド同期）を用意。

4. **完全移行**
   - フロント UI をスタッフベースの表示に切り替え、旧フィールドを非表示化。
   - データ整合性を確認後、旧フィールドを削除または読み取り専用に変更。

---

## 5. オープン課題
- `membership` ↔ `clinic` の紐付けから施設名を取得する API をどこで提供するか（`clinicDetail` でまとめて返すか、`auth/login` でメンバー情報に付与するか）。
- スタッフ技能の編集権限: スタッフ本人が修正できる範囲と、施設管理者が上書きできる範囲をどう切り分けるか。
- スキル項目（資格・検査・診療）をスタッフ単位で扱う際、スコープや公開/非公開設定（SkilBank 既定の visibility）との整合性。
- 既存 KV データ量に対する影響。特に `membership` を多用する場合のキー数・サイズの見積り。

---

## 6. 次のステップ（短期 ToDo）
1. Workers 側で `membership` 構造を拡張するテクニカル Spike（ダミーデータでトークンに `memberships` を含める）。
2. `NcdAuth` に施設ロール判定用ヘルパーを追加し、施設ホームの編集ガードを移行。
3. スタッフ技能データの JSON スキーマ（SkilBank 側）を定義し、ダミー API を用意。
4. 施設技能とスタッフ技能の集計ロジック（計算フロー／キャッシュ）をドキュメント化。
5. スタッフ招待フローの UI 文言・メールテンプレートを「施設名＋ロール」を含む形式へ更新。

---

このドキュメントは初期案であり、合意形成後 `docs/roadmap.md` や詳細仕様書に反映する。

## 6. Medical Orchestra チャット優先事項
- スタッフプロフィール機能より先に、複数アカウントが参加するグループチャットを実装。
- 自動参加グループ: 所属施設ごとに標準チャットルームを作成し、メンバーはメンバーシップ更新と同期して参加。
- 任意グループ: 施設外メンバーを含むグループを作成できる UI/API を用意（招待制／申請制を選択可能にする案を検討）。
- スレッド機能: 各グループ内で議題／症例などテーマ別にスレッドを作成し、ディスカッションを分岐。
- 公開スレッド: 誰でも参加できるオープンスレッドを提供し、診療分野などのカテゴリを付与して整理。
- 基盤: Durable Objects / WebSocket / Queue を組み合わせたリアルタイムメッセージング基盤を検討（既存 Roadmap の Orchestra 設計と整合）。
- 医師会の連絡網として活用できるよう、以下のブロードキャスト機能を想定:
  - 医師会事務局 → 全メンバーへ一斉通知（公告、緊急連絡）。
  - 各委員会グループ（委員会所属メンバー自動登録）への一斉連絡。
  - 個人宛のダイレクトメッセージ。既読確認・通知設定をサポート。
- 添付機能: メッセージには最低限、ファイル添付（PDF 等）・画像添付（症例写真 等）を許可する。添付ファイルの保存先・アクセス権・サイズ上限を設計に含める。
- 将来拡張として Web 会議（ビデオ会議）を統合予定。チャットから会議を開始し、参加者管理・会議リンク共有・録画保存などを段階的に追加する。
- アカウント運用: 医師会事務局（`officeAdmin` ロール想定）がメンバー申請を承認するフローを用意しつつ、従来の「systemRoot からの直接招待」も併用可能にする。申請フォーム経由で本人が申請 → 事務局承認、または施設長/ systemRoot が招待メールを送る二つのルートを維持する。

## 7. 検索・公開ポータルの長期ビジョン
- 施設情報・スタッフスキルが十分蓄積された段階で、Medical Orchestra の検索ポータルを拡充する。
- **フィルタ検索**: 位置情報（地図/距離）、症状、体の部位、病名、診療メニュー、検査、タグ（診療形態・委員会・専門領域など）を選択式で組み合わせて絞り込み。
- **自然言語検索**: ユーザー（患者・紹介元など）が自由入力した文章を解析し、AI が適切な施設・医療者候補を提示。検索意図に応じた追加質問やリライティングを行う。
- **検索スコアリング**: スタッフのスキル・経験、施設設備、チャットでの活動度などを加味したランキングを設計。
- **公開プロファイル**: スタッフの公開可能な情報（スキル・実績・ポートフォリオ）を一覧表示し、履歴書ビューとの連携を図る。
- この検索機能はチャット機能と連携し、検索結果から直接チャット招待や紹介フローに移れる導線を設ける。

## 8. AI/RAG 活用の方針
- 今後蓄積される施設・スタッフ・チャット・ドキュメントのデータは、AI が参照・推論できるよう構造化して保存する。
- **ドキュメント化**: 施設情報、スタッフ技能、チャット議事録、ポートフォリオなどを要約・タグ付けし、検索インデックス兼ナレッジベースとして利用。
- **埋め込みベクトル**: RAG（Retrieval Augmented Generation）向けに、主要データ（施設概要、スタッフプロフィール、症例共有ログ等）をベクトル化し、問い合わせ時に文脈として供給する。
- **プライバシー制御**: 個人情報や非公開データはアクセス制御を厳格に行い、AI へのコンテキスト注入前にマスキング・権限チェックを実施。
- **ユースケース**: 自然言語検索、チャット内の自動要約・議事録生成、紹介状の下書き、患者向け説明文生成など。
- これらの AI 利用を前提とし、データスキーマや API はメタデータ（タグ・権限・更新日時）を含む形で設計する。

## 7. 次のステップ（詳細）
1. **アカウントオンボーディングの安定化**
   - systemRoot / facilityAdmin / clinicStaff の新規招待〜登録〜ログインフローを通し、エラーや未整備 UI を洗い出して解消。
   - 既存アカウント作成時のデータ整合性（重複メール・リトライ時のハンドリング）を確認し、監査ログを整備。
   - フローが安定したタイミングで「アカウント作成済みでないと新規施設登録できない」仕様へ段階的に移行（暫定的には systemRoot が代理登録し、施設管理者へ招待する運用に切り替える）。
2. **メンバーシップ拡張の技術検証**
   - ダミーレスポンスで `auth/login` に `memberships` 配列を追加し、トークンサイズやクライアント互換性をチェック。
   - `NcdAuth` に `getMembershipForClinic` / `hasClinicRole` を実装し、施設ホームでの権限判定を切り替える。
3. **スタッフプロフィールスキーマの詳細化**
   - 必須項目・公開設定（公開／限定公開／非公開）を一覧化し、入力フォーム／承認フローを定義。
   - ポートフォリオ生成テンプレート（HTML／PDF）の構造を設計。
4. **スタッフ技能の API 設計とプロトタイピング**
   - `staff/updateSkills`, `staff/listByClinic`, `clinic/skillSummary` のリクエスト／レスポンス例をモック化し、機能テスト用スクリプトを準備。
5. **施設長による代行入力フロー**
   - 権限委任モデル（どの施設長がどのスタッフのどの項目を編集可能か）を仕様化。
   - 編集履歴の監査ログ形式と通知フロー（本人承認／差分閲覧）を決定。
6. **既存データとの整合性チェック**
   - 現行 `clinic.qualifications` 等とスタッフ技能の相互変換ツール（移行スクリプト）を用意。
   - スタッフ未登録施設向けに従来 UI を残す期間と切り替え条件を整理。

マイルストーン別に上記タスクの優先度・担当を割り振り、実装に着手する。

## 8. チャット機能に関する確認事項（要ご相談）
1. **任意グループの承認フロー**  
   - 参加は招待制／申請制／自由参加のいずれを想定しているか。申請制の場合、誰が承認者になるか。
2. **公開スレッドの分類**  
   - 診療分野以外にタグ付けしたい軸はあるか（地域・症例の重症度・患者属性など）。
3. **メッセージ保管ポリシー**  
   - 保存期間、エクスポートや監査ログの要否、医療情報に該当する内容の取り扱いルール。
4. **通知要件**  
   - グループ参加／メンション／新規スレッド作成時の通知チャネル（メール／アプリ内通知）と頻度。
5. **アクセス権限の例外**  
   - 施設長が全スレッドを閲覧可能とするか、施設外メンバーを含む場合の公開範囲をどう限定するか。

## 9. 医療情報ネット オープンデータ連携
- 厚生労働省公開の医療情報ネット CSV を `data/medical-open-data/` 配下に保管し、都道府県コード／市区町村コードで中野区などを抽出できるようにする。半年ごとの更新に合わせて再インポート手順を設ける。
- 施設名・所在地・緯度経度・休診情報・病床数など主要項目を内部マスターに保持し、以下の機能に活用する。
  - 新規施設登録時のサジェスト（名称検索 → 候補選択 → 基本情報を自動入力）。
  - Google マップ上で登録状況を可視化（NCD 登録済み＝赤、未登録＝青など）。
  - 公開ポータルや AI 検索のデータソースとして再利用。
- データ利用時は出典（厚生労働省 医療情報ネット、公開年月）を明示し、差分更新や履歴管理の方法を検討する。

