# NCD 全体ロードマップ

中野区診療所データベース（NCD）を起点に、医療施設・医療者・患者が連携できるエコシステムを段階的に構築するためのロードマップを整理する。本資料は和久井さんが提示した将来像と保有ドメインを基に、サービス区分・役割・インフラ構成を再設計した最新版である。

---

## 1. ビジョンとサービスブランド

| フェーズ | サービス名 / ドメイン | 概要 | 主担当データ / ユーザー |
|----------|----------------------|------|-------------------------|
| Phase A | **NCD Core**（`ncd-app` 既存） | 診療所・病院の施設マスタ、マスター管理、管理画面 | 施設データ、診療・検査・資格マスター、医師会担当者 |
| Phase B | **SkilBank**（`skill-bank.jp`） | 医療者プロフィール・履歴書・スキル管理、複数施設所属対応 | 医療者、施設管理者、人事担当 |
| Phase C | **Medical Orchestra**（`medicalorchestra.com`） | 医療者/施設/患者間チャット、紹介・予約、公開検索ポータル | 医療者、患者、紹介担当者 |
| Phase D | **MedicalDraft**（`medicaldraft.jp`） | 医療者スカウト・転職マッチング、契約・監視 | 施設経営層、人事、転職希望医療者 |

補助ドメインとして `medicalyoutube.com`（教育・プロモーション）、`undistance.jp`（遠隔医療/社内ツール候補）を保持し、必要に応じて Pages やランディングに割り当てる。

---

## 2. 現状と直近課題（2025-10 時点）

- NCD Core は中野区医師会所属診療所のデータ入力・管理機能を運用中。施設登録〜詳細編集 UI と Cloudflare Workers API が整備済み。
- 医療者アカウント、認証基盤、監査ログなどは実装中で、職種横断的な医療者管理は未着手。
- 管理画面は誰でもアクセス可能な状態で、将来的には `systemRoot`（和久井さん専用）と通常 `systemAdmin` の二段階制へ切り替える予定。
- データストアは Cloudflare KV/R2 に集中しており、医療者個人情報やチャット履歴を扱う際の分離設計が必要。

---

## 3. フェーズ別ロードマップ

### Phase A: NCD Core 拡張（診療所→病院・他医師会へ）
1. **多テナント化**: 施設・医療者レコードに `organizationId` を追加し、医師会/地域単位で設定を分離。  
2. **ロール強化**: `systemRoot` / `systemAdmin` / `clinicAdmin` / `clinicStaff` の認証・権限を実装し、管理画面へのアクセスを `systemRoot` 限定モードへ切り替える。  
   - 2025-02: 管理者権限を先生方自身が申請できるよう `adminRequest` スキーマと API を追加済み。`adminReviewer` ロールを新設し、医師会事務が申請承認を担当できる体制に移行中。  
   - `POST /api/auth/requestAdminAccess` で申請受付、`GET/POST /api/admin/accessRequests*` で承認・却下を処理。通知メールの宛先は `ADMIN_NOTIFY_EMAILS` 環境変数で管理。  
   - 次段階でフロント導線（申請フォーム、承認UI、トップページのログイン必須化）を整備し、全施設へのロール付与が完了したら「施設を選ぶ」導線を廃止する。  
3. **データ移行**: 既存クリニックデータを schema v2 に統合し、スキーマ変換スクリプト・検証ツール・バックアップ手順を整備。  
4. **マスター整理**: 病院向け項目（病床数、診療科体系、施設属性）を追加し、多地域展開に向けたカテゴリ体系を標準化。  
5. **監査・運用**: 監査ログ、通知、権限逸脱検知を導入。

### Phase B: SkilBank（医療者データベース）
1. **アカウントモデル**: 医療者プロフィール、複数施設所属、友人（フレンド）関係を扱うデータ構造を設計。  
2. **項目定義**: 職種・資格・学会・スキル・学歴・職歴など履歴書項目をカテゴリ化し、項目単位で公開レベルを設定できる UI/API を実装。  
3. **プライバシー**: 住所・連絡先などの秘匿情報は暗号化保存し、公開/限定公開/非公開を制御する `visibility` フラグと許諾トークンを導入。  
4. **履歴書生成**: 登録情報から PDF/共有リンクを生成し、本人許諾者のみ閲覧可能にする。  
5. **SkilBank ↔ NCD 連携**: 施設画面で所属医療者の公開スキル・資格を読み取り専用表示し、検索用途へ活用。

### Phase C: Medical Orchestra（チャット & 紹介プラットフォーム）
1. **リアルタイム基盤**: Workers Durable Objects や専用 WebSocket サービスでチャットルーム・グループを構築。  
2. **紹介フロー**: 病院⇔診療所、診療所⇔診療所、患者⇔診療所の紹介・予約シナリオをテンプレート化し、チャットから紹介状作成・共有まで完結できる UX を提供。  
3. **公開検索**: SkilBank/NCD の公開データを検索エンジン（Algolia/Meilisearch 等）へ連携し、誰でも施設・医療者を探せるポータルを構築。  
4. **権限制御**: チャット参加者や閲覧できる患者情報は `viewerContext` と公開設定で制御し、監査ログに記録。  
5. **ドメイン展開**: `medicalorchestra.com` のトップはマーケティング/Landing、アプリ本体は `app.medicalorchestra.com` のように分離。

### Phase D: MedicalDraft（転職支援）
1. **サービス開始条件**: SkilBank利用者・施設利用者が十分に増えた段階でクローズド β を開始。それまでは内部ロードマップのみで表には出さない。  
2. **匿名検索/オファー**: 施設管理者が性別・年齢帯・地域・スキル条件で匿名検索し、給与/契約金を提示できる UI とAPIを構築。  
3. **チャット連携**: オファーは Medical Orchestra のチャットに届き、医療者が「転職用ステータスのお友達」に昇格させて情報公開レベルを調整できる。  
4. **契約管理**: 面談・契約書作成・締結・運営による履行監視をワークフロー化し、報酬請求やステータス管理をバックオフィスUIで提供。  
5. **法務/課金**: アルトライテクノロジーズ名義での利用規約・契約書テンプレート・料金体系を整備し、決済やインボイス発行まで対応。

---

## 4. 役割・認証・アクセス制御

| ロール | 権限概要 | 備考 |
|--------|----------|------|
| `systemRoot` | 和久井さん専用。全サービスの設定/ユーザー/ドメイン/課金など全権管理。 | 管理画面アクセスの切替タイミングも決定。MFA必須。 |
| `systemAdmin` | 日常運用を担うシステム管理者。施設・医療者・マスター編集、ログ閲覧。 | 転職オファー承認、契約監視など敏感操作は `systemRoot` の承認が必要。 |
| `facilityAdmin` | 自施設の登録・スタッフ招待・患者対応を管理。SkilBankで所属医療者のプロフィール閲覧/承認が可能。 | Medical Orchestra で紹介依頼・患者チャットを担当。 |
| `staff` / `medicalProfessional` | 施設スタッフや医療者。プロフィール更新やチャット参加。公開レベルは本人設定。 | SkilBankで履歴書公開、MedicalDraftでオファー受信。 |

認証は中央IdP（仮称 `auth.skill-bank.jp`）で実装し、各サービスは JWT の Audience / Scope を用いてアクセス制御する。Workers KV (もしくは D1) にセッション・招待・パスワードリセットを保存し、監査ログにはログイン・権限変更・データ閲覧を記録する。

---

## 5. インフラ / システム分離方針

1. **サービス構成**  
   - `ncd-app`（Workers）：NCD Core API。施設データ・マスター管理。  
   - `skilbank-api`（Workers想定）：医療者プロフィール管理。PII は D1/PostgreSQL で暗号化保存。  
   - `orchestra-gateway` & `orchestra-rt`：Medical Orchestra のREST/リアルタイム（DO/WebSocket）。  
   - `draft-backoffice`：MedicalDraft のオファー・契約管理。決済連携が必要になるため、外部DB + Queue を想定。  
   - `static-sites`：Cloudflare Pages でブランド別ランディングをホストし、カスタムドメインを割り当て。  

2. **データ連携**  
   - 各サービスは共通ID（`account:<uuid>` / `clinic:<uuid>` / `skillProfile:<uuid>`）で紐付け、公開情報は Event/Queue 経由で同期。  
   - 個人情報は SkilBank/MedicalDraft 側で保持し、NCD/Orchestra は公開用のキャッシュテーブルを参照。  

3. **セキュリティ**  
   - Cloudflare Zero Trust で管理ポータルと API へのアクセスを制限。  
   - Secrets（APIキー・Webhook）は Workers Secrets に保存し、サービス毎に分離。  
   - 監査・アラートは Grafana Cloud 等へ集約し、トークン失効やレートリミットを徹底。  

4. **ドメイン割り当て例**  
   - `ncd-app.jp`（想定）: 医師会向けポータルと既存UI。  
   - `skill-bank.jp`: SkilBank本番 `app.skill-bank.jp`、LP `www.skill-bank.jp`。  
   - `medicalorchestra.com`: LP / アプリ / サポートのサブドメイン分割。  
   - `medicaldraft.jp`: β開始時に `app.medicaldraft.jp` を公開、公開前は社内専用。  

---

## 6. 次のアクション（優先度順）

1. **認証リファクタ**: `systemRoot` 専用アクセス制御を先行実装し、管理画面をロックダウン。  
2. **多テナント準備**: `organizationId` 追加と医師会ごとの設定ファイル化、データ移行計画の策定。  
3. **SkilBank プロトタイプ**: 医療者プロフィールのデータモデルと公開制御の設計、最低限の入力UI試作。  
4. **Medical Orchestra 設計**: リアルタイム基盤の技術選定とチャット/紹介フローのモック作成。  
5. **ドメイン/DNS 整備**: 各ブランドの DNS・SSL・Pages 連携を洗い出し、リリース順にチェックリスト化。  
6. **法務準備**: MedicalDraft の契約書ひな形・利用規約・個人情報保護方針を整理し、公開タイミングを判断できる材料を集約。  

---

## 7. 現状の不具合・対応状況（2025-10-21）

- **systemRoot ログイン不可（解消済み）**  
  - 原因: PBKDF2 の iteration `150000` が Workers Runtime で許容されず `NotSupportedError` が発生。  
  - 対応: `functions/lib/auth/password.js` の既定/最大 iteration を `100000` に引き下げ、`system-root.json` の `passwordHash` を再生成して Cloudflare KV（本番/プレビュー）へ再投入。  
  - 結果: `wakui@altry-med.or.jp` / `keishinyuusaku@1043` でログイン成功を確認済み。
- **JWT_SECRET 未設定（解消済み）**  
  - ログイン後のトークン発行が `JWT secret is not configured` で失敗。  
  - 対応: Cloudflare シークレットに 64 文字のランダム文字列を `JWT_SECRET` として設定。  
  - 結果: アクセストークン／リフレッシュトークン発行が正常化。
- **パスワード再設定メール未送信（継続課題）**  
  - 現状 `mailProvider: "log"` でダミー送信。今後 SendGrid 等の本番設定が必要。
- **ログ監視**  
  - Workers Logs を有効化し、`wrangler tail` で現象切り分け可能な状態に更新。
- **施設ホームの権限制御改善中**  
  - systemRoot 用のログアウトボタンおよび施設管理者向けインラインログインフォームを追加。  
  - ログアウト時に `localStorage` に `ncdAuth` が残っていると編集リンクが有効化されたままになるため、今後はサーバー応答に基づく権限制御へ寄せる必要がある。  
  - 管理者未設定の施設は従来通り編集可・管理者設定済み施設のみログイン必須という仕様を継続しつつ、UI/UX とデータ整合性の最終調整を進める。

本ロードマップは定期的にアップデートする。新しい要件が出た場合は、本ドキュメントを更新しつつ、詳細設計書や運用 Runbook を別途切り出していく。次回の見直しタイミングでは、各フェーズの進捗／リソースへの影響／ドメイン運用状況をレビューする。
