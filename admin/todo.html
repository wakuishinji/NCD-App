<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>開発ToDo管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a2d9d6b3e2.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">📋 開発ToDo管理</h1>

    <!-- カテゴリー追加 -->
    <div class="flex gap-2 mb-4">
      <input id="newCategory" type="text" placeholder="新しいカテゴリー名"
        class="border rounded p-2 flex-1">
      <button onclick="addCategory()" class="bg-blue-600 text-white px-4 py-2 rounded">
        カテゴリー追加
      </button>
    </div>

    <!-- ToDo一覧 -->
    <div id="todoContainer" class="space-y-6"></div>

    <!-- 保存ボタン -->
    <div class="mt-6">
      <button onclick="saveTodos()" class="bg-green-600 text-white px-6 py-3 rounded shadow">
        💾 保存
      </button>
    </div>
  </div>

<script>
let todos = [
  {category: "フロントエンド", title: "フォームバリデーション実装", status: "open", priority: "P1"},
  {category: "サーバー", title: "Let’s Encrypt 自動更新", status: "done", priority: "P2"}
];

function renderTodos() {
  const container = document.getElementById("todoContainer");
  container.innerHTML = "";

  const categories = [...new Set(todos.map(t => t.category))];
  categories.forEach(cat => {
    const section = document.createElement("div");
    section.innerHTML = `<h2 class="text-xl font-semibold mb-2">${cat}</h2>`;

    todos.filter(t => t.category === cat).forEach((t, idx) => {
      const item = document.createElement("div");
      item.className = "flex items-center gap-2 mb-2";
      item.innerHTML = `
        <input type="checkbox" ${t.status === "done" ? "checked" : ""} 
          onchange="toggleStatus(${idx})" class="w-4 h-4">
        <input type="text" value="${t.title}" onchange="editTitle(${idx}, this.value)" 
          class="border rounded p-1 flex-1">
        <select onchange="editPriority(${idx}, this.value)" class="border rounded p-1">
          <option ${t.priority==="P1"?"selected":""}>P1</option>
          <option ${t.priority==="P2"?"selected":""}>P2</option>
          <option ${t.priority==="P3"?"selected":""}>P3</option>
        </select>
        <button onclick="deleteTask(${idx})" class="text-red-600">
          <i class="fas fa-trash"></i>
        </button>
      `;
      section.appendChild(item);
    });

    // 新規タスク追加フォーム
    const form = document.createElement("div");
    form.className = "flex gap-2 mt-2";
    form.innerHTML = `
      <input id="newTask-${cat}" type="text" placeholder="新しいタスク" class="border rounded p-2 flex-1">
      <button onclick="addTask('${cat}')" class="bg-blue-600 text-white px-3 rounded">追加</button>
    `;
    section.appendChild(form);

    container.appendChild(section);
  });
}

function addCategory() {
  const name = document.getElementById("newCategory").value.trim();
  if (!name) return;
  todos.push({category: name, title: "新しいタスク", status: "open", priority: "P3"});
  document.getElementById("newCategory").value = "";
  renderTodos();
}

function addTask(cat) {
  const input = document.getElementById(`newTask-${cat}`);
  const title = input.value.trim();
  if (!title) return;
  todos.push({category: cat, title, status: "open", priority: "P3"});
  input.value = "";
  renderTodos();
}

function toggleStatus(idx) { todos[idx].status = todos[idx].status === "done" ? "open" : "done"; }
function editTitle(idx, val) { todos[idx].title = val; }
function editPriority(idx, val) { todos[idx].priority = val; }
function deleteTask(idx) { todos.splice(idx, 1); renderTodos(); }

function saveTodos() {
  fetch("/api/todo/save", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(todos)
  }).then(r => r.json()).then(d => {
    alert("保存しました！");
    console.log(d);
  }).catch(e => alert("保存に失敗しました"));
}

renderTodos();
</script>
</body>
</html>
