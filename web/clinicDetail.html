<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>診療所詳細入力 - NCD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 右下固定アクション */
    .fab {
      position: fixed; right: 16px; bottom: 16px;
      display: flex; gap: 8px; z-index: 50;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- ヘッダー -->
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
        <a href="clinicHome.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">施設ホームへ</a>
      </div>
      <h1 class="text-xl font-bold">診療所詳細入力</h1>
      <a href="clinicList.html" class="text-white/90 hover:text-white text-sm underline">施設選択へ</a>
    </div>
  </header>

  <!-- メイン -->
  <main class="flex-1 max-w-6xl mx-auto p-4 md:p-6 space-y-6">
    <!-- 基本情報 -->
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-lg font-semibold text-blue-800 mb-4">基本情報</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">名称</label>
          <input id="clinicName" class="w-full border rounded px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">住所</label>
          <input id="clinicAddress" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">常勤医師数</label>
          <input id="numFulltime" type="number" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">非常勤医師数</label>
          <input id="numParttime" type="number" class="w-full border rounded px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">ホームページ</label>
          <div class="flex items-center gap-4 text-sm text-gray-700">
            <label class="flex items-center gap-1">
              <input type="radio" name="homepageStatus" value="none" class="text-blue-600" checked />
              なし
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="homepageStatus" value="available" class="text-blue-600" />
              あり
            </label>
          </div>
          <input id="homepageUrl" type="url" class="mt-2 w-full border rounded px-3 py-2 hidden" placeholder="https://example.clinic.jp" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">予約サイト</label>
          <div class="flex items-center gap-4 text-sm text-gray-700">
            <label class="flex items-center gap-1">
              <input type="radio" name="reservationStatus" value="none" class="text-blue-600" checked />
              なし
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="reservationStatus" value="available" class="text-blue-600" />
              あり
            </label>
          </div>
          <input id="reservationUrl" type="url" class="mt-2 w-full border rounded px-3 py-2 hidden" placeholder="https://example.clinic.jp/reserve" />
        </div>
      </div>
    </section>

    <!-- 標榜診療科 -->
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-lg font-semibold text-blue-800 mb-4">標榜診療科</h2>
      <p class="text-sm text-gray-600 mb-4">マスターで承認済みの診療科を複数選択できます。該当がない場合は「その他診療科」に入力してください（1行につき1診療科）。</p>
      <div id="departmentOptions" class="grid md:grid-cols-2 gap-2 mb-4"></div>
      <div>
        <label for="departmentOthers" class="block text-sm text-gray-700 mb-1">その他診療科</label>
        <textarea id="departmentOthers" rows="3" class="w-full border rounded px-3 py-2" placeholder="例: 睡眠医療センター\n例: 緩和ケア内科"></textarea>
        <p class="text-xs text-gray-500 mt-1">入力された診療科は候補としてマスターに登録され、管理画面で承認できます。</p>
      </div>
    </section>

    <!-- 診療時間設定 -->
    <section class="bg-white rounded shadow p-6" id="clinic-schedule">
      <h2 class="text-lg font-semibold text-blue-800 mb-4">診療時間設定</h2>

      <!-- パターン登録 -->
      <div class="border rounded p-4">
        <h3 class="font-medium text-gray-800 mb-3">診療時間パターン登録</h3>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <div class="text-sm text-gray-600 mb-1">午前A</div>
            <div class="flex items-center gap-2">
              <input type="time" id="amA_start" class="border rounded px-2 py-1">～
              <input type="time" id="amA_end" class="border rounded px-2 py-1">
            </div>
          </div>
          <div>
            <div class="text-sm text-gray-600 mb-1">午前B</div>
            <div class="flex items-center gap-2">
              <input type="time" id="amB_start" class="border rounded px-2 py-1">～
              <input type="time" id="amB_end" class="border rounded px-2 py-1">
            </div>
          </div>
          <div>
            <div class="text-sm text-gray-600 mb-1">午後A</div>
            <div class="flex items-center gap-2">
              <input type="time" id="pmA_start" class="border rounded px-2 py-1">～
              <input type="time" id="pmA_end" class="border rounded px-2 py-1">
            </div>
          </div>
          <div>
            <div class="text-sm text-gray-600 mb-1">午後B</div>
            <div class="flex items-center gap-2">
              <input type="time" id="pmB_start" class="border rounded px-2 py-1">～
              <input type="time" id="pmB_end" class="border rounded px-2 py-1">
            </div>
          </div>
        </div>
        <button onclick="savePatterns()" class="mt-3 bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">パターン保存</button>
      </div>

      <!-- 曜日ごとの設定 -->
      <div class="mt-6 border rounded p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-medium text-gray-800">曜日ごとの診療パターン設定</h3>
          <div class="flex gap-2">
            <button onclick="applyAll('am')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">午前すべて 午前A</button>
            <button onclick="applyAll('pm')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">午後すべて 午後A</button>
            <button onclick="saveSchedule()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800">曜日設定を保存</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full border text-sm">
            <thead class="bg-gray-100">
              <tr><th class="border px-2 py-1">曜日</th><th class="border px-2 py-1">午前</th><th class="border px-2 py-1">午後</th></tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </div>

      <!-- 表示用 -->
      <div class="mt-6 border rounded p-4">
        <h3 class="font-medium text-gray-800 mb-2">診療時間（確認用表示）</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full border text-sm">
            <thead class="bg-gray-100">
              <tr><th class="border px-2 py-1">曜日</th><th class="border px-2 py-1">午前</th><th class="border px-2 py-1">午後</th></tr>
            </thead>
            <tbody id="displayBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- 右下 固定アクション -->
  <div class="fab">
    <button onclick="saveClinic()" class="bg-blue-600 text-white px-4 py-3 rounded shadow hover:bg-blue-700">この診療所を保存</button>
    <a href="clinicHome.html" class="bg-gray-600 text-white px-4 py-3 rounded shadow hover:bg-gray-700 flex items-center">Home</a>
  </div>

  <!-- フッター -->
  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

<script>
const BASE = "https://ncd-app.altry.workers.dev";
const days = ["月曜","火曜","水曜","木曜","金曜","土曜","日曜","祝日"];
const DEPARTMENT_CATEGORY = "標榜診療科";

let currentClinicId = "";
let retainedQualifications = "";
let departmentMaster = [];

function normalizeText(v) {
  return (v || "").trim();
}

function equalsIgnoreCase(a, b) {
  return normalizeText(a).toLowerCase() === normalizeText(b).toLowerCase();
}

function renderDepartmentChecklist(selectedNames = []) {
  const container = document.getElementById("departmentOptions");
  if (!container) return;
  container.innerHTML = "";

  if (!departmentMaster.length) {
    container.innerHTML = '<p class="text-sm text-gray-500">承認済みの標榜診療科がまだ登録されていません。</p>';
    return;
  }

  const selectedSet = new Set((selectedNames || []).map(s => normalizeText(s)));
  departmentMaster.forEach(item => {
    const value = item.name || "";
    const display = item.canonical_name || item.name || "";
    const isChecked = selectedSet.has(normalizeText(item.name)) || selectedSet.has(normalizeText(item.canonical_name));
    const wrapper = document.createElement('label');
    wrapper.className = "flex items-center gap-2 bg-gray-50 border rounded px-3 py-2 hover:bg-gray-100";

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'deptMaster';
    checkbox.value = value;
    checkbox.className = 'h-4 w-4';
    checkbox.checked = isChecked;

    const text = document.createElement('span');
    text.className = 'text-sm text-gray-700';
    text.textContent = display;

    wrapper.appendChild(checkbox);
    wrapper.appendChild(text);
    container.appendChild(wrapper);
  });
}

async function loadDepartmentMaster() {
  try {
    const url = new URL(`${BASE}/api/listMaster`);
    url.searchParams.set('type', 'department');
    url.searchParams.set('status', 'approved');
    const res = await fetch(url.toString());
    const data = await res.json();
    departmentMaster = (data.ok ? data.items : [])
      .sort((a, b) => (a.canonical_name || a.name || "").localeCompare(b.canonical_name || b.name || "", 'ja'));
  } catch (err) {
    console.warn('failed to load department master', err);
    departmentMaster = [];
  }
  renderDepartmentChecklist();
}

function parseDepartments(raw) {
  if (!raw) return { master: [], others: [] };
  if (Array.isArray(raw)) return { master: raw, others: [] };
  if (typeof raw === 'object') {
    const master = Array.isArray(raw.master) ? raw.master : Array.isArray(raw.standard) ? raw.standard : [];
    const others = Array.isArray(raw.others) ? raw.others : [];
    return { master, others };
  }
  return { master: [], others: [] };
}

async function registerDepartmentCandidates(names) {
  if (!names?.length) return;
  const unique = Array.from(new Set(names.map(normalizeText))).filter(Boolean);
  const existing = departmentMaster.map(it => normalizeText(it.name)).concat(departmentMaster.map(it => normalizeText(it.canonical_name))); 
  const targets = unique.filter(name => !existing.includes(name));
  if (!targets.length) return;
  await Promise.allSettled(targets.map(name =>
    fetch(`${BASE}/api/addMasterItem`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "department", category: DEPARTMENT_CATEGORY, name, source: "clinicDetail" })
    })
  ));
}

function updateHomepageField() {
  const show = document.querySelector("input[name='homepageStatus']:checked")?.value === "available";
  const field = document.getElementById("homepageUrl");
  if (field) {
    field.classList.toggle("hidden", !show);
  }
}

function updateReservationField() {
  const show = document.querySelector("input[name='reservationStatus']:checked")?.value === "available";
  const field = document.getElementById("reservationUrl");
  if (field) {
    field.classList.toggle("hidden", !show);
  }
}

document.querySelectorAll("input[name='homepageStatus']").forEach(r => r.addEventListener("change", updateHomepageField));
document.querySelectorAll("input[name='reservationStatus']").forEach(r => r.addEventListener("change", updateReservationField));
updateHomepageField();
updateReservationField();

function initScheduleTable(){
  const tbody = document.getElementById("scheduleBody");
  tbody.innerHTML = "";
  days.forEach((d,i)=>{
    tbody.innerHTML += `
      <tr>
        <td class="border px-2 py-1 text-center">${d}</td>
        <td class="border px-2 py-1 text-center">
          <select id="am_${i}" class="border rounded px-2 py-1">
            <option>午前A</option><option>午前B</option><option>休診</option>
          </select>
        </td>
        <td class="border px-2 py-1 text-center">
          <select id="pm_${i}" class="border rounded px-2 py-1">
            <option>午後A</option><option>午後B</option><option>休診</option>
          </select>
        </td>
      </tr>`;
  });
}
initScheduleTable();

function savePatterns(){
  const patterns = {
    amA:[document.getElementById("amA_start").value, document.getElementById("amA_end").value],
    amB:[document.getElementById("amB_start").value, document.getElementById("amB_end").value],
    pmA:[document.getElementById("pmA_start").value, document.getElementById("pmA_end").value],
    pmB:[document.getElementById("pmB_start").value, document.getElementById("pmB_end").value]
  };
  localStorage.setItem("patterns", JSON.stringify(patterns));
  alert("診療時間パターンを保存しました");
}

function applyAll(type){
  const target = type==="am" ? "午前A" : "午後A";
  days.forEach((d,i)=>{
    document.getElementById(type+"_"+i).value = target;
  });
}

function saveSchedule(){
  const schedule = {};
  days.forEach((d,i)=>{
    schedule[d] = {
      am: document.getElementById("am_"+i).value,
      pm: document.getElementById("pm_"+i).value
    };
  });
  localStorage.setItem("schedule", JSON.stringify(schedule));
  renderDisplay();
}

function renderDisplay(){
  const display = document.getElementById("displayBody");
  display.innerHTML = "";
  const patterns = JSON.parse(localStorage.getItem("patterns")||"{}");
  const schedule = JSON.parse(localStorage.getItem("schedule")||"{}");

  days.forEach(d=>{
    const am = schedule[d]?.am || "休診";
    const pm = schedule[d]?.pm || "休診";
    display.innerHTML += `
      <tr>
        <td class="border px-2 py-1 text-center">${d}</td>
        <td class="border px-2 py-1 text-center">${getTimeText(am, patterns)}</td>
        <td class="border px-2 py-1 text-center">${getTimeText(pm, patterns)}</td>
      </tr>`;
  });
}

function getTimeText(sel, patterns){
  switch(sel){
    case "午前A": return patterns.amA?.join("～") || "";
    case "午前B": return patterns.amB?.join("～") || "";
    case "午後A": return patterns.pmA?.join("～") || "";
    case "午後B": return patterns.pmB?.join("～") || "";
    case "休診": return "休診";
    default: return "";
  }
}

async function saveClinic() {
  const name       = document.getElementById("clinicName").value.trim();
  const address    = document.getElementById("clinicAddress").value.trim();
  const fulltime   = document.getElementById("numFulltime").value;
  const parttime   = document.getElementById("numParttime").value;

  if (!name) {
    alert("名称を入力してください。");
    return;
  }

  const selectedDeptMaster = Array.from(document.querySelectorAll("input[name='deptMaster']:checked"))
    .map(el => el.value)
    .filter(Boolean);
  const selectedDeptSet = new Set(selectedDeptMaster.map(normalizeText));
  const otherDeptInput = document.getElementById("departmentOthers").value.split(/\n+/)
    .map(normalizeText)
    .filter(Boolean);
  const uniqueOtherDept = Array.from(new Set(otherDeptInput))
    .filter(name => !selectedDeptSet.has(normalizeText(name)));

  const homepageStatus = document.querySelector("input[name='homepageStatus']:checked")?.value || "none";
  const reservationStatus = document.querySelector("input[name='reservationStatus']:checked")?.value || "none";
  const homepageUrlInput = document.getElementById("homepageUrl").value.trim();
  const reservationUrlInput = document.getElementById("reservationUrl").value.trim();

  const hasHomepage = homepageStatus === "available";
  const homepageUrl = hasHomepage ? homepageUrlInput : "";
  if (hasHomepage && !homepageUrl) {
    alert("ホームページURLを入力してください。");
    return;
  }

  const hasReservation = reservationStatus === "available";
  const reservationUrl = hasReservation ? reservationUrlInput : "";
  if (hasReservation && !reservationUrl) {
    alert("予約サイトのURLを入力してください。");
    return;
  }

  const patterns = JSON.parse(localStorage.getItem("patterns") || "{}");
  const schedule = JSON.parse(localStorage.getItem("schedule") || "{}");

  const clinicData = {
    id: currentClinicId,
    name,
    address,
    doctors: {
      fulltime: Number(fulltime||0),
      parttime: Number(parttime||0),
      qualifications: retainedQualifications || ""
    },
    schedule: { patterns, days: schedule },
    homepage: { available: hasHomepage, url: homepageUrl },
    reservation: { available: hasReservation, url: reservationUrl },
    departments: {
      master: selectedDeptMaster,
      others: uniqueOtherDept
    }
  };

  try {
    const res = await fetch(`${BASE}/api/updateClinic`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(clinicData)
    });
    if (!res.ok) throw new Error("API更新エラー");

    const result = await res.json();
    localStorage.setItem("selectedClinic", JSON.stringify(result.clinic));
    alert("診療所データを更新しました");
    await registerDepartmentCandidates(uniqueOtherDept);
  } catch (err) {
    alert("保存に失敗しました: " + err.message);
    console.error(err);
  }
}

// 選択済み施設から初期値ロード
function loadClinicDetail() {
  const stored = localStorage.getItem("selectedClinic");
  if (!stored) { renderDisplay(); return; }

  const clinic = JSON.parse(stored);
  currentClinicId = clinic.id || "";
  retainedQualifications = clinic.doctors?.qualifications || "";

  document.getElementById("clinicName").value      = clinic.name || "";
  document.getElementById("clinicAddress").value   = clinic.address || "";
  document.getElementById("numFulltime").value     = clinic.doctors?.fulltime || "";
  document.getElementById("numParttime").value     = clinic.doctors?.parttime || "";

  const homepageData = clinic.homepage || {};
  const homepageAvailable = typeof homepageData.available === "boolean" ? homepageData.available : Boolean(homepageData.url);
  const homepageTarget = document.querySelector(`input[name='homepageStatus'][value='${homepageAvailable ? "available" : "none"}']`);
  if (homepageTarget) homepageTarget.checked = true;
  document.getElementById("homepageUrl").value = homepageData.url || "";
  updateHomepageField();

  const reservationData = clinic.reservation || {};
  const reservationAvailable = typeof reservationData.available === "boolean" ? reservationData.available : Boolean(reservationData.url);
  const reservationTarget = document.querySelector(`input[name='reservationStatus'][value='${reservationAvailable ? "available" : "none"}']`);
  if (reservationTarget) reservationTarget.checked = true;
  document.getElementById("reservationUrl").value = reservationData.url || "";
  updateReservationField();

  const deptState = parseDepartments(clinic.departments);
  renderDepartmentChecklist(deptState.master);
  document.getElementById("departmentOthers").value = deptState.others.join("\n");

  const patterns = clinic.schedule?.patterns || {};
  if (patterns.amA) { amA_start.value = patterns.amA[0] || ""; amA_end.value = patterns.amA[1] || ""; }
  if (patterns.amB) { amB_start.value = patterns.amB[0] || ""; amB_end.value = patterns.amB[1] || ""; }
  if (patterns.pmA) { pmA_start.value = patterns.pmA[0] || ""; pmA_end.value = patterns.pmA[1] || ""; }
  if (patterns.pmB) { pmB_start.value = patterns.pmB[0] || ""; pmB_end.value = patterns.pmB[1] || ""; }

  const schedule = clinic.schedule?.days || {};
  days.forEach((d,i)=>{
    if (schedule[d]) {
      document.getElementById("am_"+i).value = schedule[d].am || "休診";
      document.getElementById("pm_"+i).value = schedule[d].pm || "休診";
    }
  });

  renderDisplay();
}

window.addEventListener("DOMContentLoaded", async () => {
  await loadDepartmentMaster();
  loadClinicDetail();
});
</script>
</body>
</html>
