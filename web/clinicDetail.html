<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>診療所詳細入力 - NCD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ローディング機能 -->
  <script src="js/loading.js"></script>
  <script src="js/header.js" defer></script>
  <style>
    /* 右下固定アクション */
    .fab {
      position: fixed; right: 16px; bottom: 16px;
      display: flex; gap: 8px; z-index: 50;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- ヘッダー -->
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between gap-3">
        <div class="hidden md:flex items-center gap-2">
          <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
          <a href="clinicHome.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">施設ホームへ</a>
        </div>
        <h1 class="text-lg md:text-xl font-bold text-center md:text-left md:flex-1">診療所詳細入力</h1>
        <a href="clinicList.html" class="hidden md:inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30 whitespace-nowrap">施設選択へ</a>
        <button type="button" class="inline-flex items-center justify-center rounded bg-white/10 px-3 py-2 text-sm font-semibold transition hover:bg-white/20 md:hidden" data-mobile-menu="#clinic-detail-nav" aria-controls="clinic-detail-nav" aria-expanded="false" aria-label="メニューを開く">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" />
          </svg>
        </button>
      </div>
      <nav id="clinic-detail-nav" data-mobile-menu-target class="mt-3 hidden flex-col gap-2 md:hidden">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-2 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
        <a href="clinicHome.html" class="inline-flex items-center rounded bg-white/20 px-3 py-2 text-sm font-semibold text-white transition hover:bg-white/30">施設ホームへ</a>
        <a href="clinicList.html" class="inline-flex items-center rounded bg-white/20 px-3 py-2 text-sm font-semibold text-white transition hover:bg-white/30">施設選択へ</a>
      </nav>
    </div>
  </header>

  <!-- メイン -->
  <main class="flex-1 max-w-6xl mx-auto p-4 md:p-6 space-y-6">
    <!-- 基本情報 -->
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-lg font-semibold text-blue-800 mb-4">基本情報</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">名称</label>
          <input id="clinicName" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">郵便番号</label>
          <input id="clinicPostalCode" type="text" inputmode="numeric" pattern="[0-9\\-]*" class="w-full border rounded px-3 py-2" placeholder="123-4567" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">住所</label>
          <input id="clinicAddress" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">電話番号</label>
          <input id="clinicPhone" type="tel" class="w-full border rounded px-3 py-2" placeholder="03-1234-5678" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">FAX番号</label>
          <input id="clinicFax" type="tel" class="w-full border rounded px-3 py-2" placeholder="03-1234-9876" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">常勤医師数</label>
          <input id="numFulltime" type="number" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">非常勤医師数</label>
          <input id="numParttime" type="number" class="w-full border rounded px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">ホームページ</label>
          <div class="flex items-center gap-4 text-sm text-gray-700">
            <label class="flex items-center gap-1">
              <input type="radio" name="homepageStatus" value="none" class="text-blue-600" checked />
              なし
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="homepageStatus" value="available" class="text-blue-600" />
              あり
            </label>
          </div>
          <input id="homepageUrl" type="url" class="mt-2 w-full border rounded px-3 py-2 hidden" placeholder="https://example.clinic.jp" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">予約サイト</label>
          <div class="flex items-center gap-4 text-sm text-gray-700">
            <label class="flex items-center gap-1">
              <input type="radio" name="reservationStatus" value="none" class="text-blue-600" checked />
              なし
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="reservationStatus" value="available" class="text-blue-600" />
              あり
            </label>
          </div>
          <input id="reservationUrl" type="url" class="mt-2 w-full border rounded px-3 py-2 hidden" placeholder="https://example.clinic.jp/reserve" />
        </div>
      </div>
    </section>

    <!-- 標榜診療科 -->
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-lg font-semibold text-blue-800 mb-4">標榜診療科</h2>
      <p class="text-sm text-gray-600 mb-4">マスターで承認済みの診療科を複数選択できます。該当がない場合は「その他診療科」に入力してください（1行につき1診療科）。</p>
      <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
        <div id="departmentSummaryWrap" class="hidden rounded-md border border-blue-200 bg-blue-50 px-3 py-2 text-sm text-blue-900">
          <span class="font-semibold text-blue-800">選択済：</span>
          <span id="departmentSummary"></span>
        </div>
        <button id="departmentToggleBtn" type="button" class="self-start rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">選択する</button>
      </div>
      <div id="departmentSelection" class="space-y-4 mb-4 hidden" aria-hidden="true">
        <div id="departmentOptions" class="space-y-6"></div>
        <div class="flex justify-end">
          <button id="departmentSelectionDone" type="button" class="rounded bg-gray-700 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">完了</button>
        </div>
      </div>
      <div>
        <label for="departmentOthers" class="block text-sm text-gray-700 mb-1">その他診療科</label>
        <textarea id="departmentOthers" rows="3" class="w-full border rounded px-3 py-2" placeholder="例: 睡眠医療センター\n例: 緩和ケア内科"></textarea>
        <p class="text-xs text-gray-500 mt-1">入力された診療科は候補としてマスターに登録され、管理画面で承認できます。</p>
      </div>
    </section>

    <!-- 診療時間設定 -->
    <section class="bg-white rounded shadow p-6" id="clinic-schedule">
      <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <h2 class="text-lg font-semibold text-blue-800">診療時間設定</h2>
        <button id="scheduleToggleBtn" type="button" class="self-start rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">入力する</button>
      </div>
      <p class="text-sm text-gray-600 mb-4">診療時間を編集する場合は「入力する」ボタンを押してください。表示中の内容は保存済みの設定です。</p>

      <div id="scheduleEditPanel" class="space-y-6 hidden" aria-hidden="true">
        <!-- パターン登録 -->
        <div class="border rounded p-4">
          <h3 class="font-medium text-gray-800 mb-3">診療時間パターン登録</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <div class="rounded border border-blue-200 bg-blue-50/60 p-3">
              <div class="text-sm font-semibold text-blue-800 mb-2">午前A</div>
              <div class="flex items-center gap-2">
                <input type="time" id="amA_start" step="300" class="border rounded px-2 py-1">～
                <input type="time" id="amA_end" step="300" class="border rounded px-2 py-1">
              </div>
            </div>
            <div class="rounded border border-blue-200 bg-blue-50/60 p-3">
              <div class="text-sm font-semibold text-blue-800 mb-2">午前B</div>
              <div class="flex items-center gap-2">
                <input type="time" id="amB_start" step="300" class="border rounded px-2 py-1">～
                <input type="time" id="amB_end" step="300" class="border rounded px-2 py-1">
              </div>
            </div>
            <div class="rounded border border-amber-200 bg-amber-50/60 p-3">
              <div class="text-sm font-semibold text-amber-700 mb-2">午後A</div>
              <div class="flex items-center gap-2">
                <input type="time" id="pmA_start" step="300" class="border rounded px-2 py-1">～
                <input type="time" id="pmA_end" step="300" class="border rounded px-2 py-1">
              </div>
            </div>
            <div class="rounded border border-amber-200 bg-amber-50/60 p-3">
              <div class="text-sm font-semibold text-amber-700 mb-2">午後B</div>
              <div class="flex items-center gap-2">
                <input type="time" id="pmB_start" step="300" class="border rounded px-2 py-1">～
                <input type="time" id="pmB_end" step="300" class="border rounded px-2 py-1">
              </div>
            </div>
          </div>
          <button onclick="savePatterns()" class="mt-3 bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">パターン保存</button>
        </div>

        <!-- 曜日ごとの設定 -->
        <div class="border rounded p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-medium text-gray-800">曜日ごとの診療パターン設定</h3>
            <div class="flex gap-2">
              <button onclick="applyAll('am')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">午前すべて 午前A</button>
              <button onclick="applyAll('pm')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">午後すべて 午後A</button>
              <button onclick="saveSchedule()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800">曜日設定を保存</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full border text-sm">
              <thead class="bg-gray-100">
                <tr><th class="border px-2 py-1">曜日</th><th class="border px-2 py-1">午前</th><th class="border px-2 py-1">午後</th></tr>
              </thead>
              <tbody id="scheduleBody"></tbody>
            </table>
          </div>
        </div>

        <div class="flex justify-end">
          <button id="scheduleEditDone" type="button" class="rounded bg-gray-700 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">完了</button>
        </div>
      </div>

      <!-- 表示用 -->
      <div class="mt-6 border rounded p-4">
        <h3 class="font-medium text-gray-800 mb-2">診療時間（確認用表示）</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full border text-sm">
            <thead class="bg-gray-100">
              <tr><th class="border px-2 py-1">曜日</th><th class="border px-2 py-1">午前</th><th class="border px-2 py-1">午後</th></tr>
            </thead>
            <tbody id="displayBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- 右下 固定アクション -->
  <div class="fab">
    <button onclick="saveClinic()" class="bg-blue-600 text-white px-4 py-3 rounded shadow hover:bg-blue-700">この診療所を保存</button>
    <a href="clinicHome.html" class="bg-gray-600 text-white px-4 py-3 rounded shadow hover:bg-gray-700 flex items-center">Home</a>
  </div>

  <!-- フッター -->
  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

  <!-- ローディングオーバーレイ -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white px-6 py-4 rounded shadow text-gray-700 text-base font-semibold">データ読み込み中...</div>
  </div>

<script>
const BASE = "https://ncd-app.altry.workers.dev";
const days = ["月曜","火曜","水曜","木曜","金曜","土曜","日曜","祝日"];
const DEPARTMENT_CATEGORY = "標榜診療科";

let currentClinicId = "";
let retainedQualifications = "";
let departmentMaster = [];
let departmentSelectionEl = null;
let departmentToggleBtnEl = null;
const DEPARTMENT_CACHE_KEY = 'ncd_department_master_cache_v1';
const DEPARTMENT_CACHE_TTL = 10 * 60 * 1000;
let pendingDepartmentRender = false;
const DEFAULT_PATTERN_KEYS = ['amA','amB','pmA','pmB'];
const TIME_DEFAULTS = {
  am: { start: '09:00', end: '12:00' },
  pm: { start: '14:00', end: '18:00' }
};
const TIME_STEP_MINUTES = 5;
const ZIP_LOOKUP_ENDPOINT = 'https://zipcloud.ibsnet.co.jp/api/search';
const UNSAVED_WARNING_MESSAGE = '未保存の変更があります。保存せずに移動しますか？';
let scheduleState = {
  patterns: createEmptyPatterns(),
  days: {}
};
let scheduleEditPanelEl = null;
let scheduleToggleBtnEl = null;
let scheduleDoneBtnEl = null;
let latestPostalLookup = '';
let isDirty = false;
let suppressDirtyTracking = false;

function toggleLoadingOverlay(show) {
  const overlay = document.getElementById("loadingOverlay");
  if (!overlay) return;
  overlay.classList.toggle("hidden", !show);
}

function normalizeText(v) {
  return (v || "").trim();
}

function equalsIgnoreCase(a, b) {
  return normalizeText(a).toLowerCase() === normalizeText(b).toLowerCase();
}

function normalizePostalCode(value) {
  return (value || '').replace(/\D/g, '');
}

function formatPostalCode(value) {
  const digits = normalizePostalCode(value);
  if (!digits) return '';
  if (digits.length <= 3) return digits;
  return `${digits.slice(0, 3)}-${digits.slice(3, 7)}`;
}

function markDirty() {
  if (suppressDirtyTracking) return;
  isDirty = true;
}

function resetDirtyState() {
  isDirty = false;
  const postalInput = document.getElementById('clinicPostalCode');
  latestPostalLookup = postalInput ? normalizePostalCode(postalInput.value) : '';
}

function withDirtySuppressed(fn) {
  suppressDirtyTracking = true;
  try {
    fn();
  } finally {
    suppressDirtyTracking = false;
  }
}

function shouldTrackDirty(target) {
  if (!target || !target.tagName) return false;
  const tag = target.tagName.toLowerCase();
  if (tag === 'input') {
    const type = (target.type || '').toLowerCase();
    if (["submit","button","reset","image","file","hidden"].includes(type)) {
      return false;
    }
  }
  return tag === 'input' || tag === 'textarea' || tag === 'select';
}

function handlePotentialDirty(event) {
  if (shouldTrackDirty(event.target)) {
    markDirty();
  }
}

function handleNavigationAttempt(event) {
  if (!isDirty) return;
  if (event.defaultPrevented) return;
  if (event.button !== undefined && event.button !== 0) return;
  if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
  const targetNode = event.target instanceof Element ? event.target : event.target?.parentElement;
  if (!targetNode) return;
  const anchor = targetNode.closest('a[href]');
  if (!anchor) return;
  if (anchor.dataset.ignoreDirty === 'true') return;
  const href = anchor.getAttribute('href');
  if (!href || href.startsWith('#')) return;
  if (anchor.hasAttribute('download')) return;
  if (/^javascript:/i.test(href) || /^mailto:/i.test(href)) return;
  const targetAttr = anchor.getAttribute('target');
  if (targetAttr && targetAttr !== '_self') return;
  const destination = new URL(href, window.location.href);
  if (destination.href === window.location.href) return;

  const proceed = window.confirm(UNSAVED_WARNING_MESSAGE);
  if (!proceed) {
    event.preventDefault();
    event.stopImmediatePropagation();
  } else {
    resetDirtyState();
  }
}

function createEmptyPatterns() {
  return {
    amA: ["09:00", "12:00"],
    amB: ["09:00", "12:00"],
    pmA: ["14:00", "18:00"],
    pmB: ["14:00", "18:00"]
  };
}

function sanitizePatterns(source) {
  const base = createEmptyPatterns();
  if (!source || typeof source !== 'object') return base;
  DEFAULT_PATTERN_KEYS.forEach(key => {
    const slot = Array.isArray(source[key]) ? source[key] : [];
    base[key] = [slot[0] || '', slot[1] || ''];
  });
  return base;
}

function sanitizeScheduleDays(source) {
  const result = {};
  if (source && typeof source === 'object') {
    Object.keys(source).forEach(day => {
      const raw = source[day] || {};
      result[day] = {
        am: raw.am || '休診',
        pm: raw.pm || '休診'
      };
    });
  }
  return result;
}

function readScheduleFormPatterns() {
  return {
    amA: [document.getElementById('amA_start').value, document.getElementById('amA_end').value],
    amB: [document.getElementById('amB_start').value, document.getElementById('amB_end').value],
    pmA: [document.getElementById('pmA_start').value, document.getElementById('pmA_end').value],
    pmB: [document.getElementById('pmB_start').value, document.getElementById('pmB_end').value]
  };
}

function readScheduleFormDays() {
  const output = {};
  days.forEach((d, i) => {
    output[d] = {
      am: document.getElementById(`am_${i}`).value,
      pm: document.getElementById(`pm_${i}`).value
    };
  });
  return output;
}

function applyScheduleStateToForm() {
  const patterns = scheduleState.patterns || createEmptyPatterns();
  document.getElementById('amA_start').value = patterns.amA?.[0] || '';
  document.getElementById('amA_end').value = patterns.amA?.[1] || '';
  document.getElementById('amB_start').value = patterns.amB?.[0] || '';
  document.getElementById('amB_end').value = patterns.amB?.[1] || '';
  document.getElementById('pmA_start').value = patterns.pmA?.[0] || '';
  document.getElementById('pmA_end').value = patterns.pmA?.[1] || '';
  document.getElementById('pmB_start').value = patterns.pmB?.[0] || '';
  document.getElementById('pmB_end').value = patterns.pmB?.[1] || '';

  const dayState = scheduleState.days || {};
  days.forEach((d, i) => {
    const info = dayState[d] || {};
    const amSel = document.getElementById(`am_${i}`);
    const pmSel = document.getElementById(`pm_${i}`);
    if (amSel) amSel.value = info.am || '休診';
    if (pmSel) pmSel.value = info.pm || '休診';
  });
}

function readDepartmentMasterCache() {
  try {
    const raw = localStorage.getItem(DEPARTMENT_CACHE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (!Array.isArray(data.items) || typeof data.timestamp !== 'number') return null;
    if (Date.now() - data.timestamp > DEPARTMENT_CACHE_TTL) return null;
    return data.items;
  } catch (err) {
    console.warn('failed to read department master cache', err);
    return null;
  }
}

function writeDepartmentMasterCache(items) {
  try {
    localStorage.setItem(DEPARTMENT_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), items }));
  } catch (err) {
    console.warn('failed to write department master cache', err);
  }
}

function applyDepartmentMaster(items, { skipRenderWhenOpen = false } = {}) {
  departmentMaster = Array.isArray(items) ? items : [];
  const selectionOpen = departmentSelectionEl && !departmentSelectionEl.classList.contains('hidden');
  if (skipRenderWhenOpen && selectionOpen) {
    pendingDepartmentRender = true;
    return;
  }
  pendingDepartmentRender = false;
  renderDepartmentChecklist();
}

async function fetchDepartmentMaster({ silent = false, skipRenderWhenOpen = false } = {}) {
  try {
    const url = new URL(`${BASE}/api/listMaster`);
    url.searchParams.set('type', 'department');
    url.searchParams.set('status', 'approved');
    const res = await fetch(url.toString());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const collator = new Intl.Collator('ja');
    const items = ((data.ok ? data.items : []) || []).sort((a, b) => {
      const ao = typeof a.sortOrder === 'number' ? a.sortOrder : Number.MAX_SAFE_INTEGER;
      const bo = typeof b.sortOrder === 'number' ? b.sortOrder : Number.MAX_SAFE_INTEGER;
      if (ao !== bo) return ao - bo;
      const ag = a.sortGroup || '';
      const bg = b.sortGroup || '';
      const gcmp = collator.compare(ag, bg);
      if (gcmp !== 0) return gcmp;
      return collator.compare(a.name || '', b.name || '');
    });
    writeDepartmentMasterCache(items);
    applyDepartmentMaster(items, { skipRenderWhenOpen });
    return items;
  } catch (err) {
    if (!silent) {
      console.warn('failed to load department master', err);
      departmentMaster = [];
      renderDepartmentChecklist();
    }
    throw err;
  }
}

async function loadDepartmentMaster({ allowCache = true } = {}) {
  if (allowCache) {
    const cached = readDepartmentMasterCache();
    if (cached) {
      applyDepartmentMaster(cached, { skipRenderWhenOpen: false });
      fetchDepartmentMaster({ silent: true, skipRenderWhenOpen: true }).catch(err => {
        console.warn('background department master refresh failed', err);
      });
      return true;
    }
  }
  try {
    await fetchDepartmentMaster({ silent: false, skipRenderWhenOpen: false });
  } catch (err) {
    // already logged inside fetchDepartmentMaster
  }
  return false;
}

function updateDepartmentSummary() {
  const summaryWrap = document.getElementById("departmentSummaryWrap");
  const summaryEl = document.getElementById("departmentSummary");
  if (!summaryWrap || !summaryEl) return;

  const selectedCheckboxes = Array.from(document.querySelectorAll("input[name='deptMaster']:checked"));
  if (!selectedCheckboxes.length) {
    summaryEl.textContent = "";
    summaryWrap.classList.add("hidden");
    return;
  }

  const normalizeSet = new Set(selectedCheckboxes.map(cb => normalizeText(cb.value)));
  const orderedNames = departmentMaster
    .filter(item => normalizeSet.has(normalizeText(item.name)))
    .map(item => item.canonical_name || item.name)
    .filter(Boolean);

  const leftovers = selectedCheckboxes
    .map(cb => cb.value)
    .filter(val => !departmentMaster.some(item => normalizeText(item.name) === normalizeText(val)));

  const displayNames = orderedNames.concat(leftovers);
  summaryEl.textContent = displayNames.join("、");
  summaryWrap.classList.remove("hidden");
}

function showDepartmentSelection() {
  if (!departmentSelectionEl) return;
  departmentSelectionEl.classList.remove("hidden");
  departmentSelectionEl.setAttribute("aria-hidden", "false");
  if (departmentToggleBtnEl) {
    departmentToggleBtnEl.setAttribute("aria-expanded", "true");
  }
  const firstInput = departmentSelectionEl.querySelector("input[name='deptMaster']");
  if (firstInput) {
    firstInput.focus();
  }
}

function hideDepartmentSelection() {
  if (!departmentSelectionEl) return;
  departmentSelectionEl.classList.add("hidden");
  departmentSelectionEl.setAttribute("aria-hidden", "true");
  if (departmentToggleBtnEl) {
    departmentToggleBtnEl.setAttribute("aria-expanded", "false");
  }
  if (pendingDepartmentRender) {
    renderDepartmentChecklist();
    pendingDepartmentRender = false;
  } else {
    updateDepartmentSummary();
  }
}

function initDepartmentSelectionUI() {
  departmentSelectionEl = document.getElementById("departmentSelection");
  departmentToggleBtnEl = document.getElementById("departmentToggleBtn");
  const doneBtn = document.getElementById("departmentSelectionDone");

  if (departmentSelectionEl) {
    departmentSelectionEl.setAttribute("aria-hidden", "true");
  }

  if (departmentToggleBtnEl) {
    departmentToggleBtnEl.setAttribute("aria-expanded", "false");
    departmentToggleBtnEl.addEventListener("click", () => {
      showDepartmentSelection();
      departmentSelectionEl?.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  }

  if (doneBtn) {
    doneBtn.addEventListener("click", () => {
      hideDepartmentSelection();
      departmentToggleBtnEl?.focus();
    });
  }
}

function showScheduleEditor() {
  if (!scheduleEditPanelEl) return;
  scheduleEditPanelEl.classList.remove('hidden');
  scheduleEditPanelEl.setAttribute('aria-hidden', 'false');
  if (scheduleToggleBtnEl) {
    scheduleToggleBtnEl.setAttribute('aria-expanded', 'true');
  }
  scheduleEditPanelEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideScheduleEditor() {
  if (!scheduleEditPanelEl) return;
  scheduleEditPanelEl.classList.add('hidden');
  scheduleEditPanelEl.setAttribute('aria-hidden', 'true');
  if (scheduleToggleBtnEl) {
    scheduleToggleBtnEl.setAttribute('aria-expanded', 'false');
    scheduleToggleBtnEl.focus();
  }
  scheduleState.patterns = sanitizePatterns(readScheduleFormPatterns());
  scheduleState.days = readScheduleFormDays();
  renderDisplay();
}

function initScheduleEditorUI() {
  scheduleEditPanelEl = document.getElementById('scheduleEditPanel');
  scheduleToggleBtnEl = document.getElementById('scheduleToggleBtn');
  scheduleDoneBtnEl = document.getElementById('scheduleEditDone');

  if (scheduleEditPanelEl) {
    scheduleEditPanelEl.setAttribute('aria-hidden', 'true');
  }

  if (scheduleToggleBtnEl) {
    scheduleToggleBtnEl.setAttribute('aria-expanded', 'false');
    scheduleToggleBtnEl.addEventListener('click', () => {
      showScheduleEditor();
    });
  }

  if (scheduleDoneBtnEl) {
    scheduleDoneBtnEl.addEventListener('click', () => {
      hideScheduleEditor();
    });
  }
}

function initTimeInputDefaults() {
  const ensureTimeDatalist = () => {
    const existing = document.getElementById('time-choices-5m');
    if (existing) return existing.id;
    const list = document.createElement('datalist');
    list.id = 'time-choices-5m';
    for (let total = 0; total < 24 * 60; total += TIME_STEP_MINUTES) {
      const hours = String(Math.floor(total / 60)).padStart(2, '0');
      const minutes = String(total % 60).padStart(2, '0');
      const option = document.createElement('option');
      option.value = `${hours}:${minutes}`;
      list.appendChild(option);
    }
    document.body.appendChild(list);
    return list.id;
  };

  const datalistId = ensureTimeDatalist();

  const snapToStep = value => {
    if (!value) return value;
    const parts = value.split(':');
    if (parts.length < 2) return value;
    const hours = Number.parseInt(parts[0], 10);
    const minutes = Number.parseInt(parts[1], 10);
    if (Number.isNaN(hours) || Number.isNaN(minutes)) return value;
    const total = hours * 60 + minutes;
    const snapped = Math.min(
      Math.round(total / TIME_STEP_MINUTES) * TIME_STEP_MINUTES,
      24 * 60 - TIME_STEP_MINUTES
    );
    const snappedHours = Math.floor(snapped / 60);
    const snappedMinutes = snapped % 60;
    return `${String(snappedHours).padStart(2, '0')}:${String(snappedMinutes).padStart(2, '0')}`;
  };

  const inputs = Array.from(document.querySelectorAll("input[type='time']"));
  inputs.forEach(input => {
    input.step = TIME_STEP_MINUTES * 60;
    input.setAttribute('list', datalistId);
    const id = input.id || '';
    const isAm = id.startsWith('am');
    const isPm = id.startsWith('pm');
    if (!isAm && !isPm) return;

    input.addEventListener('focus', () => {
      if (input.value) return;
      const defaults = isAm ? TIME_DEFAULTS.am : TIME_DEFAULTS.pm;
      const isStart = id.endsWith('_start');
      const fallback = defaults[isStart ? 'start' : 'end'];
      if (!fallback) return;
      input.value = fallback;
      if (typeof input.setSelectionRange === 'function') {
        try {
          input.setSelectionRange(0, fallback.length);
        } catch (err) {
          // Some browsers prevent selection on time inputs; ignore.
        }
      }
    });

    const handleSnap = () => {
      const snapped = snapToStep(input.value);
      if (snapped && snapped !== input.value) {
        input.value = snapped;
      }
    };

    input.addEventListener('change', handleSnap);
    input.addEventListener('blur', handleSnap);
    handleSnap();
  });
}

async function fetchAddressForPostalCode(zipDigits) {
  const url = new URL(ZIP_LOOKUP_ENDPOINT);
  url.searchParams.set('zipcode', zipDigits);
  const res = await fetch(url.toString());
  if (!res.ok) {
    throw new Error(`郵便番号検索に失敗しました (HTTP ${res.status})`);
  }
  const data = await res.json();
  if (data?.status !== 200 || !Array.isArray(data?.results) || !data.results.length) {
    throw new Error(data?.message || '該当する住所が見つかりませんでした');
  }
  const result = data.results[0];
  return `${result.address1 || ''}${result.address2 || ''}${result.address3 || ''}`.trim();
}

async function tryAutoFillAddress({ force = false } = {}) {
  const postalInput = document.getElementById('clinicPostalCode');
  const addressInput = document.getElementById('clinicAddress');
  if (!postalInput || !addressInput) return;

  const digits = normalizePostalCode(postalInput.value);
  if (digits.length !== 7) {
    if (force && digits.length > 0) {
      alert('郵便番号は7桁で入力してください');
    }
    latestPostalLookup = '';
    return;
  }

  if (!force && latestPostalLookup === digits) {
    return;
  }

  try {
    const address = await fetchAddressForPostalCode(digits);
    if (address && address !== addressInput.value) {
      withDirtySuppressed(() => {
        addressInput.value = address;
      });
      markDirty();
    }
    latestPostalLookup = digits;
  } catch (err) {
    latestPostalLookup = '';
    if (force) {
      alert(err.message || '郵便番号から住所を取得できませんでした');
    }
  }
}

function initPostalCodeField() {
  const postalInput = document.getElementById('clinicPostalCode');
  if (!postalInput) return;

  const updateValue = () => {
    const formatted = formatPostalCode(postalInput.value);
    if (postalInput.value !== formatted) {
      postalInput.value = formatted;
    }
  };

  postalInput.addEventListener('input', () => {
    updateValue();
    const digits = normalizePostalCode(postalInput.value);
    if (digits.length === 7) {
      tryAutoFillAddress({ force: false });
    } else {
      latestPostalLookup = '';
    }
    markDirty();
  });

  postalInput.addEventListener('blur', () => {
    updateValue();
    tryAutoFillAddress({ force: true });
    if (postalInput.value) {
      markDirty();
    }
  });

  postalInput.value = formatPostalCode(postalInput.value);
}

function renderDepartmentChecklist(selectedNames) {
  const container = document.getElementById("departmentOptions");
  if (!container) return;
  const existingChecked = Array.from(container.querySelectorAll("input[name='deptMaster']:checked")).map(el => el.value);
  let namesToUse;
  if (Array.isArray(selectedNames)) {
    namesToUse = selectedNames;
  } else if (typeof selectedNames === 'string' && selectedNames) {
    namesToUse = [selectedNames];
  }
  if (!Array.isArray(namesToUse)) {
    namesToUse = existingChecked;
  }
  container.innerHTML = "";

  if (!departmentMaster.length) {
    container.innerHTML = '<p class="text-sm text-gray-500">承認済みの標榜診療科がまだ登録されていません。</p>';
    updateDepartmentSummary();
    return;
  }

  const selectedSet = new Set((namesToUse || []).map(s => normalizeText(s)));
  let currentGroup = null;
  let groupBlock = null;
  let listWrap = null;

  departmentMaster.forEach(item => {
    const value = item.name || "";
    const display = item.canonical_name || item.name || "";
    const group = item.sortGroup || 'その他';
    const isChecked = selectedSet.has(normalizeText(item.name)) || selectedSet.has(normalizeText(item.canonical_name));

    if (group !== currentGroup) {
      currentGroup = group;

      groupBlock = document.createElement('div');
      groupBlock.className = 'space-y-3';

      const heading = document.createElement('div');
      heading.className = 'text-sm font-semibold text-gray-700';
      heading.textContent = currentGroup;
      groupBlock.appendChild(heading);

      listWrap = document.createElement('div');
      listWrap.className = 'grid gap-2 grid-cols-1 sm:grid-cols-2';
      groupBlock.appendChild(listWrap);

      container.appendChild(groupBlock);
    }

    const wrapper = document.createElement('label');
    wrapper.className = 'flex items-center gap-2 rounded border px-3 py-2 text-sm text-gray-700 bg-gray-50 hover:bg-gray-100';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'deptMaster';
    checkbox.value = value;
    checkbox.className = 'h-4 w-4';
    checkbox.checked = isChecked;

    const text = document.createElement('span');
    text.textContent = display;

    wrapper.appendChild(checkbox);
    wrapper.appendChild(text);
    listWrap.appendChild(wrapper);
  });

  // container uses space-y to manage separation, so no divider needed
  Array.from(container.querySelectorAll("input[name='deptMaster']")).forEach(cb => {
    cb.addEventListener("change", updateDepartmentSummary);
  });
  updateDepartmentSummary();
}

function parseDepartments(raw) {
  if (!raw) return { master: [], others: [] };
  if (Array.isArray(raw)) return { master: raw, others: [] };
  if (typeof raw === 'object') {
    const master = Array.isArray(raw.master) ? raw.master : Array.isArray(raw.standard) ? raw.standard : [];
    const others = Array.isArray(raw.others) ? raw.others : [];
    return { master, others };
  }
  return { master: [], others: [] };
}

async function registerDepartmentCandidates(names) {
  if (!names?.length) return;
  const unique = Array.from(new Set(names.map(normalizeText))).filter(Boolean);
  const existing = departmentMaster.map(it => normalizeText(it.name)).concat(departmentMaster.map(it => normalizeText(it.canonical_name))); 
  const targets = unique.filter(name => !existing.includes(name));
  if (!targets.length) return;
  await Promise.allSettled(targets.map(name =>
    fetch(`${BASE}/api/addMasterItem`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "department", category: DEPARTMENT_CATEGORY, name, source: "clinicDetail" })
    })
  ));
}

function updateHomepageField() {
  const show = document.querySelector("input[name='homepageStatus']:checked")?.value === "available";
  const field = document.getElementById("homepageUrl");
  if (field) {
    field.classList.toggle("hidden", !show);
  }
}

function updateReservationField() {
  const show = document.querySelector("input[name='reservationStatus']:checked")?.value === "available";
  const field = document.getElementById("reservationUrl");
  if (field) {
    field.classList.toggle("hidden", !show);
  }
}

document.querySelectorAll("input[name='homepageStatus']").forEach(r => r.addEventListener("change", updateHomepageField));
document.querySelectorAll("input[name='reservationStatus']").forEach(r => r.addEventListener("change", updateReservationField));
updateHomepageField();
updateReservationField();

document.addEventListener('input', handlePotentialDirty, true);
document.addEventListener('change', handlePotentialDirty, true);
document.addEventListener('click', handleNavigationAttempt, true);

window.addEventListener('beforeunload', event => {
  if (!isDirty) return;
  event.preventDefault();
  event.returnValue = UNSAVED_WARNING_MESSAGE;
});

function initScheduleTable(){
  const tbody = document.getElementById("scheduleBody");
  tbody.innerHTML = "";
  days.forEach((d,i)=>{
    tbody.innerHTML += `
      <tr>
        <td class="border px-2 py-1 text-center">${d}</td>
        <td class="border px-2 py-1 text-center">
          <select id="am_${i}" class="border rounded px-2 py-1">
            <option selected>休診</option>
            <option>午前A</option>
            <option>午前B</option>
          </select>
        </td>
        <td class="border px-2 py-1 text-center">
          <select id="pm_${i}" class="border rounded px-2 py-1">
            <option selected>休診</option>
            <option>午後A</option>
            <option>午後B</option>
          </select>
        </td>
      </tr>`;
  });
}
initScheduleTable();

function savePatterns(){
  scheduleState.patterns = sanitizePatterns(readScheduleFormPatterns());
  renderDisplay();
  alert("診療時間パターンを保存しました");
  markDirty();
}

function applyAll(type){
  const target = type==="am" ? "午前A" : "午後A";
  days.forEach((d,i)=>{
    document.getElementById(type+"_"+i).value = target;
  });
  markDirty();
}

function saveSchedule(){
  scheduleState.days = readScheduleFormDays();
  renderDisplay();
  markDirty();
}

function renderDisplay(){
  const display = document.getElementById("displayBody");
  if (!display) return;
  display.innerHTML = "";
  const patterns = scheduleState.patterns || createEmptyPatterns();
  const schedule = scheduleState.days || {};

  days.forEach(d=>{
    const am = schedule[d]?.am || "休診";
    const pm = schedule[d]?.pm || "休診";
    display.innerHTML += `
      <tr>
        <td class="border px-2 py-1 text-center">${d}</td>
        <td class="border px-2 py-1 text-center">${getTimeText(am, patterns)}</td>
        <td class="border px-2 py-1 text-center">${getTimeText(pm, patterns)}</td>
      </tr>`;
  });
}

function getTimeText(sel, patterns){
  const formatRange = (range) => {
    if (!Array.isArray(range)) return '';
    const [start, end] = range;
    if (!start && !end) return '未設定';
    if (start && end) return `${start}～${end}`;
    return start || end || '未設定';
  };

  switch(sel){
    case "午前A": return formatRange(patterns.amA);
    case "午前B": return formatRange(patterns.amB);
    case "午後A": return formatRange(patterns.pmA);
    case "午後B": return formatRange(patterns.pmB);
    case "休診": return "休診";
    default: return sel || '';
  }
}

async function saveClinic() {
  const name       = document.getElementById("clinicName").value.trim();
  const postalCode = formatPostalCode(document.getElementById("clinicPostalCode").value);
  const address    = document.getElementById("clinicAddress").value.trim();
  const phone      = document.getElementById("clinicPhone").value.trim();
  const fax        = document.getElementById("clinicFax").value.trim();
  const fulltime   = document.getElementById("numFulltime").value;
  const parttime   = document.getElementById("numParttime").value;

  if (!name) {
    alert("名称を入力してください。");
    return;
  }

  const selectedDeptMaster = Array.from(document.querySelectorAll("input[name='deptMaster']:checked"))
    .map(el => el.value)
    .filter(Boolean);
  const selectedDeptSet = new Set(selectedDeptMaster.map(normalizeText));
  const otherDeptInput = document.getElementById("departmentOthers").value.split(/\n+/)
    .map(normalizeText)
    .filter(Boolean);
  const uniqueOtherDept = Array.from(new Set(otherDeptInput))
    .filter(name => !selectedDeptSet.has(normalizeText(name)));

  const homepageStatus = document.querySelector("input[name='homepageStatus']:checked")?.value || "none";
  const reservationStatus = document.querySelector("input[name='reservationStatus']:checked")?.value || "none";
  const homepageUrlInput = document.getElementById("homepageUrl").value.trim();
  const reservationUrlInput = document.getElementById("reservationUrl").value.trim();

  const hasHomepage = homepageStatus === "available";
  const homepageUrl = hasHomepage ? homepageUrlInput : "";
  if (hasHomepage && !homepageUrl) {
    alert("ホームページURLを入力してください。");
    return;
  }

  const hasReservation = reservationStatus === "available";
  const reservationUrl = hasReservation ? reservationUrlInput : "";
  if (hasReservation && !reservationUrl) {
    alert("予約サイトのURLを入力してください。");
    return;
  }

  scheduleState.patterns = sanitizePatterns(readScheduleFormPatterns());
  scheduleState.days = readScheduleFormDays();
  renderDisplay();

  const clinicData = {
    id: currentClinicId,
    name,
    postalCode,
    address,
    phone,
    fax,
    doctors: {
      fulltime: Number(fulltime||0),
      parttime: Number(parttime||0),
      qualifications: retainedQualifications || ""
    },
    schedule: { patterns: scheduleState.patterns, days: scheduleState.days },
    homepage: { available: hasHomepage, url: homepageUrl },
    reservation: { available: hasReservation, url: reservationUrl },
    departments: {
      master: selectedDeptMaster,
      others: uniqueOtherDept
    }
  };

  try {
    const res = await fetch(`${BASE}/api/updateClinic`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(clinicData)
    });
    if (!res.ok) throw new Error("API更新エラー");

    const result = await res.json();
    localStorage.setItem("selectedClinic", JSON.stringify(result.clinic));
    alert("診療所データを更新しました");
    await registerDepartmentCandidates(uniqueOtherDept);
    resetDirtyState();
  } catch (err) {
    alert("保存に失敗しました: " + err.message);
    console.error(err);
  }
}

// 選択済み施設から初期値ロード
function loadClinicDetail() {
  const stored = localStorage.getItem("selectedClinic");
  if (!stored) {
    withDirtySuppressed(() => {
      scheduleState.patterns = createEmptyPatterns();
      scheduleState.days = {};
      applyScheduleStateToForm();
      renderDisplay();
    });
    latestPostalLookup = '';
    resetDirtyState();
    return;
  }

  const clinic = JSON.parse(stored);
  const loadedPostal = formatPostalCode(clinic.postalCode || '');
  withDirtySuppressed(() => {
    currentClinicId = clinic.id || "";
    retainedQualifications = clinic.doctors?.qualifications || "";

    document.getElementById("clinicName").value      = clinic.name || "";
    document.getElementById("clinicPostalCode").value = loadedPostal;
    document.getElementById("clinicAddress").value   = clinic.address || "";
    document.getElementById("clinicPhone").value     = clinic.phone || "";
    document.getElementById("clinicFax").value       = clinic.fax || "";
    document.getElementById("numFulltime").value     = clinic.doctors?.fulltime || "";
    document.getElementById("numParttime").value     = clinic.doctors?.parttime || "";

    const homepageData = clinic.homepage || {};
    const homepageAvailable = typeof homepageData.available === "boolean" ? homepageData.available : Boolean(homepageData.url);
    const homepageTarget = document.querySelector(`input[name='homepageStatus'][value='${homepageAvailable ? "available" : "none"}']`);
    if (homepageTarget) homepageTarget.checked = true;
    document.getElementById("homepageUrl").value = homepageData.url || "";
    updateHomepageField();

    const reservationData = clinic.reservation || {};
    const reservationAvailable = typeof reservationData.available === "boolean" ? reservationData.available : Boolean(reservationData.url);
    const reservationTarget = document.querySelector(`input[name='reservationStatus'][value='${reservationAvailable ? "available" : "none"}']`);
    if (reservationTarget) reservationTarget.checked = true;
    document.getElementById("reservationUrl").value = reservationData.url || "";
    updateReservationField();

    const deptState = parseDepartments(clinic.departments);
    renderDepartmentChecklist(deptState.master);
    document.getElementById("departmentOthers").value = deptState.others.join("\n");

    scheduleState.patterns = sanitizePatterns(clinic.schedule?.patterns);
    scheduleState.days = sanitizeScheduleDays(clinic.schedule?.days);
    applyScheduleStateToForm();
    renderDisplay();
  });

  latestPostalLookup = normalizePostalCode(loadedPostal);
  resetDirtyState();
}

window.addEventListener("DOMContentLoaded", async () => {
  toggleLoadingOverlay(true);
  try {
    initDepartmentSelectionUI();
    initScheduleEditorUI();
    initTimeInputDefaults();
    initPostalCodeField();
    await loadDepartmentMaster();
    loadClinicDetail();
  } finally {
    toggleLoadingOverlay(false);
  }
});
</script>
</body>
</html>
