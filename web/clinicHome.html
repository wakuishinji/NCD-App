<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>施設ホーム - NCD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  
<script>window.NCD_CF_ENV=window.__CF_PAGES_ENV||(window.__CF_PAGES_ENV?{NCD_API_BASE:window.__CF_PAGES_ENV.NCD_API_BASE,ENV_LABEL:window.__CF_PAGES_ENV.ENV_LABEL}:{NCD_API_BASE:'https://ncd-app.altry.workers.dev',ENV_LABEL:'production'});</script>
<script src="js/env.js"></script>

  <script src="js/auth.js" defer></script>
  <script src="js/loading.js" defer></script>
  <script src="js/userMenu.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- ヘッダー -->
  <header class="sticky top-0 z-40 bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-5xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex flex-wrap items-center gap-2 text-sm font-semibold">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 transition hover:bg-white/30">Top</a>
      </div>
      <h1 class="text-lg md:text-xl font-bold text-center text-white md:text-left md:flex-1">施設ホーム</h1>
      <div class="flex items-center gap-2">
        <a href="clinicList.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30 whitespace-nowrap">施設選択へ</a>
        <div class="relative" data-user-menu data-user-menu-variant="dark"></div>
      </div>
    </div>
  </header>

  <!-- メイン -->
  <main class="flex-1 max-w-5xl mx-auto p-4 md:p-6 space-y-4">
    <div id="loginNotice" class="hidden rounded border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-800">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="font-semibold">この施設の編集には管理者ログインが必要です。</p>
          <p class="mt-1 text-xs md:text-sm">招待メールで届けられたアカウントでログインすると編集が有効になります。</p>
          <p class="mt-2 text-xs md:text-sm text-amber-700">
            招待を受け取っていない場合は
            <a href="/auth/request-admin.html" class="font-semibold text-blue-700 underline decoration-blue-400 hover:text-blue-800">管理者権限の申請</a>
            から手続きを行ってください。
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button id="loginNoticeToggle" type="button" class="rounded bg-blue-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-blue-700">ログインフォームを表示</button>
        </div>
      </div>
      <form id="loginInlineForm" class="mt-3 hidden space-y-2 rounded border border-amber-200 bg-white/90 px-3 py-3 text-slate-700">
        <div class="flex flex-col gap-1">
          <label for="loginInlineEmail" class="text-xs font-semibold text-slate-600">メールアドレス</label>
          <input id="loginInlineEmail" type="email" class="rounded border border-slate-300 px-2 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="manager@example.com" required />
        </div>
        <div class="flex flex-col gap-1">
          <label for="loginInlinePassword" class="text-xs font-semibold text-slate-600">パスワード</label>
          <input id="loginInlinePassword" type="password" class="rounded border border-slate-300 px-2 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="********" required />
        </div>
        <div class="flex items-center justify-between">
          <label class="inline-flex items-center gap-2 text-xs text-slate-600">
            <input id="loginInlineRemember" type="checkbox" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500" checked />
            ログイン状態を保持する
          </label>
          <a href="/auth/request-reset.html" class="text-xs text-blue-600 underline hover:text-blue-700">パスワードをお忘れの場合</a>
        </div>
        <div class="flex items-center gap-2">
          <button type="submit" id="loginInlineSubmit" class="inline-flex items-center gap-2 rounded bg-blue-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-blue-700">ログイン</button>
          <button type="button" id="loginInlineCancel" class="rounded border border-slate-300 px-3 py-2 text-xs text-slate-600 hover:bg-slate-100">閉じる</button>
          <span id="loginInlineStatus" class="text-xs text-amber-700"></span>
        </div>
      </form>
    </div>
    <div class="flex flex-col gap-6 md:flex-row md:items-start">
      <section class="md:w-80 md:flex-none">
        <div class="bg-white rounded shadow p-6 md:sticky md:top-6 md:z-10">
          <div class="text-gray-500 text-sm mb-2">選択中の施設</div>
          <div id="clinicName" class="text-2xl font-bold text-blue-800">-</div>
          <div id="clinicId" class="text-xs text-gray-500 mt-1">ID: -</div>
          <div id="clinicAddr" class="text-sm text-gray-700 mt-2">住所: -</div>
        </div>
      </section>

      <section class="flex-1 grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        <a id="clinicSummaryLink" href="#" data-base-href="clinicSummary.html" class="bg-white rounded shadow p-6 hover:shadow-lg transition pointer-events-none opacity-60" data-disabled="true">
          <div class="text-lg font-semibold text-blue-800 mb-2">公開ページを表示</div>
          <div class="text-sm text-gray-600">別タブで施設サマリーページを開きます。施設を選択すると有効になります。</div>
        </a>
        <a href="clinicDetail.html" data-base-href="clinicDetail.html" data-clinic-link class="bg-white rounded shadow p-6 hover:shadow-lg transition pointer-events-none opacity-60" data-disabled="true">
          <div class="text-lg font-semibold text-blue-800 mb-2">基本情報入力</div>
          <div class="text-sm text-gray-600">名称・住所・医師数・診療時間パターン/曜日設定など。</div>
        </a>
        <a href="clinicQualifications.html" data-base-href="clinicQualifications.html" data-clinic-link class="bg-white rounded shadow p-6 hover:shadow-lg transition pointer-events-none opacity-60" data-disabled="true">
          <div class="text-lg font-semibold text-blue-800 mb-2">保有資格入力</div>
          <div class="text-sm text-gray-600">在籍医師の専門医資格・認定等を登録し、施設の強みとして整理します。</div>
        </a>
        <a href="clinicTests.html" data-base-href="clinicTests.html" data-clinic-link class="bg-white rounded shadow p-6 hover:shadow-lg transition pointer-events-none opacity-60" data-disabled="true">
          <div class="text-lg font-semibold text-blue-800 mb-2">可能な検査入力</div>
          <div class="text-sm text-gray-600">分類（〜検査）を選んで名称・説明を登録。マスターに自動集計。</div>
        </a>
        <a href="clinicServices.html" data-base-href="clinicServices.html" data-clinic-link class="bg-white rounded shadow p-6 hover:shadow-lg transition pointer-events-none opacity-60" data-disabled="true">
          <div class="text-lg font-semibold text-blue-800 mb-2">可能な診療入力</div>
          <div class="text-sm text-gray-600">診療科系分類を選んで名称・説明を登録。マスターに自動集計。</div>
        </a>

        <!-- 管理者カード -->
        <div class="bg-white rounded shadow p-6 hover:shadow-lg transition">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-lg font-semibold text-blue-800">施設管理者の設定</div>
              <div class="text-xs text-gray-500">管理者の招待・承認は自治体管理画面で実施します。</div>
            </div>
          </div>
          <div class="space-y-2 text-sm text-gray-700">
            <p>施設管理者を付与したい場合は、中野区医師会の自治体管理画面から申請の承認または招待を行ってください。</p>
            <a href="/admin/municipalityHub.html" class="inline-flex items-center gap-2 rounded bg-blue-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-blue-700">
              自治体管理ハブを開く
            </a>
          </div>
        </div>

        <!-- スタッフ招待カード -->
        <div id="staffCard" class="bg-white rounded shadow p-6 hover:shadow-lg transition pointer-events-none opacity-60" data-disabled="true">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-lg font-semibold text-blue-800">スタッフアカウントの招待</div>
              <div class="text-xs text-gray-500">施設管理者または許可されたユーザーがスタッフを招待できます。</div>
            </div>
            <button type="button" id="staffInviteButton" class="hidden rounded bg-blue-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-blue-700">スタッフを招待</button>
          </div>
          <div id="staffInfo" class="space-y-2 text-sm text-gray-700">
            <div>スタッフ招待を利用するには施設管理者の設定が必要です。</div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- フッター -->
  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
    <div class="mt-2 flex items-center justify-center gap-4 text-sm">
      <a href="/terms.html" class="text-blue-600 underline hover:text-blue-700">利用規約</a>
      <a href="/privacy.html" class="text-blue-600 underline hover:text-blue-700">プライバシーポリシー</a>
    </div>
  </footer>

  <script>
    function buildClinicLink(baseHref, clinic) {
      if (!baseHref) return '#';
      const [pathAndQuery, hash] = baseHref.split('#');
      const [path, queryString] = pathAndQuery.split('?');
      const params = new URLSearchParams(queryString || '');
      if (clinic && clinic.id) {
        params.set('id', clinic.id);
      } else {
        params.delete('id');
      }
      if (clinic && clinic.name) {
        params.set('name', clinic.name);
      } else {
        params.delete('name');
      }
      const query = params.toString();
      let result = path || 'clinicDetail.html';
      if (query) {
        result += `?${query}`;
      }
      if (hash) {
        result += `#${hash}`;
      }
      return result;
    }

    function updateSummaryLink(clinic) {
      const link = document.getElementById('clinicSummaryLink');
      if (!link) return;
      const baseHref = link.dataset.baseHref || 'clinicSummary.html';
      if (clinic && clinic.id) {
        link.href = buildClinicLink(baseHref, clinic);
        link.target = '_blank';
        link.rel = 'noopener';
        link.classList.remove('pointer-events-none', 'opacity-60');
        link.dataset.disabled = 'false';
      } else {
        link.href = '#';
        link.removeAttribute('target');
        link.removeAttribute('rel');
        link.classList.add('pointer-events-none', 'opacity-60');
        link.dataset.disabled = 'true';
      }
    }

    const loginNotice = document.getElementById('loginNotice');
    const loginToggle = document.getElementById('loginNoticeToggle');
    const loginForm = document.getElementById('loginInlineForm');
    const loginEmailInput = document.getElementById('loginInlineEmail');
    const loginPasswordInput = document.getElementById('loginInlinePassword');
    const loginRememberInput = document.getElementById('loginInlineRemember');
    const loginSubmitButton = document.getElementById('loginInlineSubmit');
    const loginCancelButton = document.getElementById('loginInlineCancel');
    const loginStatus = document.getElementById('loginInlineStatus');
    let currentClinicDetail = null;

    function setLoginStatus(message, type = 'info') {
      if (!loginStatus) return;
      let colorClass = 'text-amber-700';
      if (type === 'error') {
        colorClass = 'text-red-600';
      } else if (type === 'success') {
        colorClass = 'text-emerald-600';
      }
      loginStatus.textContent = message || '';
      loginStatus.className = `text-xs ${colorClass}`;
    }

    function toggleLoginForm(visible) {
      if (!loginForm) return;
      if (visible) {
        loginForm.classList.remove('hidden');
        setLoginStatus('');
        if (loginEmailInput) {
          loginEmailInput.focus();
        }
      } else {
        loginForm.classList.add('hidden');
        setLoginStatus('');
      }
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function getStoredAuth() {
      if (!window.NcdAuth || typeof window.NcdAuth.getStoredAuth !== 'function') {
        return null;
      }
      try {
        return window.NcdAuth.getStoredAuth();
      } catch (_) {
        return null;
      }
    }

    function roleAllowsGlobalEdit(role) {
      if (!role || !window.NcdAuth || typeof window.NcdAuth.roleIncludes !== 'function') {
        return false;
      }
      return window.NcdAuth.roleIncludes(role, 'systemRoot') || window.NcdAuth.roleIncludes(role, 'systemAdmin');
    }

    function hasClinicEditAccess(clinic) {
      if (!clinic || !clinic.id) return false;
      const managers = Array.isArray(clinic.managerAccounts) ? clinic.managerAccounts : [];
      // 管理者未設定の施設は従来通り誰でも編集可能
      if (!managers.length) return true;
      const auth = getStoredAuth();
      if (!auth || !auth.tokens || !auth.tokens.accessToken) {
        return false;
      }
      const role = window.NcdAuth?.getCurrentRole?.(auth);
      if (roleAllowsGlobalEdit(role)) return true;
      const accountId = auth?.account?.id;
      if (accountId && managers.includes(accountId)) return true;
      if (window.NcdAuth && typeof window.NcdAuth.hasClinicRole === 'function') {
        if (window.NcdAuth.hasClinicRole(clinic.id, 'clinicAdmin', { auth })) {
          return true;
        }
        if (window.NcdAuth.hasClinicRole(clinic.id, 'clinicStaff', { auth })) {
          return true;
        }
      } else {
        // 旧実装との互換用フォールバック
        const membershipIds = Array.isArray(auth?.account?.membershipIds) ? auth.account.membershipIds : [];
        const staffMemberships = Array.isArray(clinic.staffMemberships) ? clinic.staffMemberships : [];
        if (membershipIds.some((id) => staffMemberships.includes(id))) return true;
      }
      return false;
    }

    function updateLoginNotice(clinic, canEdit) {
      if (!loginNotice) return;
      const requiresLogin = Boolean(
        clinic && clinic.id && Array.isArray(clinic.managerAccounts) && clinic.managerAccounts.length && !canEdit
      );
      console.debug('[clinicHome] updateLoginNotice', { requiresLogin, canEdit, managers: clinic?.managerAccounts });
      if (requiresLogin) {
        console.log('[clinicHome] showing login notice');
        loginNotice.classList.remove('hidden');
      } else {
        console.log('[clinicHome] hiding login notice', { canEdit });
        loginNotice.classList.add('hidden');
        toggleLoginForm(false);
      }
    }

    async function performInlineLogin(event) {
      event.preventDefault();
      if (!loginSubmitButton) return;
      if (!loginEmailInput || !loginPasswordInput) return;
      const identifier = (loginEmailInput.value || '').trim();
      const password = loginPasswordInput.value || '';
      const remember = loginRememberInput ? loginRememberInput.checked : true;
      if (!identifier || !password) {
        setLoginStatus('メールアドレスとパスワードを入力してください。', 'error');
        return;
      }
      loginSubmitButton.disabled = true;
      setLoginStatus('認証中…', 'info');
      try {
        const res = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, password, remember }),
        });
        let payload = null;
        try {
          payload = await res.json();
        } catch (_) {
          payload = null;
        }
        if (!res.ok || !payload || payload.ok !== true) {
          const message = payload?.message || 'ログインに失敗しました。ID またはパスワードをご確認ください。';
          setLoginStatus(message, 'error');
          loginSubmitButton.disabled = false;
          return;
        }
        if (window.NcdAuth && typeof window.NcdAuth.saveAuth === 'function') {
          window.NcdAuth.saveAuth(payload);
        }
        setLoginStatus('ログインしました。権限を更新しています…', 'success');
        toggleLoginForm(false);
      } catch (error) {
        console.error('[clinicHome] inline login failed', error);
        setLoginStatus('ネットワークエラーが発生しました。時間をおいて再試行してください。', 'error');
      }
      loginSubmitButton.disabled = false;
    }

    if (loginToggle) {
      loginToggle.addEventListener('click', () => {
        const shouldOpen = loginForm ? loginForm.classList.contains('hidden') : false;
        toggleLoginForm(shouldOpen);
      });
    }
    if (loginCancelButton) {
      loginCancelButton.addEventListener('click', () => toggleLoginForm(false));
    }
    if (loginForm) {
      loginForm.addEventListener('submit', performInlineLogin);
    }

    document.addEventListener('ncd:auth-login-request', () => {
      if (loginNotice) {
        loginNotice.classList.remove('hidden');
        loginNotice.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      toggleLoginForm(true);
    });

    document.addEventListener('ncd:auth-changed', (event) => {
      const reason = event?.detail?.reason || 'update';
      const clinicId = currentClinicDetail?.id || window.selectedClinicId || null;
      const clinic = currentClinicDetail;
      const canEdit = clinic ? hasClinicEditAccess(clinic) : false;
      updateLoginNotice(clinic, canEdit);
      if (clinicId && reason !== 'refresh') {
        refreshClinicDetails(clinicId);
      } else if (!clinicId) {
        updateActionLinks(null, { canEdit: false });
        updateStaffSection(null);
      }
    });

    function updateActionLinks(clinic, options = {}) {
      const canEdit = options.canEdit !== false;
      const links = document.querySelectorAll('[data-clinic-link]');
      links.forEach((link) => {
        const baseHref = link.dataset.baseHref || link.getAttribute('href') || '#';
        link.dataset.baseHref = baseHref;
        if (clinic && clinic.id) {
          link.href = buildClinicLink(baseHref, clinic);
          if (canEdit) {
            link.classList.remove('pointer-events-none', 'opacity-60');
            link.removeAttribute('aria-disabled');
            link.removeAttribute('title');
            link.dataset.disabled = 'false';
          } else {
            link.classList.add('pointer-events-none', 'opacity-60');
            link.dataset.disabled = 'true';
            link.setAttribute('aria-disabled', 'true');
            link.title = '管理者としてログインすると編集できます。';
          }
        } else {
          link.href = '#';
          link.classList.add('pointer-events-none', 'opacity-60');
          link.dataset.disabled = 'true';
          link.setAttribute('aria-disabled', 'true');
        }
      });
    }

    function loadSelected() {
      const s = localStorage.getItem('selectedClinic');
      if (!s) {
        updateSummaryLink(null);
        updateActionLinks(null);
        currentClinicDetail = null;
        return;
      }
      const c = JSON.parse(s);
      document.getElementById('clinicName').textContent = c.name || '(名称未設定)';
      document.getElementById('clinicId').textContent = "ID: " + (c.id || '-');
      document.getElementById('clinicAddr').textContent = "住所: " + (c.address || '-');
      updateSummaryLink(c);
      updateActionLinks(c, { canEdit: false });
      updateLoginNotice(null, true);
      window.selectedClinicId = c.id;
      refreshClinicDetails(c.id);
    }

    const API_BASE = (function resolveApiBase() {
      if (window.NcdAuth && typeof window.NcdAuth.resolveApiBase === 'function') {
        return window.NcdAuth.resolveApiBase();
      }
      try {
        const override = localStorage.getItem('ncdApiBase') || localStorage.getItem('ncdApiBaseUrl');
        if (override) return override.replace(/\/$/, '');
      } catch (_) {}
      return 'https://ncd-app.altry.workers.dev';
    }());

    const AUTH_TIMEOUT_MESSAGE = '権限の有効期限が切れています。再度ログインしてから操作してください。';

    async function maybeGetAuthHeader() {
      if (!window.NcdAuth || typeof window.NcdAuth.getAuthHeader !== 'function') {
        return undefined;
      }
      try {
        return await window.NcdAuth.getAuthHeader({ optional: true });
      } catch (_) {
        return undefined;
      }
    }

    async function fetchClinicDetail(id) {
      const headers = { 'Content-Type': 'application/json' };
      const authHeader = await maybeGetAuthHeader();
      if (authHeader) {
        headers.Authorization = authHeader;
      }
      const res = await fetch(`${API_BASE}/api/clinicDetail?id=${encodeURIComponent(id)}`, { headers });
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      return res.json();
    }

    async function refreshClinicDetails(id) {
      if (!id) return;
      const panel = document.getElementById('clinicSummaryLink');
      try {
        await wrapWithLoading(async () => {
          const data = await fetchClinicDetail(id);
          const clinic = data?.clinic || {};
          const canEdit = hasClinicEditAccess(clinic);
          currentClinicDetail = clinic;
          updateActionLinks(clinic, { canEdit });
          updateStaffSection(clinic, { canEdit });
          updateLoginNotice(clinic, canEdit);
        }, '施設情報を取得中...', panel);
      } catch (err) {
        console.error('failed to fetch clinic detail', err);
        currentClinicDetail = null;
        updateStaffSection(null);
        updateActionLinks(null, { canEdit: false });
        updateLoginNotice(null, false);
      }
    }

    function updateStaffSection(clinic, options = {}) {
      const canEdit = options.canEdit !== false;
      const card = document.getElementById('staffCard');
      const info = document.getElementById('staffInfo');
      const inviteButton = document.getElementById('staffInviteButton');
      if (!card || !info || !inviteButton) return;

      if (!clinic || !clinic.id) {
        card.classList.add('pointer-events-none', 'opacity-60');
        inviteButton.classList.add('hidden');
        info.innerHTML = '<div>スタッフ招待を利用するには施設を選択してください。</div>';
        return;
      }

      const managers = Array.isArray(clinic.managerAccounts) ? clinic.managerAccounts : [];
      const isAdmin = managers.length > 0;
      card.classList.add('pointer-events-none', 'opacity-60');
      card.dataset.disabled = 'true';
      inviteButton.classList.add('hidden');
      info.innerHTML = '<div>スタッフ招待を行うには管理者としてログインしてください。</div>';
      if (!canEdit) return;

      if (!isAdmin) {
        info.innerHTML = '<div>スタッフ招待を利用するには、先に施設管理者を設定してください。</div>';
        inviteButton.classList.add('hidden');
        return;
      }

      inviteButton.classList.remove('hidden');
      const memberships = Array.isArray(clinic.staffMemberships) ? clinic.staffMemberships : [];
      const pendingStaff = Array.isArray(clinic.pendingInvites) ? clinic.pendingInvites.filter(inv => inv.role !== 'clinicAdmin' && inv.status === 'pending') : [];

      const fragments = [];
      fragments.push(`<div class="text-sm text-slate-600">スタッフ招待を行う対象: ${escapeHtml(clinic.name || '')}</div>`);
      fragments.push('<div class="mt-2 text-xs text-slate-500">登録済みスタッフ: ' + memberships.length + '件</div>');
      if (pendingStaff.length) {
        fragments.push('<div class="mt-2 text-sm font-semibold text-amber-700">招待中:</div>');
        fragments.push('<ul class="space-y-1">');
        pendingStaff.forEach(inv => {
          fragments.push(`<li class="flex items-center justify-between gap-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1">${escapeHtml(inv.email || '')}<span>${escapeHtml(inv.status || 'pending')}</span></li>`);
        });
        fragments.push('</ul>');
      }
      info.innerHTML = fragments.join('');
      inviteButton.onclick = () => openStaffInvitePrompt(clinic);
    }

    function openStaffInvitePrompt(clinic) {
      const email = prompt('スタッフとして招待するメールアドレスを入力してください。');
      if (!email) return;
      const displayName = prompt('招待相手の氏名（任意）を入力してください。') || undefined;
      sendInviteRequest('/api/auth/inviteStaff', clinic, email, displayName);
    }

    async function sendInviteRequest(path, clinic, email, displayName) {
      const payload = {
        clinicId: clinic.id,
        email,
        displayName: displayName || undefined,
      };
      try {
        await wrapWithLoading(async () => {
          if (!window.NcdAuth || typeof window.NcdAuth.authorizedFetch !== 'function') {
            throw new Error('認証モジュールの初期化に失敗しました。');
          }
          const res = await window.NcdAuth.authorizedFetch(`${API_BASE}${path}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const error = await res.json().catch(() => ({}));
            throw new Error(error.message || `HTTP ${res.status}`);
          }
          const data = await res.json();
          alert(data.mailStatus === 'sent'
            ? '招待メールを送信しました。'
            : '招待を作成しました（メール送信に失敗した可能性があります）。');
          await refreshClinicDetails(clinic.id);
        }, '招待処理中...', document.getElementById('staffCard'));
      } catch (err) {
        console.error('failed to send invite', err);
        if (err && err.code === 'AUTH_REQUIRED') {
          alert(AUTH_TIMEOUT_MESSAGE);
        } else {
          alert(err?.message ? `招待に失敗しました: ${err.message}` : '招待に失敗しました。');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSelected();
    });
  </script>
</body>
</html>
