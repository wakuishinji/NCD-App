<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>資格入力 - NCD</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
        <a href="clinicHome.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">施設ホームへ</a>
      </div>
      <h1 class="text-lg font-bold">資格入力</h1>
      <div class="w-[120px]"></div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 max-w-4xl mx-auto p-4 md:p-6">
    <div class="bg-white rounded shadow p-4 md:p-6 space-y-6">
      <section class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <h2 class="text-blue-800 font-semibold">資格の追加</h2>

          <div>
            <label class="block text-sm text-gray-700 mb-1">分類</label>
            <select id="qualCategory" class="w-full border rounded px-3 py-2"></select>
          </div>

          <div>
            <label class="block text-sm text-gray-700 mb-1">承認済みマスターから選択（同分類）</label>
            <select id="qualMaster" class="w-full border rounded px-3 py-2">
              <option value="">（選択しない）</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">選択で右の「選択済み」に追加できます。</p>
            <div class="mt-2">
              <button id="btnAddSel" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">この資格を追加</button>
            </div>
          </div>

          <div class="text-xs text-gray-500">
            ※ マスターにない資格は管理画面から追加可能です（資格マスター／分類マスター）。
          </div>

          <div class="flex items-center gap-2">
            <button id="btnSave" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">保存</button>
            <button id="btnClear" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">クリア</button>
          </div>
        </div>

        <div>
          <h2 class="text-blue-800 font-semibold mb-2">選択済み資格</h2>
          <div id="chosen" class="flex flex-wrap gap-2 p-2 bg-gray-50 border rounded min-h-[56px]">
            <!-- タグが入る -->
          </div>

          <h3 class="text-blue-800 font-semibold mt-6 mb-2">この診療所に登録済み</h3>
          <div id="current" class="divide-y bg-gray-50 border rounded"></div>
          <button id="btnReload" class="mt-2 text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">再読込</button>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-xs">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

<script>
const BASE = "https://ncd-app.altry.workers.dev";
let selectedClinic = null;
let chosen = []; // {category, name, issuer?}

function loadSelectedClinic(){
  const s = localStorage.getItem("selectedClinic");
  if (s) {
    selectedClinic = JSON.parse(s);
    document.getElementById("clinicTitle").textContent = selectedClinic.name || "";
  } else {
    document.getElementById("clinicTitle").textContent = "（未選択）";
    alert("施設選択または新規登録後にお進みください。");
  }
}

async function loadCategories(){
  const r = await fetch(`${BASE}/api/listCategories?type=qual`);
  const d = await r.json();
  const sel = document.getElementById("qualCategory");
  const cats = (d.ok ? d.categories : []) || [];
  sel.innerHTML = cats.length ? cats.map(c=>`<option>${c}</option>`).join("") : `<option value="">（分類なし）</option>`;
}

async function loadApprovedMasterForCategory(){
  const cat = document.getElementById("qualCategory").value;
  const box = document.getElementById("qualMaster");
  box.innerHTML = `<option value="">（選択しない）</option>`;

  const url = new URL(`${BASE}/api/listMaster`);
  url.searchParams.set("type","qual");
  url.searchParams.set("status","approved");
  const r = await fetch(url.toString());
  const d = await r.json();
  const items = (d.ok ? d.items : []) || [];
  const filtered = items.filter(it => it.category === cat);

  filtered.forEach(it=>{
    const label = `${it.name}${it.issuer?`（${it.issuer}）`:""}`;
    const opt = document.createElement("option");
    opt.value = JSON.stringify({ category: it.category, name: it.name, issuer: it.issuer || "" });
    opt.textContent = label;
    box.appendChild(opt);
  });
}

function renderChosen(){
  const box = document.getElementById("chosen");
  box.innerHTML = "";
  chosen.forEach((q,idx)=>{
    const tag = document.createElement("span");
    tag.className = "inline-flex items-center gap-1 bg-blue-50 text-blue-800 border border-blue-200 rounded-full px-2 py-1";
    tag.innerHTML = `<span>${q.category} / ${q.name}${q.issuer?`（${q.issuer}）`:""}</span>
      <button class="text-blue-700 hover:text-blue-900" aria-label="remove">&times;</button>`;
    tag.querySelector("button").addEventListener("click", ()=>{ chosen.splice(idx,1); renderChosen(); });
    box.appendChild(tag);
  });
}

function addSelected(){
  const v = document.getElementById("qualMaster").value;
  if (!v) return;
  try {
    const obj = JSON.parse(v);
    if (!chosen.find(x=>x.category===obj.category && x.name===obj.name)) {
      chosen.push(obj);
      renderChosen();
    }
  }catch(_){}
}

async function fetchCurrentClinic(){
  const name = selectedClinic?.name || "";
  if (!name) return null;
  const r = await fetch(`${BASE}/api/listClinics`);
  const d = await r.json();
  const arr = (d.ok && d.clinics) ? d.clinics : [];
  return arr.find(c => (c.name === name)) || null;
}

async function renderCurrent(){
  const box = document.getElementById("current");
  box.innerHTML = "";
  const cur = await fetchCurrentClinic();
  const quals = Array.isArray(cur?.qualifications) ? cur.qualifications : [];
  if (quals.length === 0) {
    box.innerHTML = `<div class="px-3 py-2 text-gray-500 text-sm">登録された資格はありません。</div>`;
    return;
  }
  quals.forEach((q,i)=>{
    const row = document.createElement("div");
    row.className = "px-3 py-2";
    row.innerHTML = `<div class="font-semibold">${q.category} / ${q.name}${q.issuer?`（${q.issuer}）`:""}</div>`;
    box.appendChild(row);
  });
}

function clearForm(){
  chosen = [];
  renderChosen();
  document.getElementById("qualMaster").selectedIndex = 0;
}

async function saveAll(){
  if (!selectedClinic?.name) { alert("施設が選択されていません"); return; }
  const cur = await fetchCurrentClinic();
  const existing = Array.isArray(cur?.qualifications) ? cur.qualifications : [];
  const merged = [...existing];

  // 既存に重複しないものだけ追加
  chosen.forEach(q=>{
    if (!merged.find(x=>x.category===q.category && x.name===q.name)) {
      merged.push(q);
    }
  });

  const payload = {
    name: selectedClinic.name,
    ...(cur || { id: selectedClinic.name }),
    qualifications: merged
  };

  const r = await fetch(`${BASE}/api/updateClinic`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if (!r.ok) { alert("保存に失敗しました"); return; }

  clearForm();
  await renderCurrent();
  alert("保存しました");
}

document.getElementById("btnAddSel").addEventListener("click", addSelected);
document.getElementById("btnSave").addEventListener("click", saveAll);
document.getElementById("btnClear").addEventListener("click", clearForm);
document.getElementById("btnReload").addEventListener("click", renderCurrent);
document.getElementById("qualCategory").addEventListener("change", loadApprovedMasterForCategory);

(async function init(){
  loadSelectedClinic();
  await loadCategories();
  await loadApprovedMasterForCategory();
  renderChosen();
  await renderCurrent();
})();
</script>
</body>
</html>
