<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>システム管理ハブ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.NCD_CF_ENV=window.__CF_PAGES_ENV||(window.__CF_PAGES_ENV?{NCD_API_BASE:window.__CF_PAGES_ENV.NCD_API_BASE,ENV_LABEL:window.__CF_PAGES_ENV.ENV_LABEL}:{NCD_API_BASE:'https://ncd-app.altry.workers.dev',ENV_LABEL:'production'});</script>
  <script src="../js/env.js"></script>
  <script src="../js/auth.js" defer></script>
  <script src="../js/sessionGuard.js" defer></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col" data-require-role="systemRoot" data-guard-message="systemRoot 専用ページです。トップページへ戻ります。">
  <header class="bg-gradient-to-r from-slate-900 via-blue-900 to-slate-900 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
      <a href="/index.html" class="inline-flex items-center gap-2 rounded bg-white/10 px-3 py-2 text-sm font-semibold tracking-wide transition hover:bg-white/20">
        <span aria-hidden="true">⌂</span>
        Top
      </a>
      <h1 class="text-lg font-semibold tracking-wide">システム管理ハブ</h1>
      <div class="flex items-center gap-2">
        <span class="hidden sm:inline text-sm text-white/80">Nakano Clinic Database</span>
        <button id="systemHubLogout" class="inline-flex items-center gap-2 rounded bg-white/10 px-3 py-2 text-xs font-semibold tracking-wide transition hover:bg-red-500/80 hover:text-white">
          <span class="hidden sm:inline">ログアウト</span>
          <span class="sm:hidden">退出</span>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <section class="border-b border-slate-200 bg-white/70">
      <div class="max-w-6xl mx-auto px-4 py-6">
        <p class="text-sm text-slate-600">
          systemRoot 専用の運用ハブです。自治体管理者の承認や厚労省データの取り込み、環境設定など全体オペレーションをまとめています。
        </p>
      </div>
    </section>

    <div class="max-w-6xl mx-auto px-4 py-8 space-y-10">
      <section>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base font-semibold text-blue-900">自治体・アカウント運用</h2>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <a href="clinicList.html" class="group block rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">自治体別施設管理</h3>
            <p class="mt-2 text-sm text-slate-600">自治体管理者の代理として施設一覧・管理者招待・ロール設定を実行します。</p>
          </a>
          <a href="accessRequests.html" class="group block rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">管理者申請の承認</h3>
            <p class="mt-2 text-sm text-slate-600">自治体職員や施設からの管理者申請を確認し、役割を付与/却下します。</p>
          </a>
          <a href="municipalityHub.html" class="group block rounded-xl border border-dashed border-slate-200 bg-slate-50/80 p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">自治体管理ハブ</h3>
            <p class="mt-2 text-sm text-slate-600">自治体管理者向け画面をプレビューしたい場合はこちらから移動できます。</p>
          </a>
        </div>
      </section>

      <section>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base font-semibold text-blue-900">データ連携 / 環境設定</h2>
        </div>
        <div class="grid gap-4 md:grid-cols-3">
          <a href="mhlw-sync.html" class="group block rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">厚労省データ取り込み</h3>
            <p class="mt-2 text-sm text-slate-600">CSV/R2 経由で最新の厚生労働省データを同期します。</p>
          </a>
          <a href="settings.html" class="group block rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">環境設定 / Secrets</h3>
            <p class="mt-2 text-sm text-slate-600">API モデルや Secrets の差し替えなど、環境全体の設定を管理します。</p>
          </a>
          <a href="todo.html" class="group block rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">運用 ToDo</h3>
            <p class="mt-2 text-sm text-slate-600">systemRoot 専用の運用タスクメモ。リリース前後の確認事項を記録します。</p>
          </a>
        </div>
      </section>

      <section>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base font-semibold text-blue-900">共通マスター管理</h2>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <a href="/admin/admin.html" class="group block rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:border-blue-400 hover:shadow-lg">
            <h3 class="text-base font-semibold text-slate-900">共通マスター管理ハブ</h3>
            <p class="mt-2 text-sm text-slate-600">診療/検査/資格/部位など、全国共通マスターの編集画面に移動します。</p>
          </a>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function setupSystemHubLogout(global) {
      async function executeLogout() {
        const apiBase = (global.NcdAuth && global.NcdAuth.resolveApiBase && global.NcdAuth.resolveApiBase()) || 'https://ncd-app.altry.workers.dev';
        const auth = global.NcdAuth?.getStoredAuth?.();
        const payload = auth?.tokens ? {
          refreshToken: auth.tokens.refreshToken,
          sessionId: auth.tokens.sessionId,
        } : {};
        try {
          await fetch(`${apiBase}/api/auth/logout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
        } catch (error) {
          console.warn('[systemHub] logout request failed', error);
        } finally {
          try {
            global.NcdAuth?.clearAuth?.();
          } catch (_) {}
          global.location.replace('/index.html');
        }
      }

      function init() {
        const button = document.getElementById('systemHubLogout');
        if (!button) return;
        button.addEventListener('click', () => {
          button.disabled = true;
          executeLogout();
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })(window);
  </script>
</body>
</html>
