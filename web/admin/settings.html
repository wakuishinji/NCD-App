<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>API / 環境設定 - NCD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../js/loading.js" defer></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
  <header class="bg-gradient-to-r from-slate-900 via-blue-900 to-slate-900 text-white shadow">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/admin/admin.html" class="inline-flex items-center gap-2 rounded bg-white/10 px-3 py-2 text-sm font-semibold tracking-wide transition hover:bg-white/20">戻る</a>
      <h1 class="text-lg font-semibold tracking-wide">API / 環境設定</h1>
      <span class="text-sm text-white/80">Nakano Clinic Database</span>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-4 py-8 space-y-8">
      <section class="rounded-xl border border-slate-200 bg-white/80 p-6 shadow-sm" id="settingsPanel">
        <h2 class="text-base font-semibold text-blue-900">AIモデル・プロンプト設定</h2>
        <p class="mt-1 text-xs text-slate-500">Cloudflare Workers の <code>/api/settings</code> に保存されます。空欄にすると該当項目はクリアされます。</p>

        <form id="commonForm" class="mt-4 space-y-3">
          <div>
            <label for="aiModel" class="block text-xs text-slate-500">共通モデル名</label>
            <input id="aiModel" class="w-full rounded border px-3 py-2" placeholder="例: gpt-4.1-mini" />
          </div>
          <div>
            <label for="aiPrompt" class="block text-xs text-slate-500">共通プロンプト</label>
            <textarea id="aiPrompt" rows="5" class="w-full rounded border px-3 py-2 text-sm" placeholder="各画面の既定プロンプト"></textarea>
          </div>
          <div class="flex justify-end">
            <button class="rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700">共通設定を保存</button>
          </div>
        </form>

        <form id="detailForm" class="mt-6 space-y-3 border-t border-slate-200 pt-6">
          <div>
            <label for="promptExam" class="block text-xs text-slate-500">検査用プロンプト</label>
            <textarea id="promptExam" rows="4" class="w-full rounded border px-3 py-2 text-sm" placeholder="検査説明のための既定プロンプト"></textarea>
          </div>
          <div>
            <label for="promptDiagnosis" class="block text-xs text-slate-500">診療用プロンプト</label>
            <textarea id="promptDiagnosis" rows="4" class="w-full rounded border px-3 py-2 text-sm" placeholder="診療説明のための既定プロンプト"></textarea>
          </div>
          <div class="flex justify-end">
            <button class="rounded bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700">詳細設定を保存</button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <footer class="bg-slate-900/90 text-slate-100">
    <div class="max-w-4xl mx-auto px-4 py-4 text-xs">© 2025 中野区医師会 Nakano Clinic Database</div>
  </footer>

  <script>
    const BASE = 'https://ncd-app.altry.workers.dev';

    async function loadSettings() {
      if (typeof wrapWithLoading === 'function') {
        return wrapWithLoading(async () => {
          const res = await fetch(`${BASE}/api/settings`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          document.getElementById('aiModel').value = data.model || '';
          document.getElementById('aiPrompt').value = data.prompt || '';
          document.getElementById('promptExam').value = data.prompt_exam || '';
          document.getElementById('promptDiagnosis').value = data.prompt_diagnosis || '';
        }, '設定を読み込み中...', document.getElementById('settingsPanel'));
      }
      const res = await fetch(`${BASE}/api/settings`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      document.getElementById('aiModel').value = data.model || '';
      document.getElementById('aiPrompt').value = data.prompt || '';
      document.getElementById('promptExam').value = data.prompt_exam || '';
      document.getElementById('promptDiagnosis').value = data.prompt_diagnosis || '';
    }

    async function saveCommon(event) {
      event.preventDefault();
      const payload = {
        model: document.getElementById('aiModel').value.trim(),
        prompt: document.getElementById('aiPrompt').value
      };
      await wrapWithLoading(async () => {
        const res = await fetch(`${BASE}/api/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`保存に失敗しました: ${res.status} ${text}`);
        }
      }, '共通設定を保存しています...', document.getElementById('settingsPanel'));
      alert('共通設定を保存しました');
    }

    async function saveDetails(event) {
      event.preventDefault();
      const payload = {
        prompt_exam: document.getElementById('promptExam').value,
        prompt_diagnosis: document.getElementById('promptDiagnosis').value
      };
      await wrapWithLoading(async () => {
        const res = await fetch(`${BASE}/api/settings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`保存に失敗しました: ${res.status} ${text}`);
        }
      }, '詳細設定を保存しています...', document.getElementById('settingsPanel'));
      alert('詳細設定を保存しました');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSettings().catch(err => {
        console.error(err);
        alert('設定の読み込みに失敗しました');
      });
      document.getElementById('commonForm').addEventListener('submit', saveCommon);
      document.getElementById('detailForm').addEventListener('submit', saveDetails);
    });
  </script>
</body>
</html>
