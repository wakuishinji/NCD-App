<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>NCD 管理ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/loading.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- ヘッダー -->
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
      </div>
      <h1 class="text-xl font-bold">NCD 管理ダッシュボード</h1>
      <div class="w-[120px]"></div>
    </div>
  </header>

  <!-- メイン -->
  <main class="flex-1 max-w-6xl mx-auto p-4 md:p-6">
    <!-- タブ -->
    <div class="bg-white rounded shadow">
      <div class="border-b flex flex-wrap">
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-clinics">診療所リスト</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-cat-qual">資格分類</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-qual">資格マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-cat-test">検査分類</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-cat-service">診療分類</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-test">検査マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-service">診療マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-dept">標榜診療科マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-ai">AI設定</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-todo">開発ToDo</button>
      </div>

      <!-- パネル群 -->
      <div class="p-4 md:p-6 space-y-8">

        <!-- 診療所リスト -->
        <section id="tab-clinics" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">診療所リストの管理</h2>
            <div class="flex gap-2">
              <a id="exportClinicsJson" class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" href="#" download>JSON出力</a>
              <a id="exportClinicsCsv"  class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" href="#" download>CSV出力</a>
            </div>
          </div>
          <div class="flex gap-3 mb-3">
            <input id="clinicQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（名称・住所）">
            <select id="clinicOrder" class="border rounded px-3 py-2">
              <option value="updated_desc">更新が新しい</option>
              <option value="updated_asc">更新が古い</option>
              <option value="name_asc">名称（昇順）</option>
              <option value="name_desc">名称（降順）</option>
            </select>
            <button id="clinicReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border px-2 py-1">ID</th>
                  <th class="border px-2 py-1">名称</th>
                  <th class="border px-2 py-1">住所</th>
                  <th class="border px-2 py-1">更新</th>
                  <th class="border px-2 py-1">操作</th>
                </tr>
              </thead>
              <tbody id="clinicsTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- 資格分類 -->
        <section id="tab-cat-qual" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">資格分類マスター</h2>
            <div class="text-sm text-gray-500">キー: <code>categories:qual</code></div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="catQualNew" class="border rounded px-3 py-2" placeholder="分類名を追加">
            <button id="catQualAdd" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">追加</button>
          </div>
          <div id="catQualList" class="divide-y bg-gray-50 border rounded"></div>
        </section>

        <!-- 資格マスター -->
        <section id="tab-master-qual" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">資格マスターの管理</h2>
            <div class="flex gap-2">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('qual','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('qual','csv')">CSV出力</button>
            </div>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstQualStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstQualQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称・issuer）">
            <button id="mstQualReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstQualList" class="space-y-3"></div>
        </section>

        <!-- 検査分類 -->
        <section id="tab-cat-test" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">検査分類マスター</h2>
            <div class="text-sm text-gray-500">キー: <code>categories:test</code></div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="catTestNew" class="border rounded px-3 py-2" placeholder="分類名を追加">
            <button id="catTestAdd" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">追加</button>
          </div>
          <div id="catTestList" class="divide-y bg-gray-50 border rounded"></div>
        </section>

        <!-- 診療分類 -->
        <section id="tab-cat-service" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">診療分類マスター</h2>
            <div class="text-sm text-gray-500">キー: <code>categories:service</code></div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="catSvcNew" class="border rounded px-3 py-2" placeholder="分類名を追加">
            <button id="catSvcAdd" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">追加</button>
          </div>
          <div id="catSvcList" class="divide-y bg-gray-50 border rounded"></div>
        </section>

        <!-- 検査マスター -->
        <section id="tab-master-test" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">検査マスターの管理</h2>
            <div class="flex gap-2 items-center">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('test','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('test','csv')">CSV出力</button>
              <button id="mstTestImport" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">CSV取込</button>
              <input type="file" id="mstTestCsvInput" accept=".csv,text/csv" class="hidden" />
            </div>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstTestStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstTestQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称）">
            <button id="mstTestReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstTestList" class="space-y-3"></div>
        </section>

        <!-- 診療マスター -->
        <section id="tab-master-service" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">診療マスターの管理</h2>
            <div class="flex gap-2 items-center">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('service','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('service','csv')">CSV出力</button>
              <button id="mstSvcImport" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">CSV取込</button>
              <input type="file" id="mstSvcCsvInput" accept=".csv,text/csv" class="hidden" />
            </div>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstSvcStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstSvcQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称）">
            <button id="mstSvcReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstSvcList" class="space-y-3"></div>
        </section>

        <!-- 標榜診療科マスター -->
        <section id="tab-master-dept" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">標榜診療科マスターの管理</h2>
            <div class="flex gap-2">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('department','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('department','csv')">CSV出力</button>
            </div>
          </div>
          <div class="bg-white border rounded p-4 mb-4">
            <h3 class="font-semibold text-gray-800 mb-2">診療科の手動追加</h3>
            <div class="flex flex-col gap-2 md:flex-row">
              <input id="mstDeptNew" class="border rounded px-3 py-2 flex-1" placeholder="診療科名（例: 内科）">
              <button id="mstDeptAdd" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">候補として追加</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">追加された診療科は候補ステータスで登録されます。承認すると施設詳細画面で選択できるようになります。</p>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstDeptStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstDeptQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称）">
            <button id="mstDeptReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstDeptList" class="space-y-3"></div>
        </section>

        <!-- AI設定 -->
        <section id="tab-ai" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">AI設定</h2>
          </div>
          <div class="grid gap-4 md:grid-cols-2">
            <div class="space-y-3">
              <label class="block text-sm text-gray-700">共通モデル名</label>
              <input id="aiModel" class="w-full border rounded px-3 py-2" placeholder="例: gpt-4.1">
              <label class="block text-sm text-gray-700">共通プロンプト</label>
              <textarea id="aiPrompt" rows="6" class="w-full border rounded px-3 py-2"></textarea>
              <button id="aiSave" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">保存</button>
            </div>
            <div class="space-y-3">
              <label class="block text-sm text-gray-700">検査用プロンプト</label>
              <textarea id="promptExam" rows="4" class="w-full border rounded px-3 py-2"></textarea>
              <label class="block text-sm text-gray-700">診療用プロンプト</label>
              <textarea id="promptDiagnosis" rows="4" class="w-full border rounded px-3 py-2"></textarea>
              <button id="aiSubSave" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">保存</button>
            </div>
          </div>
        </section>

        <!-- 開発ToDo -->
        <section id="tab-todo" class="tab-panel hidden">
          <iframe src="todo.html" title="開発ToDo管理" class="w-full h-[70vh]"></iframe>
        </section>

      </div>
    </div>
  </main>

  <!-- フッター -->
  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

<script>
const BASE = "https://ncd-app.altry.workers.dev";
const DEPARTMENT_CATEGORY = "標榜診療科";
const MASTER_PANEL_MAP = {
  qual: 'tab-master-qual',
  test: 'tab-master-test',
  service: 'tab-master-service',
  department: 'tab-master-dept'
};
const MASTER_LIST_MAP = {
  qual: ['mstQualList', 'mstQualStatus', 'mstQualQ'],
  test: ['mstTestList', 'mstTestStatus', 'mstTestQ'],
  service: ['mstSvcList', 'mstSvcStatus', 'mstSvcQ'],
  department: ['mstDeptList', 'mstDeptStatus', 'mstDeptQ']
};
const MASTER_MESSAGE_MAP = {
  qual: '資格マスターを読み込み中...',
  test: '検査マスターを読み込み中...',
  service: '診療マスターを読み込み中...',
  department: '標榜診療科マスターを読み込み中...'
};

function escapeAttr(val) {
  return String(val ?? '')
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function escapeHtml(val) {
  return String(val ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// -------------------- タブ --------------------
const tabs = document.querySelectorAll(".tab");
const panels = document.querySelectorAll(".tab-panel");
async function showTab(id){
  panels.forEach(p=>p.classList.add("hidden"));
  const targetPanel = document.getElementById(id);
  targetPanel?.classList.remove("hidden");
  tabs.forEach(t=>t.classList.toggle("border-blue-600", t.dataset.target===id));

  try {
    switch(id) {
      case 'tab-clinics':
        await withPanelLoading(id, '診療所リストを読み込み中...', () => loadClinics());
        break;
      case 'tab-cat-qual':
        await withPanelLoading(id, '資格分類を読み込み中...', () => loadCategories('qual','catQualList'));
        break;
      case 'tab-master-qual':
        await withPanelLoading(id, '資格マスターを読み込み中...', () => loadMaster('qual','mstQualList','mstQualStatus','mstQualQ'));
        break;
      case 'tab-cat-test':
        await withPanelLoading(id, '検査分類を読み込み中...', () => loadCategories('test','catTestList'));
        break;
      case 'tab-cat-service':
        await withPanelLoading(id, '診療分類を読み込み中...', () => loadCategories('service','catSvcList'));
        break;
      case 'tab-master-test':
        await withPanelLoading(id, '検査マスターを読み込み中...', () => loadMaster('test','mstTestList','mstTestStatus','mstTestQ'));
        break;
      case 'tab-master-service':
        await withPanelLoading(id, '診療マスターを読み込み中...', () => loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ'));
        break;
      case 'tab-master-dept':
        await withPanelLoading(id, '標榜診療科マスターを読み込み中...', () => loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ'));
        break;
      case 'tab-ai':
        await withPanelLoading(id, 'AI設定を読み込み中...', () => loadAISettings());
        break;
      case 'tab-todo':
        // iframe 内のため特別な処理は不要
        break;
    }
  } catch (error) {
    console.error(`タブデータの読み込みに失敗: ${id}`, error);
    alert(`データの読み込みに失敗しました: ${id}`);
  }
}

tabs.forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.target)));

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => showTab('tab-clinics'));
} else {
  showTab('tab-clinics');
}

// -------------------- 診療所リスト --------------------
let clinicsRaw = [];
async function loadClinics(){
  try {
    const r = await fetch(`${BASE}/api/listClinics`);
    const d = await r.json();
    clinicsRaw = (d.ok && d.clinics) ? d.clinics : [];
    renderClinics();
  } catch (error) {
    console.error('診療所リストの読み込みに失敗:', error);
    clinicsRaw = [];
    renderClinics();
  }
}
function renderClinics(){
  const q = (document.getElementById('clinicQ').value || '').trim().toLowerCase();
  const order = document.getElementById('clinicOrder').value;
  let list = [...clinicsRaw];
  if (q) {
    list = list.filter(c => (c.name||'').toLowerCase().includes(q) || (c.address||'').toLowerCase().includes(q));
  }
  list.sort((a,b)=>{
    if (order==='updated_desc') return (b.updated_at||0)-(a.updated_at||0);
    if (order==='updated_asc') return (a.updated_at||0)-(b.updated_at||0);
    if (order==='name_asc') return (a.name||'').localeCompare(b.name||'');
    if (order==='name_desc') return (b.name||'').localeCompare(a.name||'');
    return 0;
  });
  const tb = document.getElementById('clinicsTbody');
  tb.innerHTML = "";
  list.forEach(c=>{
    const tr = document.createElement('tr');
    const updated = c.updated_at ? new Date(c.updated_at*1000).toLocaleString() : '-';
    tr.innerHTML = `
      <td class="border px-2 py-1">${c.id||'-'}</td>
      <td class="border px-2 py-1">${c.name||''}</td>
      <td class="border px-2 py-1">${c.address||''}</td>
      <td class="border px-2 py-1">${updated}</td>
      <td class="border px-2 py-1">
        <button class="text-blue-700 underline mr-2" onclick='selectClinic(${JSON.stringify(c)})'>選択</button>
        <button class="text-red-700 underline" onclick='deleteClinic("${c.id||""}","${(c.name||"").replace(/"/g,"&quot;")}")'>削除</button>
      </td>`;
    tb.appendChild(tr);
  });

  document.getElementById('exportClinicsJson').href = `${BASE}/api/exportClinics?format=json`;
  document.getElementById('exportClinicsCsv').href  = `${BASE}/api/exportClinics?format=csv`;
}
function selectClinic(c){
  localStorage.setItem('selectedClinic', JSON.stringify(c));
  alert(`選択しました: ${c.name}`);
}
async function deleteClinic(id, name){
  if (!id && !name) { alert("削除対象のID/名称が不明です"); return; }
  if (!confirm(`削除してよろしいですか？\n${name || id}`)) return;

  try {
    const executor = async () => {
      const r = await fetch(`${BASE}/api/deleteClinic`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ id, name })
      });
      if (!r.ok) throw new Error('削除に失敗しました');
      await loadClinics();
    };
    if (typeof wrapWithLoading === 'function') {
      await wrapWithLoading(executor, '診療所を削除中...');
    } else {
      await executor();
    }
  } catch (error) {
    alert(error.message);
  }
}
document.getElementById('clinicReload').addEventListener('click', () => {
  if (typeof wrapWithLoading === 'function') {
    wrapWithLoading(loadClinics, '診療所リストを再読み込み中...');
  } else {
    loadClinics();
  }
});
document.getElementById('clinicOrder').addEventListener('change', renderClinics);
document.getElementById('clinicQ').addEventListener('input', renderClinics);

// -------------------- 分類（検査/診療/資格） --------------------
async function loadCategories(type, listElId){
  try {
    const r = await fetch(`${BASE}/api/listCategories?type=${type}`);
    const d = await r.json();
    const cats = (d.ok ? d.categories : []) || [];
    const box = document.getElementById(listElId);
    box.innerHTML = "";
    cats.forEach(cat=>{
      const row = document.createElement('div');
      row.className = "flex items-center justify-between px-3 py-2";
      row.innerHTML = `
        <div class="flex-1">${cat}</div>
        <div class="flex gap-2">
          <button class="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300" onclick='renameCategory("${type}","${cat.replace(/"/g,'&quot;')}")'>改名</button>
          <button class="px-2 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200" onclick='deleteCategory("${type}","${cat.replace(/"/g,'&quot;')}")'>削除</button>
        </div>`;
      box.appendChild(row);
    });
  } catch (error) {
    console.error(`分類読み込みエラー (${type}):`, error);
    const box = document.getElementById(listElId);
    if (box) {
      box.innerHTML = '<div class="text-gray-500 p-4">データの読み込みに失敗しました</div>';
    }
  }
}
async function addCategory(type, inputId){
  const name = document.getElementById(inputId).value.trim();
  if (!name) return;
  await fetch(`${BASE}/api/addCategory`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, name })
  });
  document.getElementById(inputId).value="";
  await loadCategories(type, type==='test'?'catTestList':type==='service'?'catSvcList':'catQualList');
}
async function renameCategory(type, oldName){
  const newName = prompt("新しい分類名", oldName);
  if (!newName || newName===oldName) return;
  await fetch(`${BASE}/api/renameCategory`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, oldName, newName })
  });
  await loadCategories(type, type==='test'?'catTestList':type==='service'?'catSvcList':'catQualList');
}
async function deleteCategory(type, name){
  if (!confirm(`削除しますか？\n${name}`)) return;
  await fetch(`${BASE}/api/deleteCategory`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, name })
  });
  await loadCategories(type, type==='test'?'catTestList':type==='service'?'catSvcList':'catQualList');
}

document.getElementById('catTestAdd').addEventListener('click', ()=>addCategory('test','catTestNew'));
document.getElementById('catSvcAdd').addEventListener('click',  ()=>addCategory('service','catSvcNew'));
document.getElementById('catQualAdd').addEventListener('click', ()=>addCategory('qual','catQualNew'));

// -------------------- マスター（検査/診療/資格/診療科） --------------------
function withPanelLoading(panelId, message, asyncFn){
  const panel = document.getElementById(panelId);
  if (typeof wrapWithLoading === 'function') {
    return wrapWithLoading(asyncFn, message, panel);
  }
  return asyncFn();
}

function parseCsv(text) {
  const rows = [];
  let current = [];
  let value = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (char === '"') {
      if (inQuotes && text[i + 1] === '"') {
        value += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      current.push(value);
      value = '';
    } else if ((char === '\n' || char === '\r') && !inQuotes) {
      if (char === '\r' && text[i + 1] === '\n') i++;
      current.push(value);
      rows.push(current);
      current = [];
      value = '';
    } else {
      value += char;
    }
  }

  // push final value
  if (value.length || inQuotes || current.length) {
    current.push(value);
    rows.push(current);
  }

  return rows.filter(row => row.some(cell => String(cell).trim().length));
}

async function handleMasterCsvImport(type, file) {
  if (!file) return;
  const panelId = MASTER_PANEL_MAP[type];
  const listInfo = MASTER_LIST_MAP[type];
  if (!panelId || !listInfo) {
    alert('CSV取込に対応していないマスターです');
    return;
  }
  const [listId, statusId, queryId] = listInfo;
  const message = MASTER_MESSAGE_MAP[type] || 'データを読み込み中...';

  const text = await file.text();
  const rows = parseCsv(text);
  if (!rows.length) {
    alert('CSVにデータがありません');
    return;
  }

  let startIndex = 0;
  const header = rows[0].map(cell => String(cell).trim());
  if (header[0] === '分類' && header[1] === '名称' && header[2] === '説明') {
    startIndex = 1;
  }

  const targets = rows.slice(startIndex).map(row => row.map(cell => String(cell).trim())).filter(row => row[0] && row[1]);
  if (!targets.length) {
    alert('取り込む項目がありません（分類と名称は必須です）');
    return;
  }

  let success = 0;
  const failures = [];

  await withPanelLoading(panelId, `${message}（CSV取込中...）`, async () => {
    for (const row of targets) {
      const [category, name, desc = ''] = row;
      try {
        const res = await fetch(`${BASE}/api/addMasterItem`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type, category, name, desc, source: 'admin-csv.import', status: 'approved' })
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        success += 1;
      } catch (err) {
        failures.push({ row, error: err.message });
      }
    }
    await loadMaster(type, listId, statusId, queryId);
  });

  let messageText = `CSV取込が完了しました。成功: ${success}`;
  if (failures.length) {
    messageText += ` / 失敗: ${failures.length}`;
    console.warn('CSV import failures', failures);
  }
  alert(messageText);
}

function setupCsvImport(type, buttonId, inputId) {
  const button = document.getElementById(buttonId);
  const input = document.getElementById(inputId);
  if (!button || !input) return;
  button.addEventListener('click', () => input.click());
  input.addEventListener('change', async (event) => {
    const file = event.target.files && event.target.files[0];
    if (file) {
      await handleMasterCsvImport(type, file);
    }
    input.value = '';
  });
}

async function loadMaster(type, listElId, statusSelId, qId){
  try {
    const status = document.getElementById(statusSelId).value;
    const q = (document.getElementById(qId).value||'').trim().toLowerCase();
    const url = new URL(`${BASE}/api/listMaster`);
    url.searchParams.set("type", type);
    if (status) url.searchParams.set("status", status);
    url.searchParams.set("includeSimilar", "true");
    const r = await fetch(url.toString());
    const d = await r.json();
    const items = (d.ok ? d.items : []) || [];
    const box = document.getElementById(listElId);
    box.innerHTML = "";

    // 資格分類の自動設定とフィルタリング
    const filtered = items.filter(it=>{
      if (!q) return true;
      const s = `${it.category} ${it.name} ${it.canonical_name||''}`.toLowerCase();
      return s.includes(q);
    }).map(it => {
      // sortGroupが空の場合、適当な値を設定
      if (!it.sortGroup && type === 'qual') {
        if (it.name.includes('医師') || it.name.includes('医学')) {
          it.sortGroup = '医師・医学系';
        } else if (it.name.includes('看護') || it.name.includes('保健')) {
          it.sortGroup = '看護・保健系';
        } else if (it.name.includes('薬剤') || it.name.includes('薬学')) {
          it.sortGroup = '薬剤・薬学系';
        } else if (it.name.includes('技師') || it.name.includes('技術')) {
          it.sortGroup = '技師・技術系';
        } else if (it.name.includes('療法') || it.name.includes('リハビリ')) {
          it.sortGroup = 'リハビリ・療法系';
        } else {
          it.sortGroup = 'その他専門職';
        }
      }
      return it;
    });

    // sortGroupで並べ替え
    filtered.sort((a, b) => {
      const groupA = a.sortGroup || 'その他';
      const groupB = b.sortGroup || 'その他';
      if (groupA !== groupB) {
        return groupA.localeCompare(groupB, 'ja');
      }
      return (a.name || '').localeCompare(b.name || '', 'ja');
    });

    const INITIAL_GROUP = Symbol('initial');
    let currentGroup = INITIAL_GROUP;
    filtered.forEach(it=>{
      const group = it.sortGroup || 'その他';
      if (group !== currentGroup) {
        if (currentGroup !== INITIAL_GROUP) {
          const divider = document.createElement('hr');
          divider.className = 'mt-3 border-gray-200';
          box.appendChild(divider);
        }
        currentGroup = group;
        const headingWrap = document.createElement('div');
        headingWrap.className = 'mt-4 flex items-center gap-2 first:mt-0';
        const heading = document.createElement('div');
        heading.className = "text-sm font-semibold text-gray-600";
        heading.textContent = group;
        headingWrap.appendChild(heading);
        box.appendChild(headingWrap);
      }

      const div = document.createElement('div');
      div.className = "mt-1 border rounded p-3 bg-white space-y-3";
      div.dataset.masterRow = "true";
      div.dataset.originalCategory = it.category || "";
      div.dataset.originalName = it.name || "";

      const showDescField = type === 'test' || type === 'service' || (typeof it.desc === 'string' && it.desc);
      const safeDesc = escapeHtml(it.desc || "");

      div.innerHTML = `
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-gray-600">分類</label>
            <input class="w-full border rounded px-2 py-1" value="${escapeAttr(it.category || '')}" data-k="category" placeholder="例: 循環器">
          </div>
          <div>
            <label class="block text-xs text-gray-600">名称</label>
            <input class="w-full border rounded px-2 py-1" value="${escapeAttr(it.name || '')}" data-k="name" placeholder="名称を入力">
          </div>
          ${showDescField ? `
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-600">説明</label>
            <textarea class="w-full border rounded px-3 py-2 text-sm" rows="3" data-k="desc" placeholder="説明を入力">${safeDesc}</textarea>
          </div>` : ''}
          <div>
            <label class="block text-xs text-gray-600">canonical_name（統合名）</label>
            <input class="w-full border rounded px-2 py-1" value="${escapeAttr(it.canonical_name || '')}" data-k="cn" placeholder="例: 正式名称">
          </div>
          <div>
            <label class="block text-xs text-gray-600">status</label>
            <select class="w-full border rounded px-2 py-1" data-k="st">
              ${["candidate","approved","archived"].map(s=>`<option ${s===(it.status||'')?'selected':''}>${s}</option>`).join("")}
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-600">sortGroup</label>
            <input class="w-full border rounded px-2 py-1" value="${escapeAttr(it.sortGroup || '')}" data-k="group" placeholder="例: 内科系">
          </div>
          <div>
            <label class="block text-xs text-gray-600">sortOrder</label>
            <input class="w-full border rounded px-2 py-1" type="number" value="${typeof it.sortOrder === 'number' ? it.sortOrder : ''}" data-k="order" placeholder="例: 100">
          </div>
        </div>
        <div class="flex gap-2">
          <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 hidden" data-action="update" disabled>更新</button>
          <button class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" data-action="delete">削除</button>
        </div>
        <div class="text-xs text-gray-500">count: ${it.count || 0} / sources: ${(it.sources||[]).join(', ')}</div>
        <div class="similar-matches-container"></div>
      `;

      const updateBtn = div.querySelector('button[data-action="update"]');
      const deleteBtn = div.querySelector('button[data-action="delete"]');
      const categoryInput = div.querySelector('input[data-k="category"]');
      const nameInput = div.querySelector('input[data-k="name"]');
      const descInput = div.querySelector('textarea[data-k="desc"]');
      const cnInput = div.querySelector('input[data-k="cn"]');
      const stSelect = div.querySelector('select[data-k="st"]');
      const groupInput = div.querySelector('input[data-k="group"]');
      const orderInput = div.querySelector('input[data-k="order"]');

      applyStatusAppearance(stSelect);

      updateBtn.addEventListener('click', () => {
        updateMaster(type, updateBtn);
      });

      deleteBtn.addEventListener('click', () => {
        deleteMasterItem(type, div.dataset.originalCategory || '', div.dataset.originalName || '');
      });

      const similarContainer = div.querySelector('.similar-matches-container');
      if (Array.isArray(it.similarMatches) && it.similarMatches.length > 0) {
        const similarDiv = document.createElement('div');
        similarDiv.className = 'bg-yellow-50 border border-yellow-200 rounded p-2 text-xs text-yellow-900';
        similarDiv.innerHTML = '<div class="font-semibold mb-1">重複候補 (score ≥ 0.92)</div><ul class="space-y-1"></ul>';
        const ul = similarDiv.querySelector('ul');
        it.similarMatches.forEach(m => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between gap-2';
          const nameText = m.name + (m.canonical_name && m.canonical_name !== m.name ? ` / ${m.canonical_name}` : '');
          const span = document.createElement('span');
          span.innerHTML = `${escapeHtml(nameText)} <span class="text-[11px] text-yellow-700">(status: ${m.status || '-'}, sim: ${m.similarity})</span>`;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'text-blue-700 underline';
          btn.textContent = '統合名に採用';
          btn.addEventListener('click', () => {
            cnInput.value = m.canonical_name || m.name;
            cnInput.dispatchEvent(new Event('input', { bubbles: true }));
          });
          li.append(span, btn);
          ul.appendChild(li);
        });
        similarContainer.appendChild(similarDiv);
      }

      const initialState = {
        category: categoryInput ? categoryInput.value : '',
        name: nameInput ? nameInput.value : '',
        desc: descInput ? descInput.value : '',
        cn: cnInput ? cnInput.value : '',
        status: stSelect ? stSelect.value : '',
        group: groupInput ? groupInput.value : '',
        order: orderInput ? orderInput.value : ''
      };

      function refreshButtonState(){
        const changed =
          (categoryInput && categoryInput.value !== initialState.category) ||
          (nameInput && nameInput.value !== initialState.name) ||
          (descInput && descInput.value !== initialState.desc) ||
          (cnInput && cnInput.value !== initialState.cn) ||
          (stSelect && stSelect.value !== initialState.status) ||
          (groupInput && groupInput.value !== initialState.group) ||
          (orderInput && orderInput.value !== initialState.order);
        updateBtn.disabled = !changed;
        updateBtn.classList.toggle('hidden', !changed);
      }

      [categoryInput, nameInput, descInput, cnInput, groupInput, orderInput].forEach(input => {
        if (!input) return;
        const evt = input.tagName === 'SELECT' ? 'change' : 'input';
        input.addEventListener(evt, refreshButtonState);
      });
      stSelect.addEventListener('change', () => {
        refreshButtonState();
        applyStatusAppearance(stSelect);
      });
      refreshButtonState();

      box.appendChild(div);
    });
  } catch (error) {
    console.error(`マスター読み込みエラー (${type}):`, error);
    const box = document.getElementById(listElId);
    if (box) {
      box.innerHTML = '<div class="text-gray-500 p-4">データの読み込みに失敗しました</div>';
    }
  }
}
async function updateMaster(type, btn){
  const row = btn.closest('[data-master-row]');
  if (!row) return;

  const originalCategory = row.dataset.originalCategory || '';
  const originalName = row.dataset.originalName || '';

  const categoryInput = row.querySelector('[data-k="category"]');
  const nameInput = row.querySelector('[data-k="name"]');
  const descInput = row.querySelector('[data-k="desc"]');
  const cnInput = row.querySelector('[data-k="cn"]');
  const stSelect = row.querySelector('[data-k="st"]');
  const groupInput = row.querySelector('[data-k="group"]');
  const orderInput = row.querySelector('[data-k="order"]');

  const payload = {
    type,
    category: originalCategory,
    name: originalName,
    canonical_name: cnInput ? cnInput.value.trim() : '',
    status: stSelect ? stSelect.value : '',
    sortGroup: groupInput ? groupInput.value.trim() || null : null
  };

  if (orderInput) {
    const raw = orderInput.value.trim();
    payload.sortOrder = raw === '' ? null : Number(raw);
  }

  if (categoryInput) {
    const newCat = categoryInput.value.trim();
    if (newCat && newCat !== originalCategory) {
      payload.newCategory = newCat;
    }
  }

  if (nameInput) {
    const newName = nameInput.value.trim();
    if (newName && newName !== originalName) {
      payload.newName = newName;
    }
  }

  if (descInput) {
    payload.desc = descInput.value.trim();
  }

  const listInfo = MASTER_LIST_MAP[type];
  const panelId = MASTER_PANEL_MAP[type];
  const message = MASTER_MESSAGE_MAP[type] || 'データ更新中...';

  if (!listInfo) {
    alert('この種別は更新対象外です');
    return;
  }

  const [listId, statusId, queryId] = listInfo;

  try {
    await withPanelLoading(panelId, `${message}（保存中...）`, async () => {
      const res = await fetch(`${BASE}/api/updateMasterItem`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      await loadMaster(type, listId, statusId, queryId);
    });
    alert("更新しました");
  } catch (error) {
    alert("更新に失敗しました: " + error.message);
  }
}

async function deleteMasterItem(type, category, name) {
  const typeLabel = { qual: '資格', test: '検査', service: '診療', department: '診療科' };
  if (!confirm(`この${typeLabel[type] || '項目'}を削除してもよろしいですか？\n\n分類: ${category}\n名称: ${name}`)) {
    return;
  }
  
  try {
    const [listId, statusId, queryId] = MASTER_LIST_MAP[type] || [];
    if (listId && statusId && queryId) {
      await withPanelLoading(MASTER_PANEL_MAP[type], MASTER_MESSAGE_MAP[type] || 'データ取得中...', async () => {
        const response = await fetch(`${BASE}/api/deleteMasterItem`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ type, category, name })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        await loadMaster(type, listId, statusId, queryId);
      });
      alert(`${typeLabel[type] || '項目'}を削除しました`);
    }
  } catch (error) {
    alert("削除に失敗しました: " + error.message);
  }
}
function exportMaster(type, format){
  const url = `${BASE}/api/exportMaster?type=${type}&format=${format}`;
  window.open(url, "_blank");
}

function applyStatusAppearance(selectEl){
  if (!selectEl) return;
  const accentClasses = [
    'bg-green-50','text-green-700','border-green-300',
    'bg-red-50','text-red-700','border-red-300',
    'bg-gray-100','text-gray-600','border-gray-300'
  ];
  selectEl.classList.remove(...accentClasses);
  switch (selectEl.value) {
    case 'approved':
      selectEl.classList.add('bg-green-50','text-green-700','border-green-300');
      break;
    case 'candidate':
      selectEl.classList.add('bg-red-50','text-red-700','border-red-300');
      break;
    case 'archived':
      selectEl.classList.add('bg-gray-100','text-gray-600','border-gray-300');
      break;
    default:
      break;
  }
}
function bindStatusFilterAppearance(id){
  const el = document.getElementById(id);
  if (!el) return;
  const handler = () => applyStatusAppearance(el);
  el.addEventListener('change', handler);
  handler();
}

async function addDepartmentMaster(){
  const input = document.getElementById('mstDeptNew');
  if (!input) return;
  const name = (input.value || '').trim();
  if (!name) {
    alert('診療科名を入力してください');
    input.focus();
    return;
  }
  try {
    await withPanelLoading('tab-master-dept', '標榜診療科マスターを読み込み中...', async () => {
      const res = await fetch(`${BASE}/api/addMasterItem`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type: 'department', category: DEPARTMENT_CATEGORY, name, source: 'admin-manual' })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      input.value = '';
      await loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ');
    });
    alert('候補として追加しました。ステータスを承認に変更すると施設詳細で選択できます。');
  } catch (err) {
    alert('診療科の追加に失敗しました: ' + err.message);
  }
}

document.getElementById('mstTestReload').addEventListener('click', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.test, MASTER_MESSAGE_MAP.test, () => loadMaster('test','mstTestList','mstTestStatus','mstTestQ'));
});
document.getElementById('mstSvcReload').addEventListener('click', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.service, MASTER_MESSAGE_MAP.service, () => loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ'));
});
document.getElementById('mstTestStatus').addEventListener('change', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.test, MASTER_MESSAGE_MAP.test, () => loadMaster('test','mstTestList','mstTestStatus','mstTestQ'));
});
document.getElementById('mstSvcStatus').addEventListener('change', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.service, MASTER_MESSAGE_MAP.service, () => loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ'));
});
document.getElementById('mstTestQ').addEventListener('input', () => {
  loadMaster('test','mstTestList','mstTestStatus','mstTestQ');
});
document.getElementById('mstSvcQ').addEventListener('input', () => {
  loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ');
});
document.getElementById('mstDeptAdd').addEventListener('click', addDepartmentMaster);
document.getElementById('mstDeptReload').addEventListener('click', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.department, MASTER_MESSAGE_MAP.department, () => loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ'));
});
document.getElementById('mstDeptStatus').addEventListener('change', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.department, MASTER_MESSAGE_MAP.department, () => loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ'));
});
document.getElementById('mstDeptQ').addEventListener('input', () => {
  loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ');
});
bindStatusFilterAppearance('mstTestStatus');
bindStatusFilterAppearance('mstSvcStatus');
bindStatusFilterAppearance('mstDeptStatus');
bindStatusFilterAppearance('mstQualStatus');
document.getElementById('mstQualReload').addEventListener('click', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.qual, MASTER_MESSAGE_MAP.qual, () => loadMaster('qual','mstQualList','mstQualStatus','mstQualQ'));
});
document.getElementById('mstQualStatus').addEventListener('change', async () => {
  await withPanelLoading(MASTER_PANEL_MAP.qual, MASTER_MESSAGE_MAP.qual, () => loadMaster('qual','mstQualList','mstQualStatus','mstQualQ'));
});
document.getElementById('mstQualQ').addEventListener('input', () => {
  loadMaster('qual','mstQualList','mstQualStatus','mstQualQ');
});

setupCsvImport('test', 'mstTestImport', 'mstTestCsvInput');
setupCsvImport('service', 'mstSvcImport', 'mstSvcCsvInput');

// -------------------- AI設定 --------------------
async function loadAISettings(){
  try {
    const r = await fetch(`${BASE}/api/settings`);
    const d = await r.json();
    document.getElementById('aiModel').value = d.model || '';
    document.getElementById('aiPrompt').value = d.prompt || '';
    document.getElementById('promptExam').value = d.prompt_exam || '';
    document.getElementById('promptDiagnosis').value = d.prompt_diagnosis || '';
  } catch (error) {
    console.error('AI設定読み込みエラー:', error);
    ['aiModel','aiPrompt','promptExam','promptDiagnosis'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
  }
}
async function saveAISettings(){
  const model = document.getElementById('aiModel').value.trim();
  const prompt = document.getElementById('aiPrompt').value;
  await fetch(`${BASE}/api/settings`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ model, prompt })
  });
  alert("共通モデル/プロンプトを保存しました");
}
async function saveAISubSettings(){
  const prompt_exam = document.getElementById('promptExam').value;
  const prompt_diagnosis = document.getElementById('promptDiagnosis').value;
  await fetch(`${BASE}/api/settings`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ prompt_exam, prompt_diagnosis })
  });
  alert("検査/診療プロンプトを保存しました");
}
document.getElementById('aiSave').addEventListener('click', saveAISettings);
document.getElementById('aiSubSave').addEventListener('click', saveAISubSettings);

// -------------------- 初期化 --------------------
(async function init(){
  console.log('管理画面初期化完了 - タブ別遅延読み込み有効');
  if (typeof wrapWithLoading === 'function') {
    console.log('NCD Loading system ready');
  } else {
    console.error('Loading system initialization failed');
  }
  try {
    console.log('管理画面初期化: 診療所データを読み込み中...');
    await loadClinics();
    console.log('診療所データの読み込みが完了しました');
  } catch (error) {
    console.error('診療所データの初期読み込みに失敗:', error);
    const clinicsTbody = document.getElementById('clinicsTbody');
    if (clinicsTbody) {
      clinicsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">データの読み込みに失敗しました</td></tr>';
    }
  }
})();
</script>
</body>
</html>
