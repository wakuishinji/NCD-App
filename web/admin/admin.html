<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>NCD 管理ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- ヘッダー -->
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
      </div>
      <h1 class="text-xl font-bold">NCD 管理ダッシュボード</h1>
      <div class="w-[120px]"></div>
    </div>
  </header>

  <!-- メイン -->
  <main class="flex-1 max-w-6xl mx-auto p-4 md:p-6">
    <!-- タブ -->
    <div class="bg-white rounded shadow">
      <div class="border-b flex flex-wrap">
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-clinics">診療所リスト</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-cat-qual">資格分類</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-qual">資格マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-cat-test">検査分類</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-cat-service">診療分類</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-test">検査マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-service">診療マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-master-dept">標榜診療科マスター</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-ai">AI設定</button>
        <button class="tab px-4 py-3 text-sm font-semibold border-b-2 border-transparent hover:bg-gray-50" data-target="tab-todo">開発ToDo</button>
      </div>

      <!-- パネル群 -->
      <div class="p-4 md:p-6 space-y-8">

        <!-- 診療所リスト -->
        <section id="tab-clinics" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">診療所リストの管理</h2>
            <div class="flex gap-2">
              <a id="exportClinicsJson" class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" href="#" download>JSON出力</a>
              <a id="exportClinicsCsv"  class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" href="#" download>CSV出力</a>
            </div>
          </div>
          <div class="flex gap-3 mb-3">
            <input id="clinicQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（名称・住所）">
            <select id="clinicOrder" class="border rounded px-3 py-2">
              <option value="updated_desc">更新が新しい</option>
              <option value="updated_asc">更新が古い</option>
              <option value="name_asc">名称（昇順）</option>
              <option value="name_desc">名称（降順）</option>
            </select>
            <button id="clinicReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border px-2 py-1">ID</th>
                  <th class="border px-2 py-1">名称</th>
                  <th class="border px-2 py-1">住所</th>
                  <th class="border px-2 py-1">更新</th>
                  <th class="border px-2 py-1">操作</th>
                </tr>
              </thead>
              <tbody id="clinicsTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- 資格分類 -->
        <section id="tab-cat-qual" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">資格分類マスター</h2>
            <div class="text-sm text-gray-500">キー: <code>categories:qual</code></div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="catQualNew" class="border rounded px-3 py-2" placeholder="分類名を追加">
            <button id="catQualAdd" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">追加</button>
          </div>
          <div id="catQualList" class="divide-y bg-gray-50 border rounded"></div>
        </section>

        <!-- 資格マスター -->
        <section id="tab-master-qual" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">資格マスターの管理</h2>
            <div class="flex gap-2">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('qual','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('qual','csv')">CSV出力</button>
            </div>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstQualStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstQualQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称・issuer）">
            <button id="mstQualReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstQualList" class="space-y-3"></div>
        </section>

        <!-- 検査分類 -->
        <section id="tab-cat-test" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">検査分類マスター</h2>
            <div class="text-sm text-gray-500">キー: <code>categories:test</code></div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="catTestNew" class="border rounded px-3 py-2" placeholder="分類名を追加">
            <button id="catTestAdd" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">追加</button>
          </div>
          <div id="catTestList" class="divide-y bg-gray-50 border rounded"></div>
        </section>

        <!-- 診療分類 -->
        <section id="tab-cat-service" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">診療分類マスター</h2>
            <div class="text-sm text-gray-500">キー: <code>categories:service</code></div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="catSvcNew" class="border rounded px-3 py-2" placeholder="分類名を追加">
            <button id="catSvcAdd" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">追加</button>
          </div>
          <div id="catSvcList" class="divide-y bg-gray-50 border rounded"></div>
        </section>

        <!-- 検査マスター -->
        <section id="tab-master-test" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">検査マスターの管理</h2>
            <div class="flex gap-2">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('test','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('test','csv')">CSV出力</button>
            </div>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstTestStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstTestQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称）">
            <button id="mstTestReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstTestList" class="space-y-3"></div>
        </section>

        <!-- 診療マスター -->
        <section id="tab-master-service" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">診療マスターの管理</h2>
            <div class="flex gap-2">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('service','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('service','csv')">CSV出力</button>
            </div>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstSvcStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstSvcQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（分類・名称）">
            <button id="mstSvcReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstSvcList" class="space-y-3"></div>
        </section>

        <!-- 標榜診療科マスター -->
        <section id="tab-master-dept" class="tab-panel hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-blue-800">標榜診療科マスターの管理</h2>
            <div class="flex gap-2">
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('department','json')">JSON出力</button>
              <button class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800" onclick="exportMaster('department','csv')">CSV出力</button>
            </div>
          </div>
          <div class="bg-white border rounded p-4 mb-4">
            <h3 class="font-semibold text-gray-800 mb-2">診療科の手動追加</h3>
            <div class="flex flex-col gap-2 md:flex-row">
              <input id="mstDeptNew" class="border rounded px-3 py-2 flex-1" placeholder="診療科名（例: 内科）">
              <button id="mstDeptAdd" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">候補として追加</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">追加された診療科は候補ステータスで登録されます。承認すると施設詳細画面で選択できるようになります。</p>
          </div>
          <div class="flex gap-2 mb-3">
            <select id="mstDeptStatus" class="border rounded px-3 py-2">
              <option value="">全て</option>
              <option value="candidate">候補</option>
              <option value="approved">承認</option>
              <option value="archived">廃止</option>
            </select>
            <input id="mstDeptQ" class="border rounded px-3 py-2 flex-1" placeholder="検索（名称・統合名）">
            <button id="mstDeptReload" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">再読込</button>
          </div>
          <div id="mstDeptList" class="space-y-3"></div>
        </section>

        <!-- AI設定 -->
        <section id="tab-ai" class="tab-panel hidden">
          <h2 class="text-lg font-semibold text-blue-800 mb-3">AIモデル／プロンプト設定</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-gray-50 border rounded p-4">
              <h3 class="font-semibold mb-2">共通（/api/generate 用）</h3>
              <label class="block text-sm text-gray-700 mb-1">モデル（例: gpt-4o-mini）</label>
              <input id="aiModel" class="w-full border rounded px-3 py-2" placeholder="gpt-4o-mini">
              <label class="block text-sm text-gray-700 mt-3 mb-1">プロンプト（system）</label>
              <textarea id="aiPrompt" rows="5" class="w-full border rounded px-3 py-2" placeholder="医療説明用のサンプルを作ってください"></textarea>
              <button id="aiSave" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">保存</button>
            </div>
            <div class="bg-gray-50 border rounded p-4">
              <h3 class="font-semibold mb-2">検査／診療 用（任意）</h3>
              <label class="block text-sm text-gray-700 mb-1">検査プロンプト</label>
              <textarea id="promptExam" rows="5" class="w-full border rounded px-3 py-2"></textarea>
              <label class="block text-sm text-gray-700 mt-3 mb-1">診療プロンプト</label>
              <textarea id="promptDiagnosis" rows="5" class="w-full border rounded px-3 py-2"></textarea>
              <button id="aiSubSave" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">保存</button>
            </div>
          </div>
        </section>

        <!-- 開発ToDo -->
        <section id="tab-todo" class="tab-panel hidden">
          <h2 class="text-lg font-semibold text-blue-800 mb-3">開発ToDo管理</h2>
          <div class="border rounded overflow-hidden">
            <iframe src="todo.html" title="開発ToDo管理" class="w-full h-[70vh]"></iframe>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- フッター -->
  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

<script>
const BASE = "https://ncd-app.altry.workers.dev";
const DEPARTMENT_CATEGORY = "標榜診療科";

// -------------------- タブ --------------------
const tabs = document.querySelectorAll(".tab");
const panels = document.querySelectorAll(".tab-panel");
function showTab(id){
  panels.forEach(p=>p.classList.add("hidden"));
  document.getElementById(id)?.classList.remove("hidden");
  tabs.forEach(t=>t.classList.toggle("border-blue-600", t.dataset.target===id));
}
tabs.forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.target)));
showTab("tab-clinics");

// -------------------- 診療所リスト --------------------
let clinicsRaw = [];
async function loadClinics(){
  const r = await fetch(`${BASE}/api/listClinics`);
  const d = await r.json();
  clinicsRaw = (d.ok && d.clinics) ? d.clinics : [];
  renderClinics();
}
function renderClinics(){
  const q = (document.getElementById('clinicQ').value || '').trim().toLowerCase();
  const order = document.getElementById('clinicOrder').value;
  let list = [...clinicsRaw];
  if (q) {
    list = list.filter(c => (c.name||'').toLowerCase().includes(q) || (c.address||'').toLowerCase().includes(q));
  }
  list.sort((a,b)=>{
    if (order==='updated_desc') return (b.updated_at||0)-(a.updated_at||0);
    if (order==='updated_asc') return (a.updated_at||0)-(b.updated_at||0);
    if (order==='name_asc') return (a.name||'').localeCompare(b.name||'');
    if (order==='name_desc') return (b.name||'').localeCompare(a.name||'');
    return 0;
  });
  const tb = document.getElementById('clinicsTbody');
  tb.innerHTML = "";
  list.forEach(c=>{
    const tr = document.createElement('tr');
    const updated = c.updated_at ? new Date(c.updated_at*1000).toLocaleString() : '-';
    tr.innerHTML = `
      <td class="border px-2 py-1">${c.id||'-'}</td>
      <td class="border px-2 py-1">${c.name||''}</td>
      <td class="border px-2 py-1">${c.address||''}</td>
      <td class="border px-2 py-1">${updated}</td>
      <td class="border px-2 py-1">
        <button class="text-blue-700 underline mr-2" onclick='selectClinic(${JSON.stringify(c)})'>選択</button>
        <button class="text-red-700 underline" onclick='deleteClinic("${c.id||""}","${(c.name||"").replace(/"/g,"&quot;")}")'>削除</button>
      </td>`;
    tb.appendChild(tr);
  });

  // エクスポートリンク
  document.getElementById('exportClinicsJson').href = `${BASE}/api/exportClinics?format=json`;
  document.getElementById('exportClinicsCsv').href  = `${BASE}/api/exportClinics?format=csv`;
}
function selectClinic(c){
  localStorage.setItem('selectedClinic', JSON.stringify(c));
  alert(`選択しました: ${c.name}`);
}
async function deleteClinic(id, name){
  if (!id && !name) { alert("削除対象のID/名称が不明です"); return; }
  if (!confirm(`削除してよろしいですか？\n${name || id}`)) return;
  const r = await fetch(`${BASE}/api/deleteClinic`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ id, name })
  });
  if (!r.ok) { alert("削除に失敗しました"); return; }
  await loadClinics();
}
document.getElementById('clinicReload').addEventListener('click', loadClinics);
document.getElementById('clinicOrder').addEventListener('change', renderClinics);
document.getElementById('clinicQ').addEventListener('input', renderClinics);

// -------------------- 分類（検査/診療） --------------------
async function loadCategories(type, listElId){
  const r = await fetch(`${BASE}/api/listCategories?type=${type}`);
  const d = await r.json();
  const cats = (d.ok ? d.categories : []) || [];
  const box = document.getElementById(listElId);
  box.innerHTML = "";
  cats.forEach(cat=>{
    const row = document.createElement('div');
    row.className = "flex items-center justify-between px-3 py-2";
    row.innerHTML = `
      <div class="flex-1">${cat}</div>
      <div class="flex gap-2">
        <button class="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300" onclick='renameCategory("${type}","${cat.replace(/"/g,'&quot;')}")'>改名</button>
        <button class="px-2 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200" onclick='deleteCategory("${type}","${cat.replace(/"/g,'&quot;')}")'>削除</button>
      </div>`;
    box.appendChild(row);
  });
}
async function addCategory(type, inputId){
  const name = document.getElementById(inputId).value.trim();
  if (!name) return;
  await fetch(`${BASE}/api/addCategory`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, name })
  });
  document.getElementById(inputId).value="";
  await loadCategories(type, type==='test'?'catTestList':'catSvcList');
}
async function renameCategory(type, oldName){
  const newName = prompt("新しい分類名", oldName);
  if (!newName || newName===oldName) return;
  await fetch(`${BASE}/api/renameCategory`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, oldName, newName })
  });
  await loadCategories(type, type==='test'?'catTestList':'catSvcList');
}
async function deleteCategory(type, name){
  if (!confirm(`削除しますか？\n${name}`)) return;
  await fetch(`${BASE}/api/deleteCategory`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, name })
  });
  await loadCategories(type, type==='test'?'catTestList':'catSvcList');
}
document.getElementById('catTestAdd').addEventListener('click', ()=>addCategory('test','catTestNew'));
document.getElementById('catSvcAdd').addEventListener('click',  ()=>addCategory('service','catSvcNew'));

// -------------------- マスター（検査/診療） --------------------
async function loadMaster(type, listElId, statusSelId, qId){
  const status = document.getElementById(statusSelId).value;
  const q = (document.getElementById(qId).value||'').trim().toLowerCase();
  const url = new URL(`${BASE}/api/listMaster`);
  url.searchParams.set("type", type);
  if (status) url.searchParams.set("status", status);
  url.searchParams.set("includeSimilar", "true");
  const r = await fetch(url.toString());
  const d = await r.json();
  const items = (d.ok ? d.items : []) || [];
  const box = document.getElementById(listElId);
  box.innerHTML = "";

  const filtered = items.filter(it=>{
    if (!q) return true;
    const s = `${it.category} ${it.name} ${it.canonical_name||''}`.toLowerCase();
    return s.includes(q);
  });

  filtered.forEach(it=>{
    const div = document.createElement('div');
    div.className = "border rounded p-3 bg-white space-y-2";
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-semibold text-blue-800">${it.category} / ${it.name}</div>
        <div class="text-xs text-gray-500">count: ${it.count||0} / status: ${it.status||'-'}</div>
      </div>
      <div class="mt-2 grid md:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-gray-600">canonical_name（統合名）</label>
          <input class="w-full border rounded px-2 py-1" value="${(it.canonical_name||'').replace(/"/g,'&quot;')}" data-k="cn">
        </div>
        <div>
          <label class="block text-xs text-gray-600">status</label>
          <select class="w-full border rounded px-2 py-1" data-k="st">
            ${["candidate","approved","archived"].map(s=>`<option ${s===(it.status||'')?'selected':''}>${s}</option>`).join("")}
          </select>
        </div>
      </div>
      <div class="mt-2">
        <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 hidden" data-action="update" disabled>更新</button>
      </div>
      ${Array.isArray(it.similarMatches) && it.similarMatches.length ? `
        <div class="mt-2 bg-yellow-50 border border-yellow-200 rounded p-2 text-xs text-yellow-900">
          <div class="font-semibold mb-1">重複候補 (score ≥ 0.92)</div>
          <ul class="space-y-1">
            ${it.similarMatches.map(m=>`
              <li class="flex items-center justify-between gap-2">
                <span>${m.name}${m.canonical_name && m.canonical_name!==m.name ? ` / ${m.canonical_name}` : ''} <span class="text-[11px] text-yellow-700">(status: ${m.status || '-'}, sim: ${m.similarity})</span></span>
                <button type="button" class="text-blue-700 underline" data-action="use-similar" data-value="${(m.canonical_name || m.name).replace(/"/g,'&quot;')}">統合名に採用</button>
              </li>
            `).join('')}
          </ul>
        </div>
      ` : ''}
      <div class="mt-2 text-xs text-gray-500">sources: ${(it.sources||[]).join(", ")}</div>
    `;

    const updateBtn = div.querySelector('button[data-action="update"]');
    updateBtn.addEventListener('click', () => {
      updateMaster(type, it.category, it.name, updateBtn);
    });

    const cnInput = div.querySelector('input[data-k="cn"]');
    const stSelect = div.querySelector('select[data-k="st"]');
    applyStatusAppearance(stSelect);
    const initialCn = cnInput.value;
    const initialSt = stSelect.value;

    function refreshButtonState(){
      const changed = cnInput.value !== initialCn || stSelect.value !== initialSt;
      updateBtn.disabled = !changed;
      updateBtn.classList.toggle('hidden', !changed);
    }

    cnInput.addEventListener('input', refreshButtonState);
    stSelect.addEventListener('change', () => {
      refreshButtonState();
      applyStatusAppearance(stSelect);
    });
    refreshButtonState();

    div.querySelectorAll('button[data-action="use-similar"]').forEach(btn => {
      btn.addEventListener('click', () => {
        cnInput.value = btn.dataset.value || '';
        cnInput.dispatchEvent(new Event('input', { bubbles: true }));
      });
    });

    box.appendChild(div);
  });
}
async function updateMaster(type, category, name, btn){
  const root = btn.closest('.border');
  const cn = root.querySelector('input[data-k="cn"]').value;
  const st = root.querySelector('select[data-k="st"]').value;
  await fetch(`${BASE}/api/updateMasterItem`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ type, category, name, canonical_name: cn, status: st })
  });
  alert("更新しました");
  btn.disabled = true;
  btn.classList.add('hidden');
}
function exportMaster(type, format){
  const url = `${BASE}/api/exportMaster?type=${type}&format=${format}`;
  window.open(url, "_blank");
}

function applyStatusAppearance(selectEl){
  if (!selectEl) return;
  const accentClasses = [
    'bg-green-50','text-green-700','border-green-300',
    'bg-red-50','text-red-700','border-red-300',
    'bg-gray-100','text-gray-600','border-gray-300'
  ];
  selectEl.classList.remove(...accentClasses);
  switch (selectEl.value) {
    case 'approved':
      selectEl.classList.add('bg-green-50','text-green-700','border-green-300');
      break;
    case 'candidate':
      selectEl.classList.add('bg-red-50','text-red-700','border-red-300');
      break;
    case 'archived':
      selectEl.classList.add('bg-gray-100','text-gray-600','border-gray-300');
      break;
    default:
      break;
  }
}

function applyStatusAppearance(selectEl){
  if (!selectEl) return;
  const accentClasses = [
    'bg-green-50','text-green-700','border-green-300',
    'bg-red-50','text-red-700','border-red-300',
    'bg-gray-100','text-gray-600','border-gray-300'
  ];
  selectEl.classList.remove(...accentClasses);
  switch (selectEl.value) {
    case 'approved':
      selectEl.classList.add('bg-green-50','text-green-700','border-green-300');
      break;
    case 'candidate':
      selectEl.classList.add('bg-red-50','text-red-700','border-red-300');
      break;
    case 'archived':
      selectEl.classList.add('bg-gray-100','text-gray-600','border-gray-300');
      break;
    default:
      break;
  }
}

function bindStatusFilterAppearance(id){
  const el = document.getElementById(id);
  if (!el) return;
  const handler = () => applyStatusAppearance(el);
  el.addEventListener('change', handler);
  handler();
}

async function addDepartmentMaster(){
  const input = document.getElementById('mstDeptNew');
  if (!input) return;
  const name = (input.value || '').trim();
  if (!name) {
    alert('診療科名を入力してください');
    input.focus();
    return;
  }
  try {
    const res = await fetch(`${BASE}/api/addMasterItem`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: 'department', category: DEPARTMENT_CATEGORY, name, source: 'admin-manual' })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    input.value = '';
    await loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ');
    alert('候補として追加しました。ステータスを承認に変更すると施設詳細で選択できます。');
  } catch (err) {
    alert('診療科の追加に失敗しました: ' + err.message);
  }
}

// イベント
document.getElementById('mstTestReload').addEventListener('click', ()=>loadMaster('test','mstTestList','mstTestStatus','mstTestQ'));
document.getElementById('mstSvcReload').addEventListener('click',  ()=>loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ'));
document.getElementById('mstTestStatus').addEventListener('change', ()=>loadMaster('test','mstTestList','mstTestStatus','mstTestQ'));
document.getElementById('mstSvcStatus').addEventListener('change', ()=>loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ'));
document.getElementById('mstTestQ').addEventListener('input', ()=>loadMaster('test','mstTestList','mstTestStatus','mstTestQ'));
document.getElementById('mstSvcQ').addEventListener('input',  ()=>loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ'));
document.getElementById('mstDeptAdd').addEventListener('click', addDepartmentMaster);
document.getElementById('mstDeptReload').addEventListener('click', ()=>loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ'));
document.getElementById('mstDeptStatus').addEventListener('change', ()=>loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ'));
document.getElementById('mstDeptQ').addEventListener('input',  ()=>loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ'));
bindStatusFilterAppearance('mstTestStatus');
bindStatusFilterAppearance('mstSvcStatus');
bindStatusFilterAppearance('mstDeptStatus');
bindStatusFilterAppearance('mstQualStatus');
// 資格分類
document.getElementById('catQualAdd').addEventListener('click', ()=>addCategory('qual','catQualNew'));

// 資格マスター
document.getElementById('mstQualReload').addEventListener('click', ()=>loadMaster('qual','mstQualList','mstQualStatus','mstQualQ'));
document.getElementById('mstQualStatus').addEventListener('change', ()=>loadMaster('qual','mstQualList','mstQualStatus','mstQualQ'));
document.getElementById('mstQualQ').addEventListener('input', ()=>loadMaster('qual','mstQualList','mstQualStatus','mstQualQ'));

// -------------------- AI設定 --------------------
async function loadAISettings(){
  const r = await fetch(`${BASE}/api/settings`);
  const d = await r.json();
  document.getElementById('aiModel').value = d.model || '';
  document.getElementById('aiPrompt').value = d.prompt || '';
  document.getElementById('promptExam').value = d.prompt_exam || '';
  document.getElementById('promptDiagnosis').value = d.prompt_diagnosis || '';
}
async function saveAISettings(){
  const model = document.getElementById('aiModel').value.trim();
  const prompt = document.getElementById('aiPrompt').value;
  await fetch(`${BASE}/api/settings`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ model, prompt })
  });
  alert("共通モデル/プロンプトを保存しました");
}
async function saveAISubSettings(){
  const prompt_exam = document.getElementById('promptExam').value;
  const prompt_diagnosis = document.getElementById('promptDiagnosis').value;
  await fetch(`${BASE}/api/settings`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ prompt_exam, prompt_diagnosis })
  });
  alert("検査/診療プロンプトを保存しました");
}
document.getElementById('aiSave').addEventListener('click', saveAISettings);
document.getElementById('aiSubSave').addEventListener('click', saveAISubSettings);

// -------------------- 初期化 --------------------
(async function init(){
  // クリニック
  await loadClinics();

  // 分類
  await loadCategories('test','catTestList');
  await loadCategories('service','catSvcList');
  await loadCategories('qual','catQualList');

  // マスター
  await loadMaster('test','mstTestList','mstTestStatus','mstTestQ');
  await loadMaster('service','mstSvcList','mstSvcStatus','mstSvcQ');
  await loadMaster('qual','mstQualList','mstQualStatus','mstQualQ');
  await loadMaster('department','mstDeptList','mstDeptStatus','mstDeptQ');

  // AI設定
  await loadAISettings();
})();
</script>
</body>
</html>
