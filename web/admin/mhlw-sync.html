<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>厚労省ID同期 - NCD 管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../js/auth.js" defer></script>
  <script src="../js/sessionGuard.js" defer></script>
  <script src="../js/vendor/fflate.min.js" defer></script>
  <script src="../js/vendor/mhlwCsvUtils.js" defer></script>
  <script src="../js/mhlwSync.js" defer></script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-800" data-require-role="systemRoot" data-guard-message="システム管理者専用ページです。トップページへ戻ります。">
  <main class="mx-auto flex min-h-screen max-w-4xl flex-col gap-8 px-4 py-10">
    <section class="rounded-lg bg-white p-6 shadow">
      <header class="mb-6 flex flex-col gap-2">
        <a href="/admin/admin.html" class="self-start text-sm text-blue-700 underline decoration-blue-400 hover:text-blue-900">← 管理ハブへ戻る</a>
        <div>
          <h1 class="text-xl font-semibold text-blue-900">厚労省ID同期</h1>
          <p class="mt-1 text-sm text-slate-600">厚労省公開データの施設IDをNCDの診療所レコードへ紐付け、住所・連絡先等の情報を同期します。</p>
        </div>
      </header>

      <div class="space-y-4">
        <div class="rounded border border-blue-200 bg-blue-50/70 px-4 py-3 text-sm text-blue-900">
          <p class="font-semibold">手順</p>
          <ol class="mt-2 list-decimal space-y-1 pl-5">
            <li><code>scripts/importMhlwToD1.mjs --truncate --execute</code> で最新 CSV を Cloudflare D1 (`mhlw_*` テーブル) に投入する。</li>
            <li>未紐付けの診療所一覧から対象を選び、都道府県を指定して厚労省データを検索し ID を登録する。</li>
            <li>必要に応じて「公開データから同期」ボタンで住所・電話等を更新。</li>
          </ol>
          <p class="mt-2 text-xs text-blue-800">※ 下の「旧方式」セクションはバックアップ用途として残しています。通常運用では D1 への直接取り込みを実施してください。</p>
        </div>

        <section class="rounded border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
          <header class="flex flex-col gap-1 border-b border-slate-200 pb-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-base font-semibold text-blue-900">厚労省データアップロード（旧方式 / R2 バックアップ）</h2>
              <p class="mt-1 text-xs text-slate-500">ブラウザ上で CSV を整形し、JSON を R2 (`mhlw/facilities.json`) に保存します。D1 を更新するには別途 CLI で <code>scripts/importMhlwToD1.mjs</code> を実行してください。</p>
            </div>
            <div id="mhlwMetaInfo" class="text-xs text-slate-500 sm:text-right"></div>
          </header>

          <div class="mt-3 grid gap-4">
            <form id="mhlwUploadCsvForm" class="grid gap-3">
              <div class="grid gap-3 md:grid-cols-2">
                <div>
                  <label class="block text-xs font-medium text-slate-600" for="mhlwClinicFacilityCsv">診療所 施設票 CSV (.csv/.csv.gz)</label>
                  <input id="mhlwClinicFacilityCsv" name="clinicFacility" type="file" accept=".csv,.gz,text/csv,application/gzip" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-slate-600" for="mhlwClinicScheduleCsv">診療所 診療科・診療時間票 CSV</label>
                  <input id="mhlwClinicScheduleCsv" name="clinicSchedule" type="file" accept=".csv,.gz,text/csv,application/gzip" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-slate-600" for="mhlwHospitalFacilityCsv">病院 施設票 CSV</label>
                  <input id="mhlwHospitalFacilityCsv" name="hospitalFacility" type="file" accept=".csv,.gz,text/csv,application/gzip" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-slate-600" for="mhlwHospitalScheduleCsv">病院 診療科・診療時間票 CSV</label>
                  <input id="mhlwHospitalScheduleCsv" name="hospitalSchedule" type="file" accept=".csv,.gz,text/csv,application/gzip" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
                </div>
              </div>
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                <button type="submit" class="inline-flex items-center justify-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700">CSV４種からJSONを生成してR2へアップロード（旧方式）</button>
                <p class="text-xs text-slate-500">※ バックアップ用の旧方式です。最新データは <code>scripts/importMhlwToD1.mjs</code> で D1 に取り込んでください。</p>
              </div>
            </form>
            <p id="mhlwUploadCsvStatus" data-base-class="text-xs text-slate-500"></p>

            <details class="rounded border border-dashed border-slate-300 bg-white p-4 text-xs leading-relaxed text-slate-600">
              <summary class="cursor-pointer font-semibold text-slate-700">CLI でのアップロード手順（バックアップ）</summary>
              <pre class="mt-2 overflow-auto rounded bg-slate-900 px-3 py-2 text-[11px] text-slate-100">node scripts/importMhlwFacilities.mjs \ 
  --file clinic:data/medical-open-data/02-1_clinic_facility_info_20250601.csv.gz \ 
  --file hospital:data/medical-open-data/01-1_hospital_facility_info_20250601.csv.gz \ 
  --schedule clinic:data/medical-open-data/02-2_clinic_speciality_hours_20250601.csv.gz \ 
  --schedule hospital:data/medical-open-data/01-2_hospital_speciality_hours_20250601.csv.gz \ 
  --outfile tmp/mhlw-facilities.json

export SYSTEM_ROOT_TOKEN="{systemRoot の Bearer トークン}"
node scripts/uploadMhlwToR2.mjs --json tmp/mhlw-facilities.json
</pre>
            </details>
            <button type="button" id="mhlwMetaRefresh" class="inline-flex w-fit items-center justify-center gap-2 rounded border border-blue-200 bg-blue-50 px-3 py-1.5 text-xs font-semibold text-blue-800 transition hover:border-blue-300 hover:bg-blue-100">情報更新</button>
          </div>
        </section>

        <div class="flex flex-col gap-2 border-t border-slate-200 pt-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-base font-semibold text-blue-900">厚労省ID未連携の診療所</h2>
            <p id="clinicListStatus" class="text-sm text-slate-500">読み込み中です…</p>
          </div>
          <div class="flex gap-2">
            <button type="button" id="refreshClinicList" class="inline-flex items-center gap-2 rounded border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100">
              一覧を再読込
            </button>
            <button type="button" id="reloadMhlwDict" class="inline-flex items-center gap-2 rounded border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-semibold text-blue-800 transition hover:border-blue-300 hover:bg-blue-100">
              CSV再読込
            </button>
          </div>
        </div>

        <div id="clinicList" class="space-y-3"></div>

        <div class="mt-8 flex flex-col gap-2 border-t border-slate-200 pt-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-base font-semibold text-blue-900">厚労省ID設定済みの診療所</h2>
            <p id="linkedClinicListStatus" class="text-sm text-slate-500">読み込み中です…</p>
          </div>
        </div>
        <div id="linkedClinicList" class="space-y-3"></div>
      </div>
    </section>

    <section class="rounded-lg bg-white p-6 shadow">
      <header class="mb-4">
        <h2 class="text-lg font-semibold text-blue-900">厚労省データプレビュー</h2>
        <p class="mt-1 text-sm text-slate-600">整形済みJSON（施設辞書）の先頭数件を表示します。必要に応じて確認してください。</p>
      </header>
      <div class="rounded border border-slate-200 bg-slate-50 p-3">
        <pre id="mhlwPreview" class="max-h-64 overflow-auto text-xs text-slate-700">読み込み中...</pre>
      </div>
    </section>
  </main>
</body>
</html>
