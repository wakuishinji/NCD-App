<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>開発ToDo管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../js/auth.js" defer></script>
  <script src="../js/sessionGuard.js" defer></script>
</head>
<body class="bg-gray-100 text-gray-800" data-require-role="systemRoot" data-guard-message="システム管理者専用ページです。トップページへ戻ります。">
  <!-- 共通ヘッダー -->
  <header class="w-full bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-4xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex flex-wrap items-center gap-2">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
      </div>
      <h1 class="text-lg md:text-xl font-bold text-center md:text-left md:flex-1">開発ToDo</h1>
      <div class="hidden md:block md:w-[100px]" aria-hidden="true"></div>
    </div>
  </header>
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">📋 開発ToDo管理</h1>

    <!-- カテゴリー追加 -->
    <div class="flex gap-2 mb-4">
      <input id="newCategory" type="text" placeholder="新しいカテゴリー名"
        class="border rounded p-2 flex-1">
      <button onclick="addCategory()" class="bg-blue-600 text-white px-4 py-2 rounded">
        カテゴリー追加
      </button>
    </div>

    <!-- ToDo一覧 -->
    <div id="todoContainer" class="space-y-6"></div>

    <!-- 保存ボタン -->
    <div class="mt-6">
      <button onclick="saveTodos()" class="bg-green-600 text-white px-6 py-3 rounded shadow">
        💾 保存
      </button>
    </div>
  </div>

<script>
const DEFAULT_API_BASE = ["localhost", "127.0.0.1"].includes(location.hostname)
  ? ""
  : "https://ncd-app.altry.workers.dev";
const API_BASE = (window.API_BASE_OVERRIDE ?? DEFAULT_API_BASE).replace(/\/$/, "");

function apiUrl(path) {
  const normalized = path.startsWith("/") ? path : `/${path}`;
  return API_BASE ? `${API_BASE}${normalized}` : normalized;
}

let todos = [
  {category: "フロントエンド", title: "フォームバリデーション実装", status: "open", priority: "P1", createdAt: "2025-01-01T09:00:00+09:00"},
  {category: "サーバー", title: "Let’s Encrypt 自動更新", status: "done", priority: "P2", createdAt: "2025-01-05T09:00:00+09:00"}
];

async function loadTodos() {
  try {
    const res = await fetch(apiUrl("/api/todo/list"));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (Array.isArray(data?.todos)) {
      todos = data.todos.map((t) => ({
        category: t.category ?? "",
        title: t.title ?? "",
        status: t.status === "done" ? "done" : "open",
        priority: ["P1", "P2", "P3"].includes(t.priority) ? t.priority : "P3",
        createdAt: t.createdAt ?? new Date().toISOString(),
      }));
    }
  } catch (err) {
    console.warn("todo load failed", err);
  } finally {
    renderTodos();
  }
}

function formatDate(isoString) {
  if (!isoString) return "-";
  const date = new Date(isoString);
  if (Number.isNaN(date.getTime())) return isoString;
  return date.toLocaleString("ja-JP", { hour12: false });
}

function renderTodos() {
  const container = document.getElementById("todoContainer");
  container.innerHTML = "";

  const categories = [...new Set(todos.map(t => t.category))];
  categories.forEach(cat => {
    const section = document.createElement("div");
    section.innerHTML = `<h2 class="text-xl font-semibold mb-2">${cat}</h2>`;

    todos
      .map((t, idx) => ({ todo: t, idx }))
      .filter(({ todo }) => todo.category === cat)
      .forEach(({ todo, idx }) => {
      const item = document.createElement("div");
      item.className = "flex flex-col gap-1 mb-3 sm:flex-row sm:items-center sm:gap-2";
      item.innerHTML = `
        <div class="flex items-center gap-2">
          <input type="checkbox" ${todo.status === "done" ? "checked" : ""} 
          onchange="toggleStatus(${idx})" class="w-4 h-4">
          <input type="text" value="${todo.title}" onchange="editTitle(${idx}, this.value)" 
          class="border rounded p-1 flex-1">
          <select onchange="editPriority(${idx}, this.value)" class="border rounded p-1">
            <option ${todo.priority==="P1"?"selected":""}>P1</option>
            <option ${todo.priority==="P2"?"selected":""}>P2</option>
            <option ${todo.priority==="P3"?"selected":""}>P3</option>
          </select>
          <button onclick="deleteTask(${idx})" class="text-red-600 text-sm font-semibold">
            削除
          </button>
        </div>
        <div class="text-xs text-gray-500 pl-6 sm:pl-10">作成: ${formatDate(todo.createdAt)}</div>
      `;
      section.appendChild(item);
    });

    // 新規タスク追加フォーム
    const form = document.createElement("div");
    form.className = "flex gap-2 mt-2";
    form.innerHTML = `
      <input id="newTask-${cat}" type="text" placeholder="新しいタスク" class="border rounded p-2 flex-1">
      <button onclick="addTask('${cat}')" class="bg-blue-600 text-white px-3 rounded">追加</button>
    `;
    section.appendChild(form);

    container.appendChild(section);
  });
}

function addCategory() {
  const name = document.getElementById("newCategory").value.trim();
  if (!name) return;
  todos.push({
    category: name,
    title: "新しいタスク",
    status: "open",
    priority: "P3",
    createdAt: new Date().toISOString()
  });
  document.getElementById("newCategory").value = "";
  renderTodos();
}

function addTask(cat) {
  const input = document.getElementById(`newTask-${cat}`);
  const title = input.value.trim();
  if (!title) return;
  todos.push({
    category: cat,
    title,
    status: "open",
    priority: "P3",
    createdAt: new Date().toISOString()
  });
  input.value = "";
  renderTodos();
}

function toggleStatus(idx) { todos[idx].status = todos[idx].status === "done" ? "open" : "done"; }
function editTitle(idx, val) { todos[idx].title = val; }
function editPriority(idx, val) { todos[idx].priority = val; }
function deleteTask(idx) { todos.splice(idx, 1); renderTodos(); }

async function saveTodos() {
  try {
    const res = await fetch(apiUrl("/api/todo/save"), {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ todos })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (Array.isArray(data?.todos)) {
      todos = data.todos;
      renderTodos();
    }
    alert("保存しました！");
  } catch (err) {
    console.error("todo save failed", err);
    alert("保存に失敗しました");
  }
}

loadTodos();
</script>
</body>
</html>
