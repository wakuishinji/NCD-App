<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アカウント詳細 - NCD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../js/auth.js" defer></script>
  <script src="../js/sessionGuard.js" defer></script>
  <script src="../js/header.js" defer></script>
  <script src="../js/userMenu.js" defer></script>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col" data-require-role="clinicStaff" data-redirect-to="/index.html" data-guard-message="ログインが必要です。トップページに戻ります。">
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="mx-auto flex max-w-5xl items-center justify-between gap-3 px-4 py-4">
      <div class="flex items-center gap-3">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
        <a href="/clinicList.html" class="hidden md:inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">施設一覧</a>
      </div>
      <h1 class="text-lg md:text-xl font-bold">アカウント詳細</h1>
      <div class="flex items-center gap-2">
        <div class="relative" data-user-menu></div>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <section class="mx-auto mt-8 w-full max-w-4xl rounded-lg bg-white p-6 shadow">
      <header class="border-b border-slate-200 pb-4">
        <h2 class="text-xl font-semibold text-slate-900">サインイン情報</h2>
        <p class="mt-1 text-sm text-slate-500">現在ログイン中のユーザー情報とロールを確認できます。</p>
      </header>
      <dl id="accountDetails" class="mt-6 grid grid-cols-1 gap-4 text-sm text-slate-700 sm:grid-cols-2">
        <div>
          <dt class="font-medium text-slate-600">表示名</dt>
          <dd id="accountDisplayName" class="mt-1 rounded border border-slate-200 bg-slate-50 px-3 py-2 text-slate-900">-</dd>
        </div>
        <div>
          <dt class="font-medium text-slate-600">メールアドレス</dt>
          <dd id="accountEmail" class="mt-1 rounded border border-slate-200 bg-slate-50 px-3 py-2 text-slate-900">-</dd>
        </div>
        <div class="sm:col-span-2">
          <dt class="font-medium text-slate-600">所属</dt>
          <dd id="accountMemberships" class="mt-1 space-y-2 rounded border border-slate-200 bg-slate-50 px-3 py-2 text-slate-900">-</dd>
        </div>
      </dl>
      <div class="mt-6 flex flex-col gap-3 border-t border-slate-200 pt-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-xs text-slate-500">セッション情報が更新されると自動的に反映されます。</div>
        <button id="logoutButton" type="button" class="inline-flex items-center justify-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700">
          ログアウト
        </button>
        <p id="logoutStatus" class="text-xs text-slate-500"></p>
      </div>
    </section>
  </main>

  <footer class="bg-slate-200 py-4 text-center text-sm text-slate-600">
    © 2025 中野区医師会 - Nakano Clinic Database
  </footer>

  <script>
    (function initAccountPage(global) {
      const DEFAULT_API_BASE = 'https://ncd-app.altry.workers.dev';
      const displayNameEl = document.getElementById('accountDisplayName');
      const emailEl = document.getElementById('accountEmail');
      const membershipsEl = document.getElementById('accountMemberships');
      const logoutButton = document.getElementById('logoutButton');
      const logoutStatusEl = document.getElementById('logoutStatus');
      let membershipDetails = [];
      const clinicNameCache = new Map();

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function resolveApiBase() {
        if (global.NcdAuth && typeof global.NcdAuth.resolveApiBase === 'function') {
          return global.NcdAuth.resolveApiBase();
        }
        try {
          const stored = global.localStorage?.getItem('ncdApiBase') || global.localStorage?.getItem('ncdApiBaseUrl');
          if (stored) {
            return stored.trim().replace(/\/$/, '');
          }
        } catch (_) {}
        return DEFAULT_API_BASE;
      }

      function normalizeMembershipEntries(rawList, auth) {
        if (global.NcdAuth && typeof global.NcdAuth.getMemberships === 'function') {
          const resolved = global.NcdAuth.getMemberships(auth);
          if (Array.isArray(resolved) && resolved.length) {
            return resolved;
          }
        }
        const list = Array.isArray(rawList) ? rawList : [];
        return list.map((value) => {
          if (typeof value === 'object' && value && value.id) {
            return value;
          }
          const id = typeof value === 'string' ? value : String(value ?? '');
          return {
            id,
            clinicId: null,
            roles: [],
            primaryRole: '',
            status: 'active',
            label: id,
          };
        });
      }

      function membershipRoles(entry) {
        const roles = Array.isArray(entry?.roles) ? entry.roles : [];
        if (!roles.length && entry?.primaryRole) {
          roles.push(entry.primaryRole);
        }
        return roles;
      }

      async function loadClinicName(clinicId, apiBase) {
        if (!clinicId) return clinicId || '';
        if (clinicNameCache.has(clinicId)) {
          return clinicNameCache.get(clinicId);
        }
        try {
          const res = await fetch(`${apiBase}/api/clinicDetail?id=${encodeURIComponent(clinicId)}`);
          if (res.ok) {
            const data = await res.json();
            const name = data?.clinic?.name || clinicId;
            clinicNameCache.set(clinicId, name);
            return name;
          }
        } catch (err) {
          console.warn('[account] failed to fetch clinic name', clinicId, err);
        }
        clinicNameCache.set(clinicId, clinicId);
        return clinicId;
      }

      async function renderMembershipList(entries) {
        if (!membershipsEl) return;
        if (!entries || !entries.length) {
          membershipsEl.innerHTML = '<span class="text-slate-500">所属なし</span>';
          return;
        }
        const apiBase = resolveApiBase();
        const rendered = [];
        for (const entry of entries) {
          const clinicId = entry?.clinicId || '';
          const clinicName = await loadClinicName(clinicId, apiBase);
          const displayName = clinicName || entry?.clinicName || entry?.label || '(施設未設定)';
          const roles = membershipRoles(entry);
          const roleLabels = roles.length
            ? roles.map((role) => (global.NcdAuth && typeof global.NcdAuth.getRoleLabel === 'function'
              ? global.NcdAuth.getRoleLabel(role)
              : role)).join(' / ')
            : '未設定';
          const status = entry?.status || 'active';
          const statusBadge = status === 'active'
            ? '<span class="text-xs font-semibold text-emerald-600 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded">有効</span>'
            : `<span class="text-xs font-semibold text-slate-600 bg-slate-100 border border-slate-200 px-2 py-0.5 rounded">${escapeHtml(status)}</span>`;

          rendered.push(`
            <div class="rounded border border-slate-200 bg-white px-3 py-3 text-sm shadow-sm">
              <div class="flex items-center justify-between gap-3">
                <span class="font-semibold text-blue-800">${escapeHtml(displayName)}</span>
                ${statusBadge}
              </div>
              <div class="mt-2 text-xs text-slate-600">
                ロール: <span class="font-medium text-slate-800">${escapeHtml(roleLabels)}</span>
              </div>
              <div class="mt-1 text-[11px] text-slate-400">membership: ${escapeHtml(entry?.id || '')}</div>
            </div>
          `);
        }
        membershipsEl.innerHTML = rendered.join('');
      }

      function renderAuth(auth) {
        const profile = auth?.account?.profile || {};
        const displayName = profile.displayName || profile.name || auth?.account?.primaryEmail || auth?.account?.id || '-';
        const email = auth?.account?.primaryEmail || '-';
        const roleKey = (global.NcdAuth && typeof global.NcdAuth.getCurrentRole === 'function')
          ? global.NcdAuth.getCurrentRole(auth)
          : auth?.account?.role || '';
        const roleLabel = (global.NcdAuth && typeof global.NcdAuth.getRoleLabel === 'function')
          ? global.NcdAuth.getRoleLabel(roleKey)
          : (roleKey || '未設定');
        const sourceMemberships = auth?.account?.memberships || auth?.account?.membershipIds;
        const memberships = normalizeMembershipEntries(sourceMemberships, auth);

        if (displayNameEl) displayNameEl.innerHTML = escapeHtml(displayName);
        if (emailEl) emailEl.innerHTML = escapeHtml(email);
        renderMembershipList(membershipDetails.length ? membershipDetails : memberships);

        global.__NcdAccountSnapshot = {
          displayName,
          email,
          role: roleKey,
          roleLabel,
          memberships,
          membershipDetails,
        };
      }

      async function fetchMembershipDetails() {
        if (!global.NcdAuth || typeof global.NcdAuth.authorizedFetch !== 'function') {
          return;
        }
        const apiBase = resolveApiBase();
        try {
          const res = await global.NcdAuth.authorizedFetch(`${apiBase}/api/memberships`);
          if (!res.ok) {
            const errPayload = await res.json().catch(() => null);
            const message = errPayload?.message || `HTTP ${res.status}`;
            throw new Error(message);
          }
          const data = await res.json();
          const items = Array.isArray(data?.memberships) ? data.memberships : [];
          membershipDetails = items;
          await renderMembershipList(membershipDetails);
        } catch (err) {
          console.error('[account] failed to load memberships', err);
          membershipDetails = [];
          if (membershipsEl) {
            membershipsEl.innerHTML = `<span class="text-red-600 text-sm">所属情報を取得できませんでした: ${escapeHtml(err.message || 'Unknown error')}</span>`;
          }
        }
      }

      async function ensureAndRender() {
        if (!global.NcdAuth || typeof global.NcdAuth.ensureAuth !== 'function') {
          return;
        }
        try {
          const auth = await global.NcdAuth.ensureAuth();
          renderAuth(auth);
          await fetchMembershipDetails();
        } catch (err) {
          console.error('[account] failed to resolve auth', err);
        }
      }

      if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          if (!global.NcdAuth || typeof global.NcdAuth.logout !== 'function') {
            return;
          }
          logoutButton.disabled = true;
          if (logoutStatusEl) {
            logoutStatusEl.textContent = 'ログアウト処理中です…';
          }
          global.NcdAuth.logout().then(() => {
            if (logoutStatusEl) {
              logoutStatusEl.textContent = 'ログアウトしました。トップページへ移動します。';
            }
            setTimeout(() => {
              window.location.replace('/index.html');
            }, 400);
          }).catch((err) => {
            console.error('[account] logout failed', err);
            if (logoutStatusEl) {
              logoutStatusEl.textContent = 'ログアウトに失敗しました。時間をおいて再試行してください。';
            }
          }).finally(() => {
            logoutButton.disabled = false;
          });
        });
      }

      document.addEventListener('ncd:auth-changed', (event) => {
        const auth = event?.detail?.auth || null;
        if (auth) {
          renderAuth(auth);
          fetchMembershipDetails();
        } else {
          window.location.replace('/index.html');
        }
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureAndRender, { once: true });
      } else {
        ensureAndRender();
      }
    })(window);
  </script>
</body>
</html>
