<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>診療所一覧</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/header.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- 共通ヘッダー -->
  <header class="bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-5xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between gap-3">
        <div class="hidden md:flex items-center gap-2">
          <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
        </div>
        <h1 class="text-lg md:text-xl font-bold text-center md:text-left md:flex-1">登録済み 診療所一覧</h1>
        <a href="register.html" class="hidden md:inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30 whitespace-nowrap">新規登録へ</a>
        <button type="button" class="inline-flex items-center justify-center rounded bg-white/10 px-3 py-2 text-sm font-semibold transition hover:bg-white/20 md:hidden" data-mobile-menu="#clinic-list-nav" aria-controls="clinic-list-nav" aria-expanded="false" aria-label="メニューを開く">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" />
          </svg>
        </button>
      </div>
      <nav id="clinic-list-nav" data-mobile-menu-target class="mt-3 hidden flex-col gap-2 md:hidden">
        <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-2 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
        <a href="register.html" class="inline-flex items-center rounded bg-white/20 px-3 py-2 text-sm font-semibold text-white transition hover:bg-white/30">新規登録へ</a>
      </nav>
    </div>
  </header>

  <main class="flex-1 w-full">
    <section class="max-w-5xl mx-auto px-4 py-6 space-y-4">
      <div class="bg-white shadow rounded p-6">
        <h2 class="text-blue-800 text-lg font-semibold mb-4">診療所一覧</h2>
        <p class="text-sm text-gray-600 mb-4">選択するとローカルに保存され、施設ホーム画面へ移動します。</p>
        <div class="mb-4">
          <label for="clinicSearch" class="block text-sm font-medium text-gray-700">名称で検索</label>
          <input id="clinicSearch" type="search" placeholder="例: のがた" class="mt-1 w-full rounded border px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-200" autocomplete="off" />
        </div>
        <table class="w-full border border-gray-200 text-sm">
          <thead>
            <tr class="bg-gray-100 text-left text-xs uppercase tracking-wide text-gray-500">
              <th class="p-2 border">#</th>
              <th class="p-2 border">診療所名</th>
              <th class="p-2 border w-32 text-center">操作</th>
            </tr>
          </thead>
          <tbody id="clinicTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

  <script>
  const clinicTableBody = document.getElementById('clinicTable');
  const clinicSearchInput = document.getElementById('clinicSearch');
  let clinicData = [];
  let currentKeyword = '';

  function renderClinics(list, isFiltered) {
    if (!Array.isArray(list) || list.length === 0) {
      const message = isFiltered ? '該当する診療所がありません。' : '登録済みの診療所はありません。';
      clinicTableBody.innerHTML = `<tr><td colspan='3' class='p-3 text-center text-gray-500'>${message}</td></tr>`;
      return;
    }

    clinicTableBody.innerHTML = list
      .map((c, i) => {
        const payload = encodeURIComponent(JSON.stringify(c));
        return `
          <tr class="hover:bg-blue-50">
            <td class="p-2 border align-top">${i + 1}</td>
            <td class="p-2 border">
              <div class="font-semibold text-blue-800">${c.name || "(名称未設定)"}</div>
              <div class="text-xs text-gray-500 mt-1">${c.address || "住所未登録"}</div>
            </td>
            <td class="p-2 border align-top text-center">
              <button class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700"
                      data-clinic="${payload}"
                      onclick="selectClinic(this)">選択</button>
            </td>
          </tr>`;
      })
      .join('');
  }

  function normalize(text) {
    return (text || '').toString().toLowerCase();
  }

  function applyFilter(keyword) {
    currentKeyword = keyword;
    const trimmed = keyword.trim();
    if (!trimmed) {
      renderClinics(clinicData, false);
      return;
    }

    const normalizedKeyword = normalize(trimmed);
    const filtered = clinicData.filter((clinic) => normalize(clinic.name).includes(normalizedKeyword));
    renderClinics(filtered, true);
  }

  const DEFAULT_API_BASE = "https://ncd-app.altry.workers.dev";
  function resolveApiBase() {
    if (typeof window !== 'undefined' && typeof window.API_BASE_OVERRIDE === 'string') {
      const override = window.API_BASE_OVERRIDE.trim();
      if (override) {
        return override.replace(/\/$/, "");
      }
    }
    try {
      const stored = localStorage.getItem('ncdApiBase') || localStorage.getItem('ncdApiBaseUrl');
      if (typeof stored === 'string' && stored.trim()) {
        return stored.trim().replace(/\/$/, "");
      }
    } catch (_) {}
    return DEFAULT_API_BASE;
  }

  const API_BASE = resolveApiBase();
  window.NCD_API_BASE = window.NCD_API_BASE || API_BASE;

  async function loadClinics() {
    clinicTableBody.innerHTML = "<tr><td colspan='3' class='p-3 text-center text-gray-500'>読み込み中...</td></tr>";

    try {
      const res = await fetch(`${API_BASE}/api/listClinics`);
      const data = await res.json();

      if (res.ok && data.ok && Array.isArray(data.clinics) && data.clinics.length > 0) {
        clinicData = data.clinics;
        applyFilter(currentKeyword);
      } else {
        clinicData = [];
        renderClinics([], false);
      }
    } catch (err) {
      clinicTableBody.innerHTML = `<tr><td colspan='3' class='p-3 text-center text-red-600'>エラー: ${err.message}</td></tr>`;
    }
  }

  loadClinics();

  if (clinicSearchInput) {
    clinicSearchInput.addEventListener('input', (event) => {
      applyFilter(event.target.value || '');
    });
  }

  function selectClinic(btn) {
    try {
      const raw = btn.getAttribute('data-clinic');
      const clinic = JSON.parse(decodeURIComponent(raw));
      localStorage.setItem('selectedClinic', JSON.stringify(clinic));
      window.location.href = 'clinicHome.html';
    } catch (e) {
      alert('選択に失敗しました: ' + e.message);
    }
  }

</script>
</body>
</html>
