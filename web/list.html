<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>診療所一覧</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center min-h-screen">
  <!-- 共通ヘッダー -->
  <header class="w-full bg-gradient-to-r from-blue-950 via-slate-900 to-blue-950 text-white shadow">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/index.html" class="inline-flex items-center rounded bg-white/20 px-3 py-1 text-sm font-semibold text-white transition hover:bg-white/30">Top</a>
      <h1 class="text-lg md:text-xl font-bold">登録済み 診療所一覧</h1>
      <div class="w-[100px]"></div>
    </div>
  </header>
  <div class="h-2"></div>

  <div class="bg-white shadow p-6 rounded w-full max-w-2xl">
    <table class="w-full border border-gray-300">
      <thead>
        <tr class="bg-gray-200 text-left">
          <th class="p-2 border">#</th>
          <th class="p-2 border">診療所名</th>
          <th class="p-2 border w-32">操作</th>
        </tr>
      </thead>
      <tbody id="clinicTable"></tbody>
    </table>
  </div>

  <script>
  async function loadClinics() {
    const tbody = document.getElementById("clinicTable");
    tbody.innerHTML = "<tr><td colspan='2' class='p-2'>読み込み中...</td></tr>";

    try {
      const res = await fetch("https://ncd-app.altry.workers.dev/api/listClinics");
      const data = await res.json();

      if (res.ok && data.ok && Array.isArray(data.clinics) && data.clinics.length > 0) {
        tbody.innerHTML = data.clinics
          .map((c, i) => {
            const payload = encodeURIComponent(JSON.stringify(c));
            return `
              <tr class="hover:bg-blue-50">
                <td class="p-2 border align-top">${i + 1}</td>
                <td class="p-2 border">
                  <div class="font-semibold text-blue-800">${c.name || "(名称未設定)"}</div>
                  <div class="text-sm text-gray-500">${c.address || ""}</div>
                </td>
                <td class="p-2 border align-top">
                  <button class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700"
                          data-clinic="${payload}"
                          onclick="selectClinic(this)">選択</button>
                </td>
              </tr>`;
          })
          .join("");
      } else {
        tbody.innerHTML = "<tr><td colspan='2' class='p-2'>登録済みの診療所はありません。</td></tr>";
      }
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan='2' class='p-2 text-red-600'>エラー: ${err.message}</td></tr>`;
    }
  }

  loadClinics();

  function selectClinic(btn) {
    try {
      const raw = btn.getAttribute('data-clinic');
      const clinic = JSON.parse(decodeURIComponent(raw));
      localStorage.setItem('selectedClinic', JSON.stringify(clinic));
      window.location.href = 'clinicHome.html';
    } catch (e) {
      alert('選択に失敗しました: ' + e.message);
    }
  }
</script>
</body>
</html>
