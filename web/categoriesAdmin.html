<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>分類マスター管理 - NCD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/loading.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-4xl mx-auto px-4 py-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-lg sm:text-xl font-bold text-center sm:text-left sm:flex-1">分類マスター管理</h1>
      <a href="admin/admin.html" class="self-start sm:self-auto sm:ml-auto underline whitespace-nowrap">管理トップへ戻る</a>
    </div>
  </header>

  <main class="flex-1 max-w-4xl mx-auto p-6 space-y-6">
    <div class="bg-white rounded shadow p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <label class="font-medium">対象</label>
        <select id="typeSel" class="border rounded px-2 py-1"></select>
      </div>
      <button id="reloadBtn" class="self-start sm:self-auto bg-gray-200 px-3 py-1 rounded whitespace-nowrap">再読み込み</button>
    </div>

    <div id="categoryPanel" class="bg-white rounded shadow p-4 space-y-3">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-2 flex-1">
          <input id="newCat" class="border rounded px-2 py-1 flex-1" placeholder="新しい分類名を追加">
          <button id="addBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 whitespace-nowrap">追加</button>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <button id="importBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 whitespace-nowrap">CSV取込</button>
          <input id="importInput" type="file" accept=".csv,text/csv" class="hidden" />
        </div>
      </div>

      <table class="w-full border text-sm">
        <thead class="bg-gray-100">
          <tr><th class="border px-2 py-1 w-10">#</th><th class="border px-2 py-1">分類名</th><th class="border px-2 py-1 w-64">操作</th></tr>
        </thead>
        <tbody id="catTbody"></tbody>
      </table>
    </div>
    <div id="departmentPanel" class="hidden bg-white rounded shadow p-4 space-y-3">
      <div class="flex flex-col gap-2 md:flex-row md:items-center">
        <div class="flex items-center gap-2 flex-1">
          <label class="text-sm text-gray-600">分類</label>
          <select id="departmentCategorySelect" class="border rounded px-2 py-1 flex-1 min-w-[12rem]"></select>
        </div>
        <div class="flex items-center gap-2 flex-1">
          <label class="text-sm text-gray-600">診療科名称</label>
          <input id="departmentNewName" class="border rounded px-2 py-1 flex-1" placeholder="例: 内科">
          <button id="departmentAddBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 whitespace-nowrap">追加</button>
        </div>
      </div>

      <table class="w-full border text-sm">
        <thead class="bg-gray-100">
          <tr><th class="border px-2 py-1 w-10">#</th><th class="border px-2 py-1 w-48">分類</th><th class="border px-2 py-1">診療科名</th><th class="border px-2 py-1 w-64">操作</th></tr>
        </thead>
        <tbody id="departmentTbody"></tbody>
      </table>
    </div>
  </main>

  <footer class="bg-gray-200 text-gray-700 text-center py-4">
    <p class="text-sm">© 2025 中野区医師会 - Nakano Clinic Database</p>
  </footer>

  <script>
    const DEFAULT_API_BASE = "https://ncd-app.altry.workers.dev";
    function resolveApiBase() {
      if (typeof window !== 'undefined' && typeof window.API_BASE_OVERRIDE === 'string') {
        const override = window.API_BASE_OVERRIDE.trim();
        if (override) {
          return override.replace(/\/$/, '');
        }
      }
      try {
        const stored = localStorage.getItem('ncdApiBase') || localStorage.getItem('ncdApiBaseUrl');
        if (typeof stored === 'string' && stored.trim()) {
          return stored.trim().replace(/\/$/, '');
        }
      } catch (_) {}
      return DEFAULT_API_BASE;
    }

    const API_BASE = resolveApiBase();
    window.NCD_API_BASE = window.NCD_API_BASE || API_BASE;
    const TYPE_OPTIONS = [
      { value: "test", label: "検査分類" },
      { value: "service", label: "診療分類" },
      { value: "qual", label: "個人資格分野" },
      { value: "facility", label: "施設認定の種類" },
      { value: "department", label: "標榜診療科" },
      { value: "vaccinationType", label: "予防接種種類" },
      { value: "checkupType", label: "健診種類" }
    ];
    const DEFAULT_DEPARTMENT_CATEGORY = "標榜診療科";

    const typeSelect = document.getElementById('typeSel');
    const reloadBtn = document.getElementById('reloadBtn');
    const categoryPanel = document.getElementById('categoryPanel');
    const departmentPanel = document.getElementById('departmentPanel');
    const catTbody = document.getElementById('catTbody');
    const newCategoryInput = document.getElementById('newCat');
    const addCategoryButton = document.getElementById('addBtn');
    const importButton = document.getElementById('importBtn');
    const importInput = document.getElementById('importInput');
    const deptCategorySelect = document.getElementById('departmentCategorySelect');
    const deptNewNameInput = document.getElementById('departmentNewName');
    const deptAddButton = document.getElementById('departmentAddBtn');
    const deptTbody = document.getElementById('departmentTbody');
    let importInProgress = false;
    let departmentCategories = [];
    let currentDepartmentItems = [];

    function parseCsvLines(text) {
      if (!text) return [];
      return text
        .split(/\r?\n/)
        .map(line => line.split(',')[0]?.trim())
        .filter(Boolean);
    }

    async function importCategoriesFromCsv(file) {
      if (!file || importInProgress) return;
      const runner = async () => {
        try {
          importInProgress = true;
          const text = await file.text();
          const rows = parseCsvLines(text);
          if (!rows.length) {
            alert('有効な行が見つかりませんでした');
            return;
          }
          const unique = Array.from(new Set(rows));
          const existingRes = await fetchJson(`/api/listCategories?type=${encodeURIComponent(typeSelect.value)}`);
          const existing = new Set((existingRes?.categories || []).map(cat => cat.trim()));
          let added = 0;
          let skipped = 0;
          const failures = [];
          for (const name of unique) {
            if (!name) continue;
            if (existing.has(name)) {
              skipped += 1;
              continue;
            }
            try {
              const res = await fetch(apiUrl('/api/addCategory'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: typeSelect.value, name })
              });
              if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status} ${text}`);
              }
              existing.add(name);
              added += 1;
            } catch (err) {
              console.warn('failed to import category', name, err);
              failures.push({ name, message: err.message || '不明なエラー' });
            }
          }
          await loadCategoryList(true);
          let summary = `CSV取込が完了しました。\n追加: ${added} 件`;
          summary += skipped ? ` / 既存のためスキップ: ${skipped} 件` : '';
          summary += failures.length ? ` / 失敗: ${failures.length} 件` : '';
          if (failures.length) {
            const details = failures.slice(0, 5).map(f => `・${f.name}: ${f.message}`).join('\n');
            summary += `\n\n失敗した行(一部):\n${details}`;
            if (failures.length > 5) {
              summary += `\n…ほか ${failures.length - 5} 件`;
            }
          }
          alert(summary);
        } catch (err) {
          console.error(err);
          alert('CSV取込中にエラーが発生しました');
        } finally {
          importInProgress = false;
        }
      };
      if (typeof wrapWithLoading === 'function') {
        await wrapWithLoading(runner, 'CSVを取り込み中です...', categoryPanel);
      } else {
        await runner();
      }
    }

    function populateTypeOptions(initial) {
      typeSelect.innerHTML = TYPE_OPTIONS.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      if (TYPE_OPTIONS.some(opt => opt.value === initial)) {
        typeSelect.value = initial;
      }
    }

    function togglePanels(showDepartment) {
      departmentPanel.classList.toggle('hidden', !showDepartment);
    }

    function apiUrl(path) {
      if (!path) return API_BASE;
      if (/^https?:\/\//i.test(path)) return path;
      const normalized = path.startsWith('/') ? path : `/${path}`;
      return `${API_BASE}${normalized}`;
    }

    async function fetchJson(path, options) {
      const res = await fetch(apiUrl(path), options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status} ${text}`);
      }
      return res.json();
    }

    function updateDepartmentCategorySelect() {
      if (!deptCategorySelect) return;
      if (!departmentCategories.length) {
        deptCategorySelect.innerHTML = '<option value="">分類を追加してください</option>';
        deptCategorySelect.disabled = true;
      } else {
        const options = departmentCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        const current = deptCategorySelect.value && departmentCategories.includes(deptCategorySelect.value)
          ? deptCategorySelect.value
          : departmentCategories[0];
        deptCategorySelect.innerHTML = options;
        deptCategorySelect.value = current;
        deptCategorySelect.disabled = false;
      }
    }

    async function loadCategoryList(withOverlay = false) {
      const executor = async () => {
        const type = encodeURIComponent(typeSelect.value);
        const data = await fetchJson(`/api/listCategories?type=${type}`);
        const categories = Array.isArray(data.categories) ? data.categories : [];
        catTbody.innerHTML = '';
        categories.forEach((name, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border px-2 py-1 text-center">${index + 1}</td>
            <td class="border px-2 py-1"><input value="${name}" class="border rounded px-2 py-1 w-full" data-old="${name}"></td>
            <td class="border px-2 py-1">
              <button class="bg-blue-600 text-white px-2 py-1 rounded mr-2 renameBtn">改名</button>
              <button class="bg-red-600 text-white px-2 py-1 rounded delBtn">削除</button>
            </td>`;
          catTbody.appendChild(tr);
        });

        if (typeSelect.value === 'department') {
          departmentCategories = categories.length ? categories : [DEFAULT_DEPARTMENT_CATEGORY];
          updateDepartmentCategorySelect();
          renderDepartmentTable(currentDepartmentItems);
        }

        catTbody.querySelectorAll('.renameBtn').forEach(btn => {
          btn.addEventListener('click', async (event) => {
            const row = event.currentTarget.closest('tr');
            const input = row.querySelector('input');
            const oldName = input.getAttribute('data-old');
            const newName = input.value.trim();
            if (!newName) {
              alert('分類名を入力してください');
              return;
            }
            try {
              await fetchJson('/api/renameCategory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: typeSelect.value, oldName, newName })
              });
              await loadCategoryList(true);
            } catch (err) {
              console.error('rename failed', err);
              alert('改名に失敗しました');
            }
          });
        });

        catTbody.querySelectorAll('.delBtn').forEach(btn => {
          btn.addEventListener('click', async (event) => {
            const row = event.currentTarget.closest('tr');
            const name = row.querySelector('input').value.trim();
            if (!confirm(`「${name}」を削除しますか？`)) return;
            try {
              await fetchJson('/api/deleteCategory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: typeSelect.value, name })
              });
              await loadCategoryList(true);
            } catch (err) {
              console.error('delete failed', err);
              alert('削除に失敗しました');
            }
          });
        });
      };

      if (withOverlay && typeof wrapWithLoading === 'function') {
        await wrapWithLoading(executor, '分類を読み込み中...', categoryPanel);
      } else {
        await executor().catch(err => console.error(err));
      }
    }

    function renderDepartmentTable(items) {
      deptTbody.innerHTML = '';
      if (!items.length) {
        deptTbody.innerHTML = '<tr><td colspan="4" class="border px-2 py-3 text-center text-sm text-gray-500">登録済みの診療科がありません</td></tr>';
        return;
      }

      const sorted = [...items].sort((a, b) => {
        const catComparison = (a.category || '').localeCompare(b.category || '', 'ja');
        if (catComparison !== 0) return catComparison;
        return (a.name || '').localeCompare(b.name || '', 'ja');
      });

      sorted.forEach((item, index) => {
        const category = item.category || departmentCategories[0] || DEFAULT_DEPARTMENT_CATEGORY;
        const categoryControl = departmentCategories.length
          ? `<select class="border rounded px-2 py-1 w-full" data-field="category">
              ${departmentCategories.map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('')}
             </select>`
          : `<input class="border rounded px-2 py-1 w-full" data-field="category" value="${category}">`;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border px-2 py-1 text-center">${index + 1}</td>
          <td class="border px-2 py-1">${categoryControl}</td>
          <td class="border px-2 py-1"><input value="${item.name || ''}" class="border rounded px-2 py-1 w-full" data-old-name="${item.name || ''}"></td>
          <td class="border px-2 py-1">
            <button class="bg-blue-600 text-white px-2 py-1 rounded mr-2 renameDept">改名</button>
            <button class="bg-red-600 text-white px-2 py-1 rounded delDept">削除</button>
          </td>`;
        deptTbody.appendChild(row);
      });

      deptTbody.querySelectorAll('.renameDept').forEach(btn => {
        btn.addEventListener('click', async (event) => {
          const row = event.currentTarget.closest('tr');
          const nameInput = row.querySelector('input');
          const categoryField = row.querySelector('[data-field="category"]');
          const oldName = nameInput.getAttribute('data-old-name');
          const newName = nameInput.value.trim();
          const newCategory = categoryField.tagName === 'SELECT'
            ? categoryField.value
            : (categoryField.value.trim() || departmentCategories[0] || DEFAULT_DEPARTMENT_CATEGORY);
          if (!newName) {
            alert('診療科名を入力してください');
            return;
          }
          try {
            await fetchJson(`${BASE}/api/updateMasterItem`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'department', category: newCategory, name: oldName, newCategory, newName })
            });
            await loadDepartmentList(true);
          } catch (err) {
            console.error('rename department failed', err);
            alert('診療科名の更新に失敗しました');
          }
        });
      });

      deptTbody.querySelectorAll('.delDept').forEach(btn => {
        btn.addEventListener('click', async (event) => {
          const row = event.currentTarget.closest('tr');
          const nameInput = row.querySelector('input');
          const categoryField = row.querySelector('[data-field="category"]');
          const name = nameInput.getAttribute('data-old-name');
          const category = categoryField.tagName === 'SELECT'
            ? categoryField.value
            : (categoryField.value.trim() || departmentCategories[0] || DEFAULT_DEPARTMENT_CATEGORY);
          if (!confirm(`「${name}」を削除しますか？`)) return;
          try {
            await fetchJson(`${BASE}/api/deleteMasterItem`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'department', category, name })
            });
            await loadDepartmentList(true);
          } catch (err) {
            console.error('delete department failed', err);
            alert('診療科の削除に失敗しました');
          }
        });
      });
    }

    async function loadDepartmentList(withOverlay = false) {
      const executor = async () => {
        const data = await fetchJson('/api/listMaster?type=department');
        currentDepartmentItems = Array.isArray(data.items) ? data.items : [];
        renderDepartmentTable(currentDepartmentItems);
      };

      if (withOverlay && typeof wrapWithLoading === 'function') {
        await wrapWithLoading(executor, '標榜診療科を読み込み中...', departmentPanel);
      } else {
        await executor().catch(err => console.error(err));
      }
    }

    async function loadCurrent(withOverlay = false) {
      const isDepartment = typeSelect.value === 'department';
      togglePanels(isDepartment);
      await loadCategoryList(withOverlay);
      if (isDepartment) {
        await loadDepartmentList(withOverlay);
      }
    }

    reloadBtn.addEventListener('click', () => loadCurrent(true));
    typeSelect.addEventListener('change', () => loadCurrent(true));

    addCategoryButton.addEventListener('click', async () => {
      const name = newCategoryInput.value.trim();
      if (!name) {
        alert('分類名を入力してください');
        return;
      }
      const executor = async () => {
        await fetchJson('/api/addCategory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: typeSelect.value, name })
        });
      };
      if (typeof wrapWithLoading === 'function') {
        await wrapWithLoading(executor, '分類を追加しています...', categoryPanel);
      } else {
        await executor().catch(() => alert('追加に失敗しました'));
      }
      newCategoryInput.value = '';
      await loadCategoryList(true);
    });

    importButton?.addEventListener('click', () => {
      if (importInProgress) return;
      importInput?.click();
    });

    importInput?.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (file) {
        importCategoriesFromCsv(file);
      }
      event.target.value = '';
    });

    deptAddButton.addEventListener('click', async () => {
      const name = deptNewNameInput.value.trim();
      if (!name) {
        alert('診療科名を入力してください');
        return;
      }
      if (!departmentCategories.length) {
        alert('先に分類を追加してください');
        return;
      }
      const classification = deptCategorySelect.value || departmentCategories[0];
      const executor = async () => {
        await fetchJson('/api/addMasterItem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'department', category: classification, name })
        });
      };
      if (typeof wrapWithLoading === 'function') {
        await wrapWithLoading(executor, '診療科を追加しています...', departmentPanel);
      } else {
        await executor().catch(() => alert('追加に失敗しました'));
      }
      deptNewNameInput.value = '';
      await loadDepartmentList(true);
    });

    const params = new URLSearchParams(location.search);
    const requestedType = params.get('type');
    const validTypes = TYPE_OPTIONS.map(opt => opt.value);
    const initialType = validTypes.includes(requestedType) ? requestedType : validTypes[0];

    window.addEventListener('DOMContentLoaded', () => {
      populateTypeOptions(initialType);
      loadCurrent(true);
    });
  </script>
</body>
</html>
